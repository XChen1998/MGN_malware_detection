<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gencode.c Source File</title>
<link href="style.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>gencode.c</h1><a href="gencode_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*#define CHASE_CHAIN*/</span>
00002 <span class="comment">/*</span>
00003 <span class="comment"> * Copyright (c) 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998</span>
00004 <span class="comment"> *  The Regents of the University of California.  All rights reserved.</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
00007 <span class="comment"> * modification, are permitted provided that: (1) source code distributions</span>
00008 <span class="comment"> * retain the above copyright notice and this paragraph in its entirety, (2)</span>
00009 <span class="comment"> * distributions including binary code include the above copyright notice and</span>
00010 <span class="comment"> * this paragraph in its entirety in the documentation or other materials</span>
00011 <span class="comment"> * provided with the distribution, and (3) all advertising materials mentioning</span>
00012 <span class="comment"> * features or use of this software display the following acknowledgement:</span>
00013 <span class="comment"> * ``This product includes software developed by the University of California,</span>
00014 <span class="comment"> * Lawrence Berkeley Laboratory and its contributors.'' Neither the name of</span>
00015 <span class="comment"> * the University nor the names of its contributors may be used to endorse</span>
00016 <span class="comment"> * or promote products derived from this software without specific prior</span>
00017 <span class="comment"> * written permission.</span>
00018 <span class="comment"> * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR IMPLIED</span>
00019 <span class="comment"> * WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF</span>
00020 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00021 <span class="comment"> */</span>
00022 <span class="preprocessor">#ifndef lint</span>
<a name="l00023"></a><a class="code" href="gencode_8c.html#a13">00023</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="gencode_8c.html#a13">rcsid</a>[] =
00024     <span class="stringliteral">"@(#) $Header: /tcpdump/master/libpcap/gencode.c,v 1.184 2003/01/23 07:24:51 guy Exp $ (LBL)"</span>;
00025 <span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span>
00027 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor">#ifdef WIN32</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include &lt;pcap-stdinc.h&gt;</span>
00033 <span class="preprocessor">#else </span><span class="comment">/* WIN32 */</span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00037 <span class="preprocessor">#endif </span><span class="comment">/* WIN32 */</span>
00038 
00039 <span class="comment">/*</span>
00040 <span class="comment"> * XXX - why was this included even on UNIX?</span>
00041 <span class="comment"> */</span>
00042 <span class="preprocessor">#ifdef __MINGW32__</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#include "IP6_misc.h"</span>
00044 <span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
00046 <span class="preprocessor">#ifndef WIN32</span>
00047 <span class="preprocessor"></span>
00048 <span class="preprocessor">#ifdef __NetBSD__</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00050 <span class="preprocessor">#endif</span>
00051 <span class="preprocessor"></span>
00052 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00053 
00054 <span class="preprocessor">#endif </span><span class="comment">/* WIN32 */</span>
00055 
00056 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00057 <span class="preprocessor">#include &lt;string.h&gt;</span>
00058 <span class="preprocessor">#include &lt;memory.h&gt;</span>
00059 <span class="preprocessor">#include &lt;setjmp.h&gt;</span>
00060 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
00061 
00062 <span class="preprocessor">#include "pcap-int.h"</span>
00063 
00064 <span class="preprocessor">#include "ethertype.h"</span>
00065 <span class="preprocessor">#include "nlpid.h"</span>
00066 <span class="preprocessor">#include "llc.h"</span>
00067 <span class="preprocessor">#include "gencode.h"</span>
00068 <span class="preprocessor">#include "atmuni31.h"</span>
00069 <span class="preprocessor">#include "sunatmpos.h"</span>
00070 <span class="preprocessor">#include "ppp.h"</span>
00071 <span class="preprocessor">#include "sll.h"</span>
00072 <span class="preprocessor">#include "arcnet.h"</span>
00073 <span class="preprocessor">#ifdef INET6</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#ifndef WIN32</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#include &lt;netdb.h&gt;</span>  <span class="comment">/* for "struct addrinfo" */</span>
00076 <span class="preprocessor">#endif </span><span class="comment">/* WIN32 */</span>
00077 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
00078 <span class="preprocessor">#include &lt;pcap-namedb.h&gt;</span>
00079 
<a name="l00080"></a><a class="code" href="gencode_8c.html#a0">00080</a> <span class="preprocessor">#define ETHERMTU    1500</span>
00081 <span class="preprocessor"></span>
00082 <span class="preprocessor">#ifndef IPPROTO_SCTP</span>
<a name="l00083"></a><a class="code" href="gencode_8c.html#a1">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_SCTP 132</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00085 <span class="preprocessor"></span>
00086 <span class="preprocessor">#ifdef HAVE_OS_PROTO_H</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#include "os-proto.h"</span>
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
<a name="l00090"></a><a class="code" href="gencode_8c.html#a2">00090</a> <span class="preprocessor">#define JMP(c) ((c)|BPF_JMP|BPF_K)</span>
00091 <span class="preprocessor"></span>
00092 <span class="comment">/* Locals */</span>
<a name="l00093"></a><a class="code" href="gencode_8c.html#a14">00093</a> <span class="keyword">static</span> jmp_buf <a class="code" href="gencode_8c.html#a14">top_ctx</a>;
<a name="l00094"></a><a class="code" href="gencode_8c.html#a15">00094</a> <span class="keyword">static</span> <a class="code" href="group__wpcap__def.html#a2">pcap_t</a> *<a class="code" href="gencode_8c.html#a15">bpf_pcap</a>;
00095 
00096 <span class="comment">/* Hack for updating VLAN offsets. */</span>
<a name="l00097"></a><a class="code" href="gencode_8c.html#a18">00097</a> <span class="keyword">static</span> u_int    <a class="code" href="gencode_8c.html#a16">orig_linktype</a> = -1, <a class="code" href="gencode_8c.html#a17">orig_nl</a> = -1, <a class="code" href="gencode_8c.html#a18">orig_nl_nosnap</a> = -1;
00098 
00099 <span class="comment">/* XXX */</span>
00100 <span class="preprocessor">#ifdef PCAP_FDDIPAD</span>
00101 <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a19">pcap_fddipad</a> = PCAP_FDDIPAD;
00102 <span class="preprocessor">#else</span>
<a name="l00103"></a><a class="code" href="gencode_8c.html#a19">00103</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a19">pcap_fddipad</a>;
00104 <span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106 <span class="comment">/* VARARGS */</span>
00107 <span class="keywordtype">void</span>
<a name="l00108"></a><a class="code" href="gencode_8c.html#a64">00108</a> <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
00109 
00110 {
00111     va_list ap;
00112 
00113     va_start(ap, fmt);
00114     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a15">bpf_pcap</a> != NULL)
00115         (void)vsnprintf(<a class="code" href="pcap_8c.html#a24">pcap_geterr</a>(bpf_pcap), PCAP_ERRBUF_SIZE,
00116             fmt, ap);
00117     va_end(ap);
00118     longjmp(top_ctx, 1);
00119     <span class="comment">/* NOTREACHED */</span>
00120 }
00121 
00122 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gencode_8c.html#a115">init_linktype</a>(<span class="keywordtype">int</span>);
00123 
00124 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a66">alloc_reg</a>(<span class="keywordtype">void</span>);
00125 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gencode_8c.html#a116">free_reg</a>(<span class="keywordtype">int</span>);
00126 
<a name="l00127"></a><a class="code" href="gencode_8c.html#a20">00127</a> <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a20">root</a>;
00128 
00129 <span class="comment">/*</span>
00130 <span class="comment"> * We divy out chunks of memory rather than call malloc each time so</span>
00131 <span class="comment"> * we don't have to worry about leaking memory.  It's probably</span>
00132 <span class="comment"> * not a big deal if all this memory was wasted but it this ever</span>
00133 <span class="comment"> * goes into a library that would probably not be a good idea.</span>
00134 <span class="comment"> */</span>
<a name="l00135"></a><a class="code" href="gencode_8c.html#a3">00135</a> <span class="preprocessor">#define NCHUNKS 16</span>
<a name="l00136"></a><a class="code" href="gencode_8c.html#a4">00136</a> <span class="preprocessor"></span><span class="preprocessor">#define CHUNK0SIZE 1024</span>
<a name="l00137"></a><a class="code" href="structchunk.html">00137</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structchunk.html">chunk</a> {
<a name="l00138"></a><a class="code" href="structchunk.html#m0">00138</a>     u_int <a class="code" href="structchunk.html#m0">n_left</a>;
<a name="l00139"></a><a class="code" href="structchunk.html#m1">00139</a>     <span class="keywordtype">void</span> *<a class="code" href="structchunk.html#m1">m</a>;
00140 };
00141 
<a name="l00142"></a><a class="code" href="gencode_8c.html#a21">00142</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structchunk.html">chunk</a> <a class="code" href="gencode_8c.html#a21">chunks</a>[<a class="code" href="gencode_8c.html#a3">NCHUNKS</a>];
<a name="l00143"></a><a class="code" href="gencode_8c.html#a22">00143</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a22">cur_chunk</a>;
00144 
00145 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="gencode_8c.html#a110">newchunk</a>(u_int);
00146 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gencode_8c.html#a69">freechunks</a>(<span class="keywordtype">void</span>);
00147 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a70">new_block</a>(int);
00148 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>slist *<a class="code" href="gencode_8c.html#a71">new_stmt</a>(int);
00149 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a72">gen_retblk</a>(int);
00150 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="gencode_8c.html#a73">syntax</a>(<span class="keywordtype">void</span>);
00151 
00152 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gencode_8c.html#a114">backpatch</a>(<span class="keyword">struct</span> block *, <span class="keyword">struct</span> block *);
00153 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="gencode_8c.html#a75">merge</a>(<span class="keyword">struct</span> block *, <span class="keyword">struct</span> block *);
00154 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a76">gen_cmp</a>(u_int, u_int, <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a>);
00155 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(u_int, u_int, <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a>);
00156 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(u_int, u_int, <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>);
00157 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(u_int, u_int, const u_char *);
00158 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(<a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>,
00159     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, int);
00160 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a81">gen_uncond</a>(int);
00161 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a82">gen_true</a>(void);
00162 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a83">gen_false</a>(void);
00163 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a84">gen_ether_linktype</a>(int);
00164 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a85">gen_linktype</a>(int);
00165 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a86">gen_snap</a>(<a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, u_int);
00166 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a87">gen_llc</a>(int);
00167 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a88">gen_hostop</a>(<a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, int, int, u_int, u_int);
00168 <span class="preprocessor">#ifdef INET6</span>
00169 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *gen_hostop6(struct in6_addr *, struct in6_addr *, int, int, u_int, u_int);
00170 <span class="preprocessor">#endif</span>
00171 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(const u_char *, int);
00172 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(const u_char *, int);
00173 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(const u_char *, int);
00174 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a92">gen_thostop</a>(const u_char *, int);
00175 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(const u_char *, int);
00176 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(const u_char *, int);
00177 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(<a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, int, u_int);
00178 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a96">gen_host</a>(<a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a>, int, int);
00179 <span class="preprocessor">#ifdef INET6</span>
00180 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *gen_host6(struct in6_addr *, struct in6_addr *, int, int);
00181 <span class="preprocessor">#endif</span>
00182 <span class="preprocessor"></span><span class="preprocessor">#ifndef INET6</span>
00183 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a97">gen_gateway</a>(const u_char *, <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> **, int, int);
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a98">gen_ipfrag</a>(void);
00186 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a99">gen_portatom</a>(int, <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a>);
00187 <span class="preprocessor">#ifdef INET6</span>
00188 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *gen_portatom6(int, <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a>);
00189 <span class="preprocessor">#endif</span>
00190 <span class="preprocessor"></span><span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a100">gen_portop</a>(int, int, int);
00191 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a101">gen_port</a>(int, int, int);
00192 <span class="preprocessor">#ifdef INET6</span>
00193 <span class="preprocessor"></span><span class="keyword">struct </span>block *gen_portop6(int, int, int);
00194 <span class="keyword">static</span> <span class="keyword">struct </span>block *gen_port6(int, int, int);
00195 <span class="preprocessor">#endif</span>
00196 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a102">lookup_proto</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
00197 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a103">gen_protochain</a>(int, int, int);
00198 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a104">gen_proto</a>(int, int, int);
00199 <span class="keyword">static</span> <span class="keyword">struct </span>slist *<a class="code" href="gencode_8c.html#a105">xfer_to_x</a>(struct arth *);
00200 <span class="keyword">static</span> <span class="keyword">struct </span>slist *<a class="code" href="gencode_8c.html#a106">xfer_to_a</a>(struct arth *);
00201 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(int);
00202 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a108">gen_len</a>(int, int);
00203 
00204 <span class="keyword">static</span> <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(int type);
00205 
00206 <span class="keyword">static</span> <span class="keywordtype">void</span> *
00207 <a class="code" href="gencode_8c.html#a110">newchunk</a>(n)
00208     u_int <a class="code" href="bpf__image_8c.html#a1">n</a>;
00209 {
00210     <span class="keyword">struct </span><a class="code" href="structchunk.html">chunk</a> *cp;
00211     <span class="keywordtype">int</span> k, <a class="code" href="gencode_8c.html#a27">size</a>;
00212 
00213 <span class="preprocessor">#ifndef __NetBSD__</span>
00214 <span class="preprocessor"></span>    <span class="comment">/* XXX Round up to nearest long. */</span>
00215     <a class="code" href="bpf__image_8c.html#a1">n</a> = (<a class="code" href="bpf__image_8c.html#a1">n</a> + <span class="keyword">sizeof</span>(long) - 1) &amp; ~(<span class="keyword">sizeof</span>(long) - 1);
00216 <span class="preprocessor">#else</span>
00217 <span class="preprocessor"></span>    <span class="comment">/* XXX Round up to structure boundary. */</span>
00218     <a class="code" href="bpf__image_8c.html#a1">n</a> = ALIGN(n);
00219 <span class="preprocessor">#endif</span>
00220 <span class="preprocessor"></span>
00221     cp = &amp;<a class="code" href="gencode_8c.html#a21">chunks</a>[<a class="code" href="gencode_8c.html#a22">cur_chunk</a>];
00222     <span class="keywordflow">if</span> (<a class="code" href="bpf__image_8c.html#a1">n</a> &gt; cp-&gt;<a class="code" href="structchunk.html#m0">n_left</a>) {
00223         ++cp, k = ++<a class="code" href="gencode_8c.html#a22">cur_chunk</a>;
00224         <span class="keywordflow">if</span> (k &gt;= <a class="code" href="gencode_8c.html#a3">NCHUNKS</a>)
00225             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"out of memory"</span>);
00226         <a class="code" href="gencode_8c.html#a27">size</a> = <a class="code" href="gencode_8c.html#a4">CHUNK0SIZE</a> &lt;&lt; k;
00227         cp-&gt;<a class="code" href="structchunk.html#m1">m</a> = (<span class="keywordtype">void</span> *)malloc(size);
00228         memset((<span class="keywordtype">char</span> *)cp-&gt;<a class="code" href="structchunk.html#m1">m</a>, 0, size);
00229         cp-&gt;<a class="code" href="structchunk.html#m0">n_left</a> = <a class="code" href="gencode_8c.html#a27">size</a>;
00230         <span class="keywordflow">if</span> (<a class="code" href="bpf__image_8c.html#a1">n</a> &gt; <a class="code" href="gencode_8c.html#a27">size</a>)
00231             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"out of memory"</span>);
00232     }
00233     cp-&gt;<a class="code" href="structchunk.html#m0">n_left</a> -= <a class="code" href="bpf__image_8c.html#a1">n</a>;
00234     <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)((<span class="keywordtype">char</span> *)cp-&gt;<a class="code" href="structchunk.html#m1">m</a> + cp-&gt;<a class="code" href="structchunk.html#m0">n_left</a>);
00235 }
00236 
00237 <span class="keyword">static</span> <span class="keywordtype">void</span>
00238 <a class="code" href="gencode_8c.html#a69">freechunks</a>()
00239 {
00240     <span class="keywordtype">int</span> i;
00241 
00242     <a class="code" href="gencode_8c.html#a22">cur_chunk</a> = 0;
00243     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="gencode_8c.html#a3">NCHUNKS</a>; ++i)
00244         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a21">chunks</a>[i].<a class="code" href="structchunk.html#m1">m</a> != NULL) {
00245             free(chunks[i].m);
00246             <a class="code" href="gencode_8c.html#a21">chunks</a>[i].<a class="code" href="structchunk.html#m1">m</a> = NULL;
00247         }
00248 }
00249 
00250 <span class="comment">/*</span>
00251 <span class="comment"> * A strdup whose allocations are freed after code generation is over.</span>
00252 <span class="comment"> */</span>
00253 <span class="keywordtype">char</span> *
00254 sdup(s)
00255     <span class="keyword">register</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
00256 {
00257     <span class="keywordtype">int</span> <a class="code" href="bpf__image_8c.html#a1">n</a> = strlen(s) + 1;
00258     <span class="keywordtype">char</span> *cp = <a class="code" href="gencode_8c.html#a110">newchunk</a>(n);
00259 
00260     strlcpy(cp, s, n);
00261     <span class="keywordflow">return</span> (cp);
00262 }
00263 
00264 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>block *
00265 <a class="code" href="gencode_8c.html#a70">new_block</a>(code)
00266     int code;
00267 {
00268     <span class="keyword">struct </span>block *p;
00269 
00270     p = (<span class="keyword">struct </span>block *)<a class="code" href="gencode_8c.html#a68">newchunk</a>(sizeof(*p));
00271     p-&gt;s.code = code;
00272     p-&gt;head = p;
00273 
00274     <span class="keywordflow">return</span> p;
00275 }
00276 
00277 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>slist *
00278 <a class="code" href="gencode_8c.html#a71">new_stmt</a>(code)
00279     int code;
00280 {
00281     <span class="keyword">struct </span>slist *p;
00282 
00283     p = (<span class="keyword">struct </span>slist *)<a class="code" href="gencode_8c.html#a68">newchunk</a>(sizeof(*p));
00284     p-&gt;s.code = code;
00285 
00286     <span class="keywordflow">return</span> p;
00287 }
00288 
00289 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00290 <a class="code" href="gencode_8c.html#a72">gen_retblk</a>(<a class="code" href="gencode_8c.html#a28">v</a>)
00291     int <a class="code" href="gencode_8c.html#a28">v</a>;
00292 {
00293     <span class="keyword">struct </span>block *b = <a class="code" href="gencode_8c.html#a70">new_block</a>(BPF_RET|BPF_K);
00294 
00295     b-&gt;s.k = <a class="code" href="gencode_8c.html#a28">v</a>;
00296     <span class="keywordflow">return</span> b;
00297 }
00298 
00299 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
00300 <a class="code" href="gencode_8c.html#a73">syntax</a>()
00301 {
00302     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"syntax error in filter expression"</span>);
00303 }
00304 
00305 <span class="keyword">static</span> <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> netmask;
<a name="l00306"></a><a class="code" href="gencode_8c.html#a23">00306</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a23">snaplen</a>;
<a name="l00307"></a><a class="code" href="gencode_8c.html#a24">00307</a> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a24">no_optimize</a>;
00308 
00309 <span class="keywordtype">int</span>
<a name="l00310"></a><a class="code" href="gencode_8c.html#a111">00310</a> <a class="code" href="gencode_8c.html#a111">pcap_compile</a>(pcap_t *p, <span class="keyword">struct</span> <a class="code" href="structbpf__program.html">bpf_program</a> *program,
00311          <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> optimize, bpf_u_int32 mask)
00312 {
00313     <span class="keyword">extern</span> <span class="keywordtype">int</span> n_errors;
00314     <span class="keywordtype">int</span> len;
00315 
00316     <a class="code" href="gencode_8c.html#a24">no_optimize</a> = 0;
00317     n_errors = 0;
00318     <a class="code" href="gencode_8c.html#a20">root</a> = NULL;
00319     <a class="code" href="gencode_8c.html#a15">bpf_pcap</a> = p;
00320     <span class="keywordflow">if</span> (setjmp(top_ctx)) {
00321         lex_cleanup();
00322         <a class="code" href="gencode_8c.html#a69">freechunks</a>();
00323         <span class="keywordflow">return</span> (-1);
00324     }
00325 
00326     netmask = <a class="code" href="gencode_8c.html#a29">mask</a>;
00327 
00328     <a class="code" href="gencode_8c.html#a23">snaplen</a> = <a class="code" href="pcap_8c.html#a17">pcap_snapshot</a>(p);
00329     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a23">snaplen</a> == 0) {
00330         <a class="code" href="sockutils_8c.html#a3">snprintf</a>(p-&gt;errbuf, PCAP_ERRBUF_SIZE,
00331              <span class="stringliteral">"snaplen of 0 rejects all packets"</span>);
00332         <span class="keywordflow">return</span> -1;
00333     }
00334 
00335     lex_init(buf ? buf : <span class="stringliteral">""</span>);
00336     <a class="code" href="gencode_8c.html#a115">init_linktype</a>(<a class="code" href="pcap_8c.html#a11">pcap_datalink</a>(p));
00337     (void)pcap_parse();
00338 
00339     <span class="keywordflow">if</span> (n_errors)
00340         <a class="code" href="gencode_8c.html#a73">syntax</a>();
00341 
00342     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a20">root</a> == NULL)
00343         <a class="code" href="gencode_8c.html#a20">root</a> = <a class="code" href="gencode_8c.html#a72">gen_retblk</a>(snaplen);
00344 
00345     <span class="keywordflow">if</span> (optimize &amp;&amp; !<a class="code" href="gencode_8c.html#a24">no_optimize</a>) {
00346         bpf_optimize(&amp;root);
00347         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a20">root</a> == NULL ||
00348             (<a class="code" href="gencode_8c.html#a20">root</a>-&gt;s.code == (BPF_RET|BPF_K) &amp;&amp; <a class="code" href="gencode_8c.html#a20">root</a>-&gt;s.k == 0))
00349             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"expression rejects all packets"</span>);
00350     }
00351     program-&gt;<a class="code" href="structbpf__program.html#m1">bf_insns</a> = icode_to_fcode(root, &amp;len);
00352     program-&gt;<a class="code" href="structbpf__program.html#m0">bf_len</a> = len;
00353 
00354     lex_cleanup();
00355     <a class="code" href="gencode_8c.html#a69">freechunks</a>();
00356     <span class="keywordflow">return</span> (0);
00357 }
00358 
00359 <span class="comment">/*</span>
00360 <span class="comment"> * entry point for using the compiler with no pcap open</span>
00361 <span class="comment"> * pass in all the stuff that is needed explicitly instead.</span>
00362 <span class="comment"> */</span>
00363 <span class="keywordtype">int</span>
<a name="l00364"></a><a class="code" href="gencode_8c.html#a112">00364</a> <a class="code" href="gencode_8c.html#a112">pcap_compile_nopcap</a>(<span class="keywordtype">int</span> snaplen_arg, <span class="keywordtype">int</span> linktype_arg,
00365             <span class="keyword">struct</span> <a class="code" href="structbpf__program.html">bpf_program</a> *program,
00366          <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> optimize, bpf_u_int32 mask)
00367 {
00368     <a class="code" href="group__wpcap__def.html#a2">pcap_t</a> *p;
00369     <span class="keywordtype">int</span> ret;
00370 
00371     p = <a class="code" href="pcap_8c.html#a29">pcap_open_dead</a>(linktype_arg, snaplen_arg);
00372     <span class="keywordflow">if</span> (p == NULL)
00373         <span class="keywordflow">return</span> (-1);
00374     ret = <a class="code" href="gencode_8c.html#a111">pcap_compile</a>(p, program, buf, optimize, mask);
00375     <a class="code" href="pcap_8c.html#a30">pcap_close</a>(p);
00376     <span class="keywordflow">return</span> (ret);
00377 }
00378 
00379 <span class="comment">/*</span>
00380 <span class="comment"> * Clean up a "struct bpf_program" by freeing all the memory allocated</span>
00381 <span class="comment"> * in it.</span>
00382 <span class="comment"> */</span>
00383 <span class="keywordtype">void</span>
<a name="l00384"></a><a class="code" href="gencode_8c.html#a113">00384</a> <a class="code" href="gencode_8c.html#a113">pcap_freecode</a>(<span class="keyword">struct</span> <a class="code" href="structbpf__program.html">bpf_program</a> *program)
00385 {
00386     program-&gt;<a class="code" href="structbpf__program.html#m0">bf_len</a> = 0;
00387     <span class="keywordflow">if</span> (program-&gt;<a class="code" href="structbpf__program.html#m1">bf_insns</a> != NULL) {
00388         free((<span class="keywordtype">char</span> *)program-&gt;<a class="code" href="structbpf__program.html#m1">bf_insns</a>);
00389         program-&gt;<a class="code" href="structbpf__program.html#m1">bf_insns</a> = NULL;
00390     }
00391 }
00392 
00393 <span class="comment">/*</span>
00394 <span class="comment"> * Backpatch the blocks in 'list' to 'target'.  The 'sense' field indicates</span>
00395 <span class="comment"> * which of the jt and jf fields has been resolved and which is a pointer</span>
00396 <span class="comment"> * back to another unresolved block (or nil).  At least one of the fields</span>
00397 <span class="comment"> * in each block is already resolved.</span>
00398 <span class="comment"> */</span>
00399 <span class="keyword">static</span> <span class="keywordtype">void</span>
00400 <a class="code" href="gencode_8c.html#a114">backpatch</a>(list, target)
<a name="l00401"></a><a class="code" href="gencode_8c.html#a25">00401</a>     <span class="keyword">struct </span>block *list, *<a class="code" href="gencode_8c.html#a25">target</a>;
00402 {
00403     <span class="keyword">struct </span>block *next;
00404 
00405     <span class="keywordflow">while</span> (list) {
00406         <span class="keywordflow">if</span> (!list-&gt;sense) {
00407             next = JT(list);
00408             JT(list) = <a class="code" href="gencode_8c.html#a25">target</a>;
00409         } <span class="keywordflow">else</span> {
00410             next = JF(list);
00411             JF(list) = <a class="code" href="gencode_8c.html#a25">target</a>;
00412         }
00413         list = next;
00414     }
00415 }
00416 
00417 <span class="comment">/*</span>
00418 <span class="comment"> * Merge the lists in b0 and b1, using the 'sense' field to indicate</span>
00419 <span class="comment"> * which of jt and jf is the link.</span>
00420 <span class="comment"> */</span>
00421 <span class="keyword">static</span> <span class="keywordtype">void</span>
00422 <a class="code" href="gencode_8c.html#a75">merge</a>(b0, b1)
00423     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
00424 {
00425     <span class="keyword">register</span> <span class="keyword">struct </span>block **p = &amp;b0;
00426 
00427     <span class="comment">/* Find end of list. */</span>
00428     <span class="keywordflow">while</span> (*p)
00429         p = !((*p)-&gt;sense) ? &amp;JT(*p) : &amp;JF(*p);
00430 
00431     <span class="comment">/* Concatenate the lists. */</span>
00432     *p = <a class="code" href="gencode_8c.html#a26">b1</a>;
00433 }
00434 
00435 <span class="keywordtype">void</span>
00436 finish_parse(p)
00437     <span class="keyword">struct </span>block *p;
00438 {
00439     <a class="code" href="gencode_8c.html#a114">backpatch</a>(p, <a class="code" href="gencode_8c.html#a72">gen_retblk</a>(snaplen));
00440     p-&gt;sense = !p-&gt;sense;
00441     <a class="code" href="gencode_8c.html#a114">backpatch</a>(p, <a class="code" href="gencode_8c.html#a72">gen_retblk</a>(0));
00442     <a class="code" href="gencode_8c.html#a20">root</a> = p-&gt;head;
00443 }
00444 
00445 <span class="keywordtype">void</span>
00446 gen_and(b0, b1)
00447     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
00448 {
00449     <a class="code" href="gencode_8c.html#a114">backpatch</a>(b0, <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;head);
00450     b0-&gt;sense = !b0-&gt;sense;
00451     <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;sense = !<a class="code" href="gencode_8c.html#a26">b1</a>-&gt;sense;
00452     <a class="code" href="gencode_8c.html#a75">merge</a>(b1, b0);
00453     <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;sense = !<a class="code" href="gencode_8c.html#a26">b1</a>-&gt;sense;
00454     <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;head = b0-&gt;head;
00455 }
00456 
00457 <span class="keywordtype">void</span>
00458 gen_or(b0, b1)
<a name="l00459"></a><a class="code" href="gencode_8c.html#a26">00459</a>     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
00460 {
00461     b0-&gt;sense = !b0-&gt;sense;
00462     <a class="code" href="gencode_8c.html#a114">backpatch</a>(b0, <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;head);
00463     b0-&gt;sense = !b0-&gt;sense;
00464     <a class="code" href="gencode_8c.html#a75">merge</a>(b1, b0);
00465     <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;head = b0-&gt;head;
00466 }
00467 
00468 <span class="keywordtype">void</span>
00469 gen_not(b)
00470     <span class="keyword">struct </span>block *b;
00471 {
00472     b-&gt;sense = !b-&gt;sense;
00473 }
00474 
00475 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00476 <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(<a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>, <a class="code" href="gencode_8c.html#a28">v</a>)
00477     u_int <a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>;
00478     <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> <a class="code" href="gencode_8c.html#a28">v</a>;
00479 {
00480     <span class="keyword">struct </span>slist *s;
00481     <span class="keyword">struct </span>block *b;
00482 
00483     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_ABS|size);
00484     s-&gt;s.k = <a class="code" href="gencode_8c.html#a30">offset</a>;
00485 
00486     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JEQ));
00487     b-&gt;stmts = s;
00488     b-&gt;s.k = <a class="code" href="gencode_8c.html#a28">v</a>;
00489 
00490     <span class="keywordflow">return</span> b;
00491 }
00492 
00493 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00494 <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(<a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>, <a class="code" href="gencode_8c.html#a28">v</a>)
00495     u_int <a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>;
00496     <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> <a class="code" href="gencode_8c.html#a28">v</a>;
00497 {
00498     <span class="keyword">struct </span>slist *s;
00499     <span class="keyword">struct </span>block *b;
00500 
00501     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_ABS|size);
00502     s-&gt;s.k = <a class="code" href="gencode_8c.html#a30">offset</a>;
00503 
00504     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JGT));
00505     b-&gt;stmts = s;
00506     b-&gt;s.k = <a class="code" href="gencode_8c.html#a28">v</a>;
00507 
00508     <span class="keywordflow">return</span> b;
00509 }
00510 
00511 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00512 <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(<a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>, <a class="code" href="gencode_8c.html#a28">v</a>, <a class="code" href="gencode_8c.html#a29">mask</a>)
00513     u_int <a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>;
00514     <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> <a class="code" href="gencode_8c.html#a28">v</a>;
00515     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a29">mask</a>;
00516 {
00517     <span class="keyword">struct </span>block *b = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(offset, size, v);
00518     <span class="keyword">struct </span>slist *s;
00519 
00520     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a29">mask</a> != 0xffffffff) {
00521         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_AND|BPF_K);
00522         s-&gt;s.k = <a class="code" href="gencode_8c.html#a29">mask</a>;
00523         b-&gt;stmts-&gt;next = s;
00524     }
00525     <span class="keywordflow">return</span> b;
00526 }
00527 
00528 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00529 <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(<a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>, <a class="code" href="gencode_8c.html#a28">v</a>)
00530     register u_int <a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a27">size</a>;
00531     <span class="keyword">register</span> <span class="keyword">const</span> u_char *<a class="code" href="gencode_8c.html#a28">v</a>;
00532 {
00533     <span class="keyword">register</span> <span class="keyword">struct </span>block *b, *tmp;
00534 
00535     b = NULL;
00536     <span class="keywordflow">while</span> (<a class="code" href="gencode_8c.html#a27">size</a> &gt;= 4) {
00537         <span class="keyword">register</span> <span class="keyword">const</span> u_char *p = &amp;<a class="code" href="gencode_8c.html#a28">v</a>[<a class="code" href="gencode_8c.html#a27">size</a> - 4];
00538         <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> w = ((bpf_int32)p[0] &lt;&lt; 24) |
00539             ((bpf_int32)p[1] &lt;&lt; 16) | ((bpf_int32)p[2] &lt;&lt; 8) | p[3];
00540 
00541         tmp = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(offset + size - 4, BPF_W, w);
00542         <span class="keywordflow">if</span> (b != NULL)
00543             gen_and(b, tmp);
00544         b = tmp;
00545         <a class="code" href="gencode_8c.html#a27">size</a> -= 4;
00546     }
00547     <span class="keywordflow">while</span> (<a class="code" href="gencode_8c.html#a27">size</a> &gt;= 2) {
00548         <span class="keyword">register</span> <span class="keyword">const</span> u_char *p = &amp;<a class="code" href="gencode_8c.html#a28">v</a>[<a class="code" href="gencode_8c.html#a27">size</a> - 2];
00549         <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> w = ((bpf_int32)p[0] &lt;&lt; 8) | p[1];
00550 
00551         tmp = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(offset + size - 2, BPF_H, w);
00552         <span class="keywordflow">if</span> (b != NULL)
00553             gen_and(b, tmp);
00554         b = tmp;
00555         <a class="code" href="gencode_8c.html#a27">size</a> -= 2;
00556     }
00557     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a27">size</a> &gt; 0) {
00558         tmp = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(offset, BPF_B, (bpf_int32)v[0]);
00559         <span class="keywordflow">if</span> (b != NULL)
00560             gen_and(b, tmp);
00561         b = tmp;
00562     }
00563     <span class="keywordflow">return</span> b;
00564 }
00565 
00566 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00567 <a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(datasize, <a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a29">mask</a>, <a class="code" href="gencode_8c.html#a31">jtype</a>, <a class="code" href="gencode_8c.html#a32">jvalue</a>, <a class="code" href="gencode_8c.html#a33">reverse</a>)
00568     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> datasize, <a class="code" href="gencode_8c.html#a30">offset</a>, <a class="code" href="gencode_8c.html#a29">mask</a>, <a class="code" href="gencode_8c.html#a31">jtype</a>, <a class="code" href="gencode_8c.html#a32">jvalue</a>;
00569     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a33">reverse</a>;
00570 {
00571     <span class="keyword">struct </span>slist *s;
00572     <span class="keyword">struct </span>block *b;
00573  
00574     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|datasize|BPF_ABS);
00575     s-&gt;s.k = <a class="code" href="gencode_8c.html#a30">offset</a>;
00576  
00577     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a29">mask</a> != 0xffffffff) {
00578         s-&gt;next = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_AND|BPF_K);
00579         s-&gt;next-&gt;s.k = <a class="code" href="gencode_8c.html#a29">mask</a>;
00580     }
00581  
00582     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(jtype));
00583     b-&gt;stmts = s;
00584     b-&gt;s.k = <a class="code" href="gencode_8c.html#a32">jvalue</a>;
00585     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a33">reverse</a> &amp;&amp; (<a class="code" href="gencode_8c.html#a31">jtype</a> == BPF_JGT || <a class="code" href="gencode_8c.html#a31">jtype</a> == BPF_JGE))
00586         gen_not(b);
00587     <span class="keywordflow">return</span> b;
00588 }
00589 
00590 <span class="comment">/*</span>
00591 <span class="comment"> * Various code constructs need to know the layout of the data link</span>
00592 <span class="comment"> * layer.  These variables give the necessary offsets.</span>
00593 <span class="comment"> */</span>
00594 
00595 <span class="comment">/*</span>
00596 <span class="comment"> * This is the offset of the beginning of the MAC-layer header.</span>
00597 <span class="comment"> * It's usually 0, except for ATM LANE.</span>
00598 <span class="comment"> */</span>
00599 <span class="keyword">static</span> u_int off_mac;
00600 
00601 <span class="comment">/*</span>
00602 <span class="comment"> * "off_linktype" is the offset to information in the link-layer header</span>
00603 <span class="comment"> * giving the packet type.</span>
00604 <span class="comment"> *</span>
00605 <span class="comment"> * For Ethernet, it's the offset of the Ethernet type field.</span>
00606 <span class="comment"> *</span>
00607 <span class="comment"> * For link-layer types that always use 802.2 headers, it's the</span>
00608 <span class="comment"> * offset of the LLC header.</span>
00609 <span class="comment"> *</span>
00610 <span class="comment"> * For PPP, it's the offset of the PPP type field.</span>
00611 <span class="comment"> *</span>
00612 <span class="comment"> * For Cisco HDLC, it's the offset of the CHDLC type field.</span>
00613 <span class="comment"> *</span>
00614 <span class="comment"> * For BSD loopback, it's the offset of the AF_ value.</span>
00615 <span class="comment"> *</span>
00616 <span class="comment"> * For Linux cooked sockets, it's the offset of the type field.</span>
00617 <span class="comment"> *</span>
00618 <span class="comment"> * It's set to -1 for no encapsulation, in which case, IP is assumed.</span>
00619 <span class="comment"> */</span>
<a name="l00620"></a><a class="code" href="gencode_8c.html#a34">00620</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a34">off_linktype</a>;
00621 
00622 <span class="comment">/*</span>
00623 <span class="comment"> * TRUE if the link layer includes an ATM pseudo-header.</span>
00624 <span class="comment"> */</span>
<a name="l00625"></a><a class="code" href="gencode_8c.html#a35">00625</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a35">is_atm</a> = 0;
00626 
00627 <span class="comment">/*</span>
00628 <span class="comment"> * TRUE if "lane" appeared in the filter; it causes us to generate</span>
00629 <span class="comment"> * code that assumes LANE rather than LLC-encapsulated traffic in SunATM.</span>
00630 <span class="comment"> */</span>
<a name="l00631"></a><a class="code" href="gencode_8c.html#a36">00631</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a36">is_lane</a> = 0;
00632 
00633 <span class="comment">/*</span>
00634 <span class="comment"> * These are offsets for the ATM pseudo-header.</span>
00635 <span class="comment"> */</span>
<a name="l00636"></a><a class="code" href="gencode_8c.html#a37">00636</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a37">off_vpi</a>;
<a name="l00637"></a><a class="code" href="gencode_8c.html#a38">00637</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a38">off_vci</a>;
<a name="l00638"></a><a class="code" href="gencode_8c.html#a39">00638</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a39">off_proto</a>;
00639 
00640 <span class="comment">/*</span>
00641 <span class="comment"> * This is the offset of the first byte after the ATM pseudo_header,</span>
00642 <span class="comment"> * or -1 if there is no ATM pseudo-header.</span>
00643 <span class="comment"> */</span>
<a name="l00644"></a><a class="code" href="gencode_8c.html#a40">00644</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a40">off_payload</a>;
00645 
00646 <span class="comment">/*</span>
00647 <span class="comment"> * These are offsets to the beginning of the network-layer header.</span>
00648 <span class="comment"> *</span>
00649 <span class="comment"> * If the link layer never uses 802.2 LLC:</span>
00650 <span class="comment"> *</span>
00651 <span class="comment"> *  "off_nl" and "off_nl_nosnap" are the same.</span>
00652 <span class="comment"> *</span>
00653 <span class="comment"> * If the link layer always uses 802.2 LLC:</span>
00654 <span class="comment"> *</span>
00655 <span class="comment"> *  "off_nl" is the offset if there's a SNAP header following</span>
00656 <span class="comment"> *  the 802.2 header;</span>
00657 <span class="comment"> *</span>
00658 <span class="comment"> *  "off_nl_nosnap" is the offset if there's no SNAP header.</span>
00659 <span class="comment"> *</span>
00660 <span class="comment"> * If the link layer is Ethernet:</span>
00661 <span class="comment"> *</span>
00662 <span class="comment"> *  "off_nl" is the offset if the packet is an Ethernet II packet</span>
00663 <span class="comment"> *  (we assume no 802.3+802.2+SNAP);</span>
00664 <span class="comment"> *</span>
00665 <span class="comment"> *  "off_nl_nosnap" is the offset if the packet is an 802.3 packet</span>
00666 <span class="comment"> *  with an 802.2 header following it.</span>
00667 <span class="comment"> */</span>
<a name="l00668"></a><a class="code" href="gencode_8c.html#a41">00668</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a41">off_nl</a>;
<a name="l00669"></a><a class="code" href="gencode_8c.html#a42">00669</a> <span class="keyword">static</span> u_int <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a>;
00670 
<a name="l00671"></a><a class="code" href="gencode_8c.html#a43">00671</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a43">linktype</a>;
00672 
00673 <span class="keyword">static</span> <span class="keywordtype">void</span>
00674 <a class="code" href="gencode_8c.html#a115">init_linktype</a>(type)
00675     <span class="keywordtype">int</span> type;
00676 {
00677     <a class="code" href="gencode_8c.html#a43">linktype</a> = type;
00678 
00679     <span class="comment">/*</span>
00680 <span class="comment">     * Assume it's not raw ATM with a pseudo-header, for now.</span>
00681 <span class="comment">     */</span>
00682     off_mac = 0;
00683     <a class="code" href="gencode_8c.html#a35">is_atm</a> = 0;
00684     <a class="code" href="gencode_8c.html#a36">is_lane</a> = 0;
00685     <a class="code" href="gencode_8c.html#a37">off_vpi</a> = -1;
00686     <a class="code" href="gencode_8c.html#a38">off_vci</a> = -1;
00687     <a class="code" href="gencode_8c.html#a39">off_proto</a> = -1;
00688     <a class="code" href="gencode_8c.html#a40">off_payload</a> = -1;
00689 
00690     <a class="code" href="gencode_8c.html#a16">orig_linktype</a> = -1;
00691     <a class="code" href="gencode_8c.html#a17">orig_nl</a> = -1;
00692     <a class="code" href="gencode_8c.html#a18">orig_nl_nosnap</a> = -1;
00693 
00694     <span class="keywordflow">switch</span> (type) {
00695 
00696     <span class="keywordflow">case</span> DLT_ARCNET:
00697         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 2;
00698         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 6;     <span class="comment">/* XXX in reality, variable! */</span>
00699         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 6;  <span class="comment">/* no 802.2 LLC */</span>
00700         <span class="keywordflow">return</span>;
00701 
00702     <span class="keywordflow">case</span> DLT_ARCNET_LINUX:
00703         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 4;
00704         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 8;     <span class="comment">/* XXX in reality, variable! */</span>
00705         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 8;  <span class="comment">/* no 802.2 LLC */</span>
00706         <span class="keywordflow">return</span>;
00707 
00708     <span class="keywordflow">case</span> DLT_EN10MB:
00709         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 12;
00710         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 14;        <span class="comment">/* Ethernet II */</span>
00711         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 17; <span class="comment">/* 802.3+802.2 */</span>
00712         <span class="keywordflow">return</span>;
00713 
00714     <span class="keywordflow">case</span> DLT_SLIP:
00715         <span class="comment">/*</span>
00716 <span class="comment">         * SLIP doesn't have a link level type.  The 16 byte</span>
00717 <span class="comment">         * header is hacked into our SLIP driver.</span>
00718 <span class="comment">         */</span>
00719         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = -1;
00720         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 16;
00721         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 16; <span class="comment">/* no 802.2 LLC */</span>
00722         <span class="keywordflow">return</span>;
00723 
00724     <span class="keywordflow">case</span> DLT_SLIP_BSDOS:
00725         <span class="comment">/* XXX this may be the same as the DLT_PPP_BSDOS case */</span>
00726         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = -1;
00727         <span class="comment">/* XXX end */</span>
00728         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 24;
00729         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 24; <span class="comment">/* no 802.2 LLC */</span>
00730         <span class="keywordflow">return</span>;
00731 
00732     <span class="keywordflow">case</span> DLT_NULL:
00733     <span class="keywordflow">case</span> DLT_LOOP:
00734         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 0;
00735         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 4;
00736         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 4;  <span class="comment">/* no 802.2 LLC */</span>
00737         <span class="keywordflow">return</span>;
00738 
00739     <span class="keywordflow">case</span> DLT_PPP:
00740     <span class="keywordflow">case</span> DLT_C_HDLC:        <span class="comment">/* BSD/OS Cisco HDLC */</span>
00741     <span class="keywordflow">case</span> DLT_PPP_SERIAL:        <span class="comment">/* NetBSD sync/async serial PPP */</span>
00742         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 2;
00743         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 4;
00744         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 4;  <span class="comment">/* no 802.2 LLC */</span>
00745         <span class="keywordflow">return</span>;
00746 
00747     <span class="keywordflow">case</span> DLT_PPP_ETHER:
00748         <span class="comment">/*</span>
00749 <span class="comment">         * This does no include the Ethernet header, and</span>
00750 <span class="comment">         * only covers session state.</span>
00751 <span class="comment">         */</span>
00752         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 6;
00753         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 8;
00754         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 8;  <span class="comment">/* no 802.2 LLC */</span>
00755         <span class="keywordflow">return</span>;
00756 
00757     <span class="keywordflow">case</span> DLT_PPP_BSDOS:
00758         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 5;
00759         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 24;
00760         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 24; <span class="comment">/* no 802.2 LLC */</span>
00761         <span class="keywordflow">return</span>;
00762 
00763     <span class="keywordflow">case</span> DLT_FDDI:
00764         <span class="comment">/*</span>
00765 <span class="comment">         * FDDI doesn't really have a link-level type field.</span>
00766 <span class="comment">         * We set "off_linktype" to the offset of the LLC header.</span>
00767 <span class="comment">         *</span>
00768 <span class="comment">         * To check for Ethernet types, we assume that SSAP = SNAP</span>
00769 <span class="comment">         * is being used and pick out the encapsulated Ethernet type.</span>
00770 <span class="comment">         * XXX - should we generate code to check for SNAP?</span>
00771 <span class="comment">         */</span>
00772         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 13;
00773 <span class="preprocessor">#ifdef PCAP_FDDIPAD</span>
00774 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a34">off_linktype</a> += <a class="code" href="gencode_8c.html#a19">pcap_fddipad</a>;
00775 <span class="preprocessor">#endif</span>
00776 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a41">off_nl</a> = 21;        <span class="comment">/* FDDI+802.2+SNAP */</span>
00777         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 16; <span class="comment">/* FDDI+802.2 */</span>
00778 <span class="preprocessor">#ifdef PCAP_FDDIPAD</span>
00779 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a41">off_nl</a> += <a class="code" href="gencode_8c.html#a19">pcap_fddipad</a>;
00780         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> += <a class="code" href="gencode_8c.html#a19">pcap_fddipad</a>;
00781 <span class="preprocessor">#endif</span>
00782 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
00783 
00784     <span class="keywordflow">case</span> DLT_IEEE802:
00785         <span class="comment">/*</span>
00786 <span class="comment">         * Token Ring doesn't really have a link-level type field.</span>
00787 <span class="comment">         * We set "off_linktype" to the offset of the LLC header.</span>
00788 <span class="comment">         *</span>
00789 <span class="comment">         * To check for Ethernet types, we assume that SSAP = SNAP</span>
00790 <span class="comment">         * is being used and pick out the encapsulated Ethernet type.</span>
00791 <span class="comment">         * XXX - should we generate code to check for SNAP?</span>
00792 <span class="comment">         *</span>
00793 <span class="comment">         * XXX - the header is actually variable-length.</span>
00794 <span class="comment">         * Some various Linux patched versions gave 38</span>
00795 <span class="comment">         * as "off_linktype" and 40 as "off_nl"; however,</span>
00796 <span class="comment">         * if a token ring packet has *no* routing</span>
00797 <span class="comment">         * information, i.e. is not source-routed, the correct</span>
00798 <span class="comment">         * values are 20 and 22, as they are in the vanilla code.</span>
00799 <span class="comment">         *</span>
00800 <span class="comment">         * A packet is source-routed iff the uppermost bit</span>
00801 <span class="comment">         * of the first byte of the source address, at an</span>
00802 <span class="comment">         * offset of 8, has the uppermost bit set.  If the</span>
00803 <span class="comment">         * packet is source-routed, the total number of bytes</span>
00804 <span class="comment">         * of routing information is 2 plus bits 0x1F00 of</span>
00805 <span class="comment">         * the 16-bit value at an offset of 14 (shifted right</span>
00806 <span class="comment">         * 8 - figure out which byte that is).</span>
00807 <span class="comment">         */</span>
00808         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 14;
00809         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 22;        <span class="comment">/* Token Ring+802.2+SNAP */</span>
00810         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 17; <span class="comment">/* Token Ring+802.2 */</span>
00811         <span class="keywordflow">return</span>;
00812 
00813     <span class="keywordflow">case</span> DLT_IEEE802_11:
00814         <span class="comment">/*</span>
00815 <span class="comment">         * 802.11 doesn't really have a link-level type field.</span>
00816 <span class="comment">         * We set "off_linktype" to the offset of the LLC header.</span>
00817 <span class="comment">         *</span>
00818 <span class="comment">         * To check for Ethernet types, we assume that SSAP = SNAP</span>
00819 <span class="comment">         * is being used and pick out the encapsulated Ethernet type.</span>
00820 <span class="comment">         * XXX - should we generate code to check for SNAP?</span>
00821 <span class="comment">         *</span>
00822 <span class="comment">         * XXX - the header is actually variable-length.  We</span>
00823 <span class="comment">         * assume a 24-byte link-layer header, as appears in</span>
00824 <span class="comment">         * data frames in networks with no bridges.</span>
00825 <span class="comment">         */</span>
00826         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 24;
00827         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 32;        <span class="comment">/* 802.11+802.2+SNAP */</span>
00828         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 27; <span class="comment">/* 802.11+802.2 */</span>
00829         <span class="keywordflow">return</span>;
00830 
00831     <span class="keywordflow">case</span> DLT_PRISM_HEADER:
00832         <span class="comment">/*</span>
00833 <span class="comment">         * Same as 802.11, but with an additional header before</span>
00834 <span class="comment">         * the 802.11 header, containing a bunch of additional</span>
00835 <span class="comment">         * information including radio-level information.</span>
00836 <span class="comment">         *</span>
00837 <span class="comment">         * The header is 144 bytes long.</span>
00838 <span class="comment">         *</span>
00839 <span class="comment">         * XXX - same variable-length header problem; at least</span>
00840 <span class="comment">         * the Prism header is fixed-length.</span>
00841 <span class="comment">         */</span>
00842         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 144+24;
00843         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 144+32;    <span class="comment">/* Prism+802.11+802.2+SNAP */</span>
00844         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 144+27; <span class="comment">/* Prism+802.11+802.2 */</span>
00845         <span class="keywordflow">return</span>;
00846 
00847     <span class="keywordflow">case</span> DLT_IEEE802_11_RADIO:
00848         <span class="comment">/*</span>
00849 <span class="comment">         * Same as 802.11, but with an additional header before</span>
00850 <span class="comment">         * the 802.11 header, containing a bunch of additional</span>
00851 <span class="comment">         * information including radio-level information.</span>
00852 <span class="comment">         *</span>
00853 <span class="comment">         * The header is 64 bytes long.</span>
00854 <span class="comment">         *</span>
00855 <span class="comment">         * XXX - same variable-length header problem, only</span>
00856 <span class="comment">         * more so; this header is also variable-length,</span>
00857 <span class="comment">         * with the length being the 32-bit big-endian</span>
00858 <span class="comment">         * number at an offset of 4 from the beginning</span>
00859 <span class="comment">         * of the radio header.</span>
00860 <span class="comment">         */</span>
00861         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 64+24;
00862         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 64+32;     <span class="comment">/* Radio+802.11+802.2+SNAP */</span>
00863         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 64+27;  <span class="comment">/* Radio+802.11+802.2 */</span>
00864         <span class="keywordflow">return</span>;
00865 
00866     <span class="keywordflow">case</span> DLT_ATM_RFC1483:
00867         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 0;
00868         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 4;             <span class="comment">/* FIXME SNAP */</span>
00869         <span class="keywordflow">return</span>;
00870 
00871     <span class="keywordflow">case</span> DLT_ATM_CLIP:  <span class="comment">/* Linux ATM defines this */</span>
00872         <span class="comment">/*</span>
00873 <span class="comment">         * assume routed, non-ISO PDUs</span>
00874 <span class="comment">         * (i.e., LLC = 0xAA-AA-03, OUT = 0x00-00-00)</span>
00875 <span class="comment">         */</span>
00876         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 0;
00877         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 8;     <span class="comment">/* 802.2+SNAP */</span>
00878         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 3;  <span class="comment">/* 802.2 */</span>
00879         <span class="keywordflow">return</span>;
00880 
00881     <span class="keywordflow">case</span> DLT_SUNATM:
00882         <span class="comment">/*</span>
00883 <span class="comment">         * Full Frontal ATM; you get AALn PDUs with an ATM</span>
00884 <span class="comment">         * pseudo-header.</span>
00885 <span class="comment">         */</span>
00886         <a class="code" href="gencode_8c.html#a35">is_atm</a> = 1;
00887         <a class="code" href="gencode_8c.html#a37">off_vpi</a> = SUNATM_VPI_POS;
00888         <a class="code" href="gencode_8c.html#a38">off_vci</a> = SUNATM_VCI_POS;
00889         <a class="code" href="gencode_8c.html#a39">off_proto</a> = PROTO_POS;
00890         off_mac = -1;   <span class="comment">/* LLC-encapsulated, so no MAC-layer header */</span>  
00891         <a class="code" href="gencode_8c.html#a40">off_payload</a> = SUNATM_PKT_BEGIN_POS;
00892         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = <a class="code" href="gencode_8c.html#a40">off_payload</a>;
00893         <a class="code" href="gencode_8c.html#a41">off_nl</a> = <a class="code" href="gencode_8c.html#a40">off_payload</a>+8;     <span class="comment">/* 802.2+SNAP */</span>
00894         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = <a class="code" href="gencode_8c.html#a40">off_payload</a>+3;  <span class="comment">/* 802.2 */</span>
00895         <span class="keywordflow">return</span>;
00896 
00897     <span class="keywordflow">case</span> DLT_RAW:
00898         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = -1;
00899         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 0;
00900         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 0;  <span class="comment">/* no 802.2 LLC */</span>
00901         <span class="keywordflow">return</span>;
00902 
00903     <span class="keywordflow">case</span> DLT_LINUX_SLL: <span class="comment">/* fake header for Linux cooked socket */</span>
00904         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 14;
00905         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 16;
00906         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 16; <span class="comment">/* no 802.2 LLC */</span>
00907         <span class="keywordflow">return</span>;
00908 
00909     <span class="keywordflow">case</span> DLT_LTALK:
00910         <span class="comment">/*</span>
00911 <span class="comment">         * LocalTalk does have a 1-byte type field in the LLAP header,</span>
00912 <span class="comment">         * but really it just indicates whether there is a "short" or</span>
00913 <span class="comment">         * "long" DDP packet following.</span>
00914 <span class="comment">         */</span>
00915         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = -1;
00916         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 0;
00917         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 0;  <span class="comment">/* no 802.2 LLC */</span>
00918         <span class="keywordflow">return</span>;
00919 
00920     <span class="keywordflow">case</span> DLT_IP_OVER_FC:
00921         <span class="comment">/*</span>
00922 <span class="comment">         * RFC 2625 IP-over-Fibre-Channel doesn't really have a</span>
00923 <span class="comment">         * link-level type field.  We set "off_linktype" to the</span>
00924 <span class="comment">         * offset of the LLC header.</span>
00925 <span class="comment">         *</span>
00926 <span class="comment">         * To check for Ethernet types, we assume that SSAP = SNAP</span>
00927 <span class="comment">         * is being used and pick out the encapsulated Ethernet type.</span>
00928 <span class="comment">         * XXX - should we generate code to check for SNAP? RFC</span>
00929 <span class="comment">         * 2625 says SNAP should be used.</span>
00930 <span class="comment">         */</span>
00931         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 16;
00932         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 24;        <span class="comment">/* IPFC+802.2+SNAP */</span>
00933         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 19; <span class="comment">/* IPFC+802.2 */</span>
00934         <span class="keywordflow">return</span>;
00935 
00936     <span class="keywordflow">case</span> DLT_FRELAY:
00937         <span class="comment">/*</span>
00938 <span class="comment">         * XXX - we should set this to handle SNAP-encapsulated</span>
00939 <span class="comment">         * frames (NLPID of 0x80).</span>
00940 <span class="comment">         */</span>
00941         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = -1;
00942         <a class="code" href="gencode_8c.html#a41">off_nl</a> = 0;
00943         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 0;  <span class="comment">/* no 802.2 LLC */</span>
00944         <span class="keywordflow">return</span>;
00945     }
00946     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown data link type %d"</span>, linktype);
00947     <span class="comment">/* NOTREACHED */</span>
00948 }
00949 
00950 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00951 <a class="code" href="gencode_8c.html#a81">gen_uncond</a>(rsense)
00952     int rsense;
00953 {
00954     <span class="keyword">struct </span>block *b;
00955     <span class="keyword">struct </span>slist *s;
00956 
00957     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IMM);
00958     s-&gt;s.k = !rsense;
00959     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JEQ));
00960     b-&gt;stmts = s;
00961 
00962     <span class="keywordflow">return</span> b;
00963 }
00964 
00965 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>block *
00966 <a class="code" href="gencode_8c.html#a82">gen_true</a>()
00967 {
00968     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a81">gen_uncond</a>(1);
00969 }
00970 
00971 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>block *
00972 <a class="code" href="gencode_8c.html#a83">gen_false</a>()
00973 {
00974     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a81">gen_uncond</a>(0);
00975 }
00976 
00977 <span class="comment">/*</span>
00978 <span class="comment"> * Byte-swap a 32-bit number.</span>
00979 <span class="comment"> * ("htonl()" or "ntohl()" won't work - we want to byte-swap even on</span>
00980 <span class="comment"> * big-endian platforms.)</span>
00981 <span class="comment"> */</span>
00982 <span class="preprocessor">#define SWAPLONG(y) \</span>
00983 <span class="preprocessor">((((y)&amp;0xff)&lt;&lt;24) | (((y)&amp;0xff00)&lt;&lt;8) | (((y)&amp;0xff0000)&gt;&gt;8) | (((y)&gt;&gt;24)&amp;0xff))</span>
00984 <span class="preprocessor"></span>
00985 <span class="keyword">static</span> <span class="keyword">struct </span>block *
00986 <a class="code" href="gencode_8c.html#a84">gen_ether_linktype</a>(<a class="code" href="gencode_8c.html#a46">proto</a>)
00987     register int <a class="code" href="gencode_8c.html#a46">proto</a>;
00988 {
00989     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
00990 
00991     <span class="keywordflow">switch</span> (proto) {
00992 
00993     <span class="keywordflow">case</span> LLCSAP_ISONS:
00994         <span class="comment">/*</span>
00995 <span class="comment">         * OSI protocols always use 802.2 encapsulation.</span>
00996 <span class="comment">         */</span>
00997         b0 = <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(off_linktype, BPF_H, ETHERMTU);
00998         gen_not(b0);
00999         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)
01000                  ((LLCSAP_ISONS &lt;&lt; 8) | LLCSAP_ISONS));
01001         gen_and(b0, b1);
01002         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01003 
01004     <span class="keywordflow">case</span> LLCSAP_IP:
01005         b0 = <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(off_linktype, BPF_H, ETHERMTU);
01006         gen_not(b0);
01007         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)
01008                  ((LLCSAP_IP &lt;&lt; 8) | LLCSAP_IP));
01009         gen_and(b0, b1);
01010         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01011 
01012     <span class="keywordflow">case</span> LLCSAP_NETBEUI:
01013         <span class="comment">/*</span>
01014 <span class="comment">         * NetBEUI always uses 802.2 encapsulation.</span>
01015 <span class="comment">         */</span>
01016         b0 = <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(off_linktype, BPF_H, ETHERMTU);
01017         gen_not(b0);
01018         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)
01019                  ((LLCSAP_NETBEUI &lt;&lt; 8) | LLCSAP_NETBEUI));
01020         gen_and(b0, b1);
01021         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01022 
01023     <span class="keywordflow">case</span> LLCSAP_IPX:
01024         <span class="comment">/*</span>
01025 <span class="comment">         * Check for;</span>
01026 <span class="comment">         *</span>
01027 <span class="comment">         *  Ethernet_II frames, which are Ethernet</span>
01028 <span class="comment">         *  frames with a frame type of ETHERTYPE_IPX;</span>
01029 <span class="comment">         *</span>
01030 <span class="comment">         *  Ethernet_802.3 frames, which are 802.3</span>
01031 <span class="comment">         *  frames (i.e., the type/length field is</span>
01032 <span class="comment">         *  a length field, &lt;= ETHERMTU, rather than</span>
01033 <span class="comment">         *  a type field) with the first two bytes</span>
01034 <span class="comment">         *  after the Ethernet/802.3 header being</span>
01035 <span class="comment">         *  0xFFFF;</span>
01036 <span class="comment">         *</span>
01037 <span class="comment">         *  Ethernet_802.2 frames, which are 802.3</span>
01038 <span class="comment">         *  frames with an 802.2 LLC header and</span>
01039 <span class="comment">         *  with the IPX LSAP as the DSAP in the LLC</span>
01040 <span class="comment">         *  header;</span>
01041 <span class="comment">         *</span>
01042 <span class="comment">         *  Ethernet_SNAP frames, which are 802.3</span>
01043 <span class="comment">         *  frames with an LLC header and a SNAP</span>
01044 <span class="comment">         *  header and with an OUI of 0x000000</span>
01045 <span class="comment">         *  (encapsulated Ethernet) and a protocol</span>
01046 <span class="comment">         *  ID of ETHERTYPE_IPX in the SNAP header.</span>
01047 <span class="comment">         *</span>
01048 <span class="comment">         * XXX - should we generate the same code both</span>
01049 <span class="comment">         * for tests for LLCSAP_IPX and for ETHERTYPE_IPX?</span>
01050 <span class="comment">         */</span>
01051 
01052         <span class="comment">/*</span>
01053 <span class="comment">         * This generates code to check both for the</span>
01054 <span class="comment">         * IPX LSAP (Ethernet_802.2) and for Ethernet_802.3.</span>
01055 <span class="comment">         */</span>
01056         b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_B, (bpf_int32)LLCSAP_IPX);
01057         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)0xFFFF);
01058         gen_or(b0, b1);
01059 
01060         <span class="comment">/*</span>
01061 <span class="comment">         * Now we add code to check for SNAP frames with</span>
01062 <span class="comment">         * ETHERTYPE_IPX, i.e. Ethernet_SNAP.</span>
01063 <span class="comment">         */</span>
01064         b0 = <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x000000, ETHERTYPE_IPX, 14);
01065         gen_or(b0, b1);
01066 
01067         <span class="comment">/*</span>
01068 <span class="comment">         * Now we generate code to check for 802.3</span>
01069 <span class="comment">         * frames in general.</span>
01070 <span class="comment">         */</span>
01071         b0 = <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(off_linktype, BPF_H, ETHERMTU);
01072         gen_not(b0);
01073 
01074         <span class="comment">/*</span>
01075 <span class="comment">         * Now add the check for 802.3 frames before the</span>
01076 <span class="comment">         * check for Ethernet_802.2 and Ethernet_802.3,</span>
01077 <span class="comment">         * as those checks should only be done on 802.3</span>
01078 <span class="comment">         * frames, not on Ethernet frames.</span>
01079 <span class="comment">         */</span>
01080         gen_and(b0, b1);
01081 
01082         <span class="comment">/*</span>
01083 <span class="comment">         * Now add the check for Ethernet_II frames, and</span>
01084 <span class="comment">         * do that before checking for the other frame</span>
01085 <span class="comment">         * types.</span>
01086 <span class="comment">         */</span>
01087         b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (bpf_int32)ETHERTYPE_IPX);
01088         gen_or(b0, b1);
01089         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01090 
01091     <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01092     <span class="keywordflow">case</span> ETHERTYPE_AARP:
01093         <span class="comment">/*</span>
01094 <span class="comment">         * EtherTalk (AppleTalk protocols on Ethernet link</span>
01095 <span class="comment">         * layer) may use 802.2 encapsulation.</span>
01096 <span class="comment">         */</span>
01097 
01098         <span class="comment">/*</span>
01099 <span class="comment">         * Check for 802.2 encapsulation (EtherTalk phase 2?);</span>
01100 <span class="comment">         * we check for an Ethernet type field less than</span>
01101 <span class="comment">         * 1500, which means it's an 802.3 length field.</span>
01102 <span class="comment">         */</span>
01103         b0 = <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(off_linktype, BPF_H, ETHERMTU);
01104         gen_not(b0);
01105 
01106         <span class="comment">/*</span>
01107 <span class="comment">         * 802.2-encapsulated ETHERTYPE_ATALK packets are</span>
01108 <span class="comment">         * SNAP packets with an organization code of</span>
01109 <span class="comment">         * 0x080007 (Apple, for Appletalk) and a protocol</span>
01110 <span class="comment">         * type of ETHERTYPE_ATALK (Appletalk).</span>
01111 <span class="comment">         *</span>
01112 <span class="comment">         * 802.2-encapsulated ETHERTYPE_AARP packets are</span>
01113 <span class="comment">         * SNAP packets with an organization code of</span>
01114 <span class="comment">         * 0x000000 (encapsulated Ethernet) and a protocol</span>
01115 <span class="comment">         * type of ETHERTYPE_AARP (Appletalk ARP).</span>
01116 <span class="comment">         */</span>
01117         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == ETHERTYPE_ATALK)
01118             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x080007, ETHERTYPE_ATALK, 14);
01119         <span class="keywordflow">else</span>    <span class="comment">/* proto == ETHERTYPE_AARP */</span>
01120             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x000000, ETHERTYPE_AARP, 14);
01121         gen_and(b0, b1);
01122 
01123         <span class="comment">/*</span>
01124 <span class="comment">         * Check for Ethernet encapsulation (Ethertalk</span>
01125 <span class="comment">         * phase 1?); we just check for the Ethernet</span>
01126 <span class="comment">         * protocol type.</span>
01127 <span class="comment">         */</span>
01128         b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (bpf_int32)proto);
01129 
01130         gen_or(b0, b1);
01131         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01132 
01133     <span class="keywordflow">default</span>:
01134         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> &lt;= <a class="code" href="gencode_8c.html#a0">ETHERMTU</a>) {
01135             <span class="comment">/*</span>
01136 <span class="comment">             * This is an LLC SAP value, so the frames</span>
01137 <span class="comment">             * that match would be 802.2 frames.</span>
01138 <span class="comment">             * Check that the frame is an 802.2 frame</span>
01139 <span class="comment">             * (i.e., that the length/type field is</span>
01140 <span class="comment">             * a length field, &lt;= ETHERMTU) and</span>
01141 <span class="comment">             * then check the DSAP.</span>
01142 <span class="comment">             */</span>
01143             b0 = <a class="code" href="gencode_8c.html#a77">gen_cmp_gt</a>(off_linktype, BPF_H, ETHERMTU);
01144             gen_not(b0);
01145             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_B, (bpf_int32)proto);
01146             gen_and(b0, b1);
01147             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01148         } <span class="keywordflow">else</span> {
01149             <span class="comment">/*</span>
01150 <span class="comment">             * This is an Ethernet type, so compare</span>
01151 <span class="comment">             * the length/type field with it (if</span>
01152 <span class="comment">             * the frame is an 802.2 frame, the length</span>
01153 <span class="comment">             * field will be &lt;= ETHERMTU, and, as</span>
01154 <span class="comment">             * "proto" is &gt; ETHERMTU, this test</span>
01155 <span class="comment">             * will fail and the frame won't match,</span>
01156 <span class="comment">             * which is what we want).</span>
01157 <span class="comment">             */</span>
01158             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (bpf_int32)proto);
01159         }
01160     }
01161 }
01162 
01163 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01164 <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(<a class="code" href="gencode_8c.html#a46">proto</a>)
01165     register int <a class="code" href="gencode_8c.html#a46">proto</a>;
01166 {
01167     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *b2;
01168 
01169     <span class="keywordflow">switch</span> (linktype) {
01170 
01171     <span class="keywordflow">case</span> DLT_EN10MB:
01172         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a84">gen_ether_linktype</a>(proto);
01173         <span class="keywordflow">break</span>;
01174 
01175     <span class="keywordflow">case</span> DLT_C_HDLC:
01176         <span class="keywordflow">switch</span> (proto) {
01177 
01178         <span class="keywordflow">case</span> LLCSAP_ISONS:
01179             <a class="code" href="gencode_8c.html#a46">proto</a> = (<a class="code" href="gencode_8c.html#a46">proto</a> &lt;&lt; 8 | LLCSAP_ISONS);
01180             <span class="comment">/* fall through */</span>
01181 
01182         <span class="keywordflow">default</span>:
01183             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (bpf_int32)proto);
01184             <span class="keywordflow">break</span>;
01185         }
01186         <span class="keywordflow">break</span>;
01187 
01188     <span class="keywordflow">case</span> DLT_IEEE802_11:
01189     <span class="keywordflow">case</span> DLT_PRISM_HEADER:
01190     <span class="keywordflow">case</span> DLT_IEEE802_11_RADIO:
01191     <span class="keywordflow">case</span> DLT_FDDI:
01192     <span class="keywordflow">case</span> DLT_IEEE802:
01193     <span class="keywordflow">case</span> DLT_ATM_RFC1483:
01194     <span class="keywordflow">case</span> DLT_ATM_CLIP:
01195     <span class="keywordflow">case</span> DLT_IP_OVER_FC:
01196         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a87">gen_llc</a>(proto);
01197         <span class="keywordflow">break</span>;
01198 
01199     <span class="keywordflow">case</span> DLT_SUNATM:
01200         <span class="comment">/*</span>
01201 <span class="comment">         * If "is_lane" is set, check for a LANE-encapsulated</span>
01202 <span class="comment">         * version of this protocol, otherwise check for an</span>
01203 <span class="comment">         * LLC-encapsulated version of this protocol.</span>
01204 <span class="comment">         *</span>
01205 <span class="comment">         * We assume LANE means Ethernet, not Token Ring.</span>
01206 <span class="comment">         */</span>
01207         <span class="keywordflow">if</span> (is_lane) {
01208             <span class="comment">/*</span>
01209 <span class="comment">             * Check that the packet doesn't begin with an</span>
01210 <span class="comment">             * LE Control marker.  (We've already generated</span>
01211 <span class="comment">             * a test for LANE.)</span>
01212 <span class="comment">             */</span>
01213             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(SUNATM_PKT_BEGIN_POS, BPF_H, 0xFF00);
01214             gen_not(b0);
01215 
01216             <span class="comment">/*</span>
01217 <span class="comment">             * Now generate an Ethernet test.</span>
01218 <span class="comment">             */</span>
01219             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a84">gen_ether_linktype</a>(proto);
01220             gen_and(b0, b1);
01221             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01222         } <span class="keywordflow">else</span> {
01223             <span class="comment">/*</span>
01224 <span class="comment">             * Check for LLC encapsulation and then check the</span>
01225 <span class="comment">             * protocol.</span>
01226 <span class="comment">             */</span>
01227             b0 = gen_atmfield_code(A_PROTOTYPE, PT_LLC, BPF_JEQ, 0);
01228             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a87">gen_llc</a>(proto);
01229             gen_and(b0, b1);
01230             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01231         }
01232 
01233     <span class="keywordflow">case</span> DLT_LINUX_SLL:
01234         <span class="keywordflow">switch</span> (proto) {
01235 
01236         <span class="keywordflow">case</span> LLCSAP_IP:
01237             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, LINUX_SLL_P_802_2);
01238             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)
01239                      ((LLCSAP_IP &lt;&lt; 8) | LLCSAP_IP));
01240             gen_and(b0, b1);
01241             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01242 
01243         <span class="keywordflow">case</span> LLCSAP_ISONS:
01244             <span class="comment">/*</span>
01245 <span class="comment">             * OSI protocols always use 802.2 encapsulation.</span>
01246 <span class="comment">             */</span>
01247             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, LINUX_SLL_P_802_2);
01248             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)
01249                      ((LLCSAP_ISONS &lt;&lt; 8) | LLCSAP_ISONS));
01250             gen_and(b0, b1);
01251             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01252 
01253         <span class="keywordflow">case</span> LLCSAP_NETBEUI:
01254             <span class="comment">/*</span>
01255 <span class="comment">             * NetBEUI always uses 802.2 encapsulation.</span>
01256 <span class="comment">             * XXX - should we check both the DSAP and the</span>
01257 <span class="comment">             * LSAP, like this, or should we check just the</span>
01258 <span class="comment">             * DSAP?</span>
01259 <span class="comment">             */</span>
01260             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, LINUX_SLL_P_802_2);
01261             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_H, (bpf_int32)
01262                      ((LLCSAP_NETBEUI &lt;&lt; 8) | LLCSAP_NETBEUI));
01263             gen_and(b0, b1);
01264             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01265 
01266         <span class="keywordflow">case</span> LLCSAP_IPX:
01267             <span class="comment">/*</span>
01268 <span class="comment">             *  Ethernet_II frames, which are Ethernet</span>
01269 <span class="comment">             *  frames with a frame type of ETHERTYPE_IPX;</span>
01270 <span class="comment">             *</span>
01271 <span class="comment">             *  Ethernet_802.3 frames, which have a frame</span>
01272 <span class="comment">             *  type of LINUX_SLL_P_802_3;</span>
01273 <span class="comment">             *</span>
01274 <span class="comment">             *  Ethernet_802.2 frames, which are 802.3</span>
01275 <span class="comment">             *  frames with an 802.2 LLC header (i.e, have</span>
01276 <span class="comment">             *  a frame type of LINUX_SLL_P_802_2) and</span>
01277 <span class="comment">             *  with the IPX LSAP as the DSAP in the LLC</span>
01278 <span class="comment">             *  header;</span>
01279 <span class="comment">             *</span>
01280 <span class="comment">             *  Ethernet_SNAP frames, which are 802.3</span>
01281 <span class="comment">             *  frames with an LLC header and a SNAP</span>
01282 <span class="comment">             *  header and with an OUI of 0x000000</span>
01283 <span class="comment">             *  (encapsulated Ethernet) and a protocol</span>
01284 <span class="comment">             *  ID of ETHERTYPE_IPX in the SNAP header.</span>
01285 <span class="comment">             *</span>
01286 <span class="comment">             * First, do the checks on LINUX_SLL_P_802_2</span>
01287 <span class="comment">             * frames; generate the check for either</span>
01288 <span class="comment">             * Ethernet_802.2 or Ethernet_SNAP frames, and</span>
01289 <span class="comment">             * then put a check for LINUX_SLL_P_802_2 frames</span>
01290 <span class="comment">             * before it.</span>
01291 <span class="comment">             */</span>
01292             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_B,
01293                 (bpf_int32)LLCSAP_IPX);
01294             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x000000, ETHERTYPE_IPX,
01295                 off_linktype + 2);
01296             gen_or(b0, b1);
01297             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, LINUX_SLL_P_802_2);
01298             gen_and(b0, b1);
01299 
01300             <span class="comment">/*</span>
01301 <span class="comment">             * Now check for 802.3 frames and OR that with</span>
01302 <span class="comment">             * the previous test.</span>
01303 <span class="comment">             */</span>
01304             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, LINUX_SLL_P_802_3);
01305             gen_or(b0, b1);
01306 
01307             <span class="comment">/*</span>
01308 <span class="comment">             * Now add the check for Ethernet_II frames, and</span>
01309 <span class="comment">             * do that before checking for the other frame</span>
01310 <span class="comment">             * types.</span>
01311 <span class="comment">             */</span>
01312             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H,
01313                 (bpf_int32)ETHERTYPE_IPX);
01314             gen_or(b0, b1);
01315             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01316 
01317         <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01318         <span class="keywordflow">case</span> ETHERTYPE_AARP:
01319             <span class="comment">/*</span>
01320 <span class="comment">             * EtherTalk (AppleTalk protocols on Ethernet link</span>
01321 <span class="comment">             * layer) may use 802.2 encapsulation.</span>
01322 <span class="comment">             */</span>
01323 
01324             <span class="comment">/*</span>
01325 <span class="comment">             * Check for 802.2 encapsulation (EtherTalk phase 2?);</span>
01326 <span class="comment">             * we check for the 802.2 protocol type in the</span>
01327 <span class="comment">             * "Ethernet type" field.</span>
01328 <span class="comment">             */</span>
01329             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, LINUX_SLL_P_802_2);
01330 
01331             <span class="comment">/*</span>
01332 <span class="comment">             * 802.2-encapsulated ETHERTYPE_ATALK packets are</span>
01333 <span class="comment">             * SNAP packets with an organization code of</span>
01334 <span class="comment">             * 0x080007 (Apple, for Appletalk) and a protocol</span>
01335 <span class="comment">             * type of ETHERTYPE_ATALK (Appletalk).</span>
01336 <span class="comment">             *</span>
01337 <span class="comment">             * 802.2-encapsulated ETHERTYPE_AARP packets are</span>
01338 <span class="comment">             * SNAP packets with an organization code of</span>
01339 <span class="comment">             * 0x000000 (encapsulated Ethernet) and a protocol</span>
01340 <span class="comment">             * type of ETHERTYPE_AARP (Appletalk ARP).</span>
01341 <span class="comment">             */</span>
01342             <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == ETHERTYPE_ATALK)
01343                 <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x080007, ETHERTYPE_ATALK,
01344                     off_linktype + 2);
01345             <span class="keywordflow">else</span>    <span class="comment">/* proto == ETHERTYPE_AARP */</span>
01346                 <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x000000, ETHERTYPE_AARP,
01347                     off_linktype + 2);
01348             gen_and(b0, b1);
01349 
01350             <span class="comment">/*</span>
01351 <span class="comment">             * Check for Ethernet encapsulation (Ethertalk</span>
01352 <span class="comment">             * phase 1?); we just check for the Ethernet</span>
01353 <span class="comment">             * protocol type.</span>
01354 <span class="comment">             */</span>
01355             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (bpf_int32)proto);
01356 
01357             gen_or(b0, b1);
01358             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01359 
01360         <span class="keywordflow">default</span>:
01361             <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> &lt;= <a class="code" href="gencode_8c.html#a0">ETHERMTU</a>) {
01362                 <span class="comment">/*</span>
01363 <span class="comment">                 * This is an LLC SAP value, so the frames</span>
01364 <span class="comment">                 * that match would be 802.2 frames.</span>
01365 <span class="comment">                 * Check for the 802.2 protocol type</span>
01366 <span class="comment">                 * in the "Ethernet type" field, and</span>
01367 <span class="comment">                 * then check the DSAP.</span>
01368 <span class="comment">                 */</span>
01369                 b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H,
01370                     LINUX_SLL_P_802_2);
01371                 <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype + 2, BPF_B,
01372                      (bpf_int32)proto);
01373                 gen_and(b0, b1);
01374                 <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01375             } <span class="keywordflow">else</span> {
01376                 <span class="comment">/*</span>
01377 <span class="comment">                 * This is an Ethernet type, so compare</span>
01378 <span class="comment">                 * the length/type field with it (if</span>
01379 <span class="comment">                 * the frame is an 802.2 frame, the length</span>
01380 <span class="comment">                 * field will be &lt;= ETHERMTU, and, as</span>
01381 <span class="comment">                 * "proto" is &gt; ETHERMTU, this test</span>
01382 <span class="comment">                 * will fail and the frame won't match,</span>
01383 <span class="comment">                 * which is what we want).</span>
01384 <span class="comment">                 */</span>
01385                 <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H,
01386                     (bpf_int32)proto);
01387             }
01388         }
01389         <span class="keywordflow">break</span>;
01390 
01391     <span class="keywordflow">case</span> DLT_SLIP:
01392     <span class="keywordflow">case</span> DLT_SLIP_BSDOS:
01393     <span class="keywordflow">case</span> DLT_RAW:
01394         <span class="comment">/*</span>
01395 <span class="comment">         * These types don't provide any type field; packets</span>
01396 <span class="comment">         * are always IP.</span>
01397 <span class="comment">         *</span>
01398 <span class="comment">         * XXX - for IPv4, check for a version number of 4, and,</span>
01399 <span class="comment">         * for IPv6, check for a version number of 6?</span>
01400 <span class="comment">         */</span>
01401         <span class="keywordflow">switch</span> (proto) {
01402 
01403         <span class="keywordflow">case</span> ETHERTYPE_IP:
01404 <span class="preprocessor">#ifdef INET6</span>
01405 <span class="preprocessor"></span>        <span class="keywordflow">case</span> ETHERTYPE_IPV6:
01406 <span class="preprocessor">#endif</span>
01407 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a82">gen_true</a>();      <span class="comment">/* always true */</span>
01408 
01409         <span class="keywordflow">default</span>:
01410             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a83">gen_false</a>();     <span class="comment">/* always false */</span>
01411         }
01412         <span class="keywordflow">break</span>;
01413 
01414     <span class="keywordflow">case</span> DLT_PPP:
01415     <span class="keywordflow">case</span> DLT_PPP_SERIAL:
01416     <span class="keywordflow">case</span> DLT_PPP_ETHER:
01417         <span class="comment">/*</span>
01418 <span class="comment">         * We use Ethernet protocol types inside libpcap;</span>
01419 <span class="comment">         * map them to the corresponding PPP protocol types.</span>
01420 <span class="comment">         */</span>
01421         <span class="keywordflow">switch</span> (proto) {
01422 
01423         <span class="keywordflow">case</span> ETHERTYPE_IP:
01424             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_IP;
01425             <span class="keywordflow">break</span>;
01426 
01427 <span class="preprocessor">#ifdef INET6</span>
01428 <span class="preprocessor"></span>        <span class="keywordflow">case</span> ETHERTYPE_IPV6:
01429             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_IPV6;
01430             <span class="keywordflow">break</span>;
01431 <span class="preprocessor">#endif</span>
01432 <span class="preprocessor"></span>
01433         <span class="keywordflow">case</span> ETHERTYPE_DN:
01434             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_DECNET;
01435             <span class="keywordflow">break</span>;
01436 
01437         <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01438             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_APPLE;
01439             <span class="keywordflow">break</span>;
01440 
01441         <span class="keywordflow">case</span> ETHERTYPE_NS:
01442             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_NS;
01443             <span class="keywordflow">break</span>;
01444 
01445         <span class="keywordflow">case</span> LLCSAP_ISONS:
01446             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_OSI;
01447             <span class="keywordflow">break</span>;
01448 
01449         <span class="keywordflow">case</span> LLCSAP_8021D:
01450             <span class="comment">/*</span>
01451 <span class="comment">             * I'm assuming the "Bridging PDU"s that go</span>
01452 <span class="comment">             * over PPP are Spanning Tree Protocol</span>
01453 <span class="comment">             * Bridging PDUs.</span>
01454 <span class="comment">             */</span>
01455             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_BRPDU;
01456             <span class="keywordflow">break</span>;
01457 
01458         <span class="keywordflow">case</span> LLCSAP_IPX:
01459             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_IPX;
01460             <span class="keywordflow">break</span>;
01461         }
01462         <span class="keywordflow">break</span>;
01463 
01464     <span class="keywordflow">case</span> DLT_PPP_BSDOS:
01465         <span class="comment">/*</span>
01466 <span class="comment">         * We use Ethernet protocol types inside libpcap;</span>
01467 <span class="comment">         * map them to the corresponding PPP protocol types.</span>
01468 <span class="comment">         */</span>
01469         <span class="keywordflow">switch</span> (proto) {
01470 
01471         <span class="keywordflow">case</span> ETHERTYPE_IP:
01472             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, PPP_IP);
01473             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, PPP_VJC);
01474             gen_or(b0, b1);
01475             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, PPP_VJNC);
01476             gen_or(b1, b0);
01477             <span class="keywordflow">return</span> b0;
01478 
01479 <span class="preprocessor">#ifdef INET6</span>
01480 <span class="preprocessor"></span>        <span class="keywordflow">case</span> ETHERTYPE_IPV6:
01481             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_IPV6;
01482             <span class="comment">/* more to go? */</span>
01483             <span class="keywordflow">break</span>;
01484 <span class="preprocessor">#endif</span>
01485 <span class="preprocessor"></span>
01486         <span class="keywordflow">case</span> ETHERTYPE_DN:
01487             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_DECNET;
01488             <span class="keywordflow">break</span>;
01489 
01490         <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01491             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_APPLE;
01492             <span class="keywordflow">break</span>;
01493 
01494         <span class="keywordflow">case</span> ETHERTYPE_NS:
01495             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_NS;
01496             <span class="keywordflow">break</span>;
01497 
01498         <span class="keywordflow">case</span> LLCSAP_ISONS:
01499             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_OSI;
01500             <span class="keywordflow">break</span>;
01501 
01502         <span class="keywordflow">case</span> LLCSAP_8021D:
01503             <span class="comment">/*</span>
01504 <span class="comment">             * I'm assuming the "Bridging PDU"s that go</span>
01505 <span class="comment">             * over PPP are Spanning Tree Protocol</span>
01506 <span class="comment">             * Bridging PDUs.</span>
01507 <span class="comment">             */</span>
01508             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_BRPDU;
01509             <span class="keywordflow">break</span>;
01510 
01511         <span class="keywordflow">case</span> LLCSAP_IPX:
01512             <a class="code" href="gencode_8c.html#a46">proto</a> = PPP_IPX;
01513             <span class="keywordflow">break</span>;
01514         }
01515         <span class="keywordflow">break</span>;
01516 
01517     <span class="keywordflow">case</span> DLT_NULL:
01518     <span class="keywordflow">case</span> DLT_LOOP:
01519         <span class="comment">/*</span>
01520 <span class="comment">         * For DLT_NULL, the link-layer header is a 32-bit</span>
01521 <span class="comment">         * word containing an AF_ value in *host* byte order.</span>
01522 <span class="comment">         *</span>
01523 <span class="comment">         * In addition, if we're reading a saved capture file,</span>
01524 <span class="comment">         * the host byte order in the capture may not be the</span>
01525 <span class="comment">         * same as the host byte order on this machine.</span>
01526 <span class="comment">         *</span>
01527 <span class="comment">         * For DLT_LOOP, the link-layer header is a 32-bit</span>
01528 <span class="comment">         * word containing an AF_ value in *network* byte order.</span>
01529 <span class="comment">         *</span>
01530 <span class="comment">         * XXX - AF_ values may, unfortunately, be platform-</span>
01531 <span class="comment">         * dependent; for example, FreeBSD's AF_INET6 is 24</span>
01532 <span class="comment">         * whilst NetBSD's and OpenBSD's is 26.</span>
01533 <span class="comment">         *</span>
01534 <span class="comment">         * This means that, when reading a capture file, just</span>
01535 <span class="comment">         * checking for our AF_INET6 value won't work if the</span>
01536 <span class="comment">         * capture file came from another OS.</span>
01537 <span class="comment">         */</span>
01538         <span class="keywordflow">switch</span> (proto) {
01539 
01540         <span class="keywordflow">case</span> ETHERTYPE_IP:
01541             <a class="code" href="gencode_8c.html#a46">proto</a> = AF_INET;
01542             <span class="keywordflow">break</span>;
01543 
01544 <span class="preprocessor">#ifdef INET6</span>
01545 <span class="preprocessor"></span>        <span class="keywordflow">case</span> ETHERTYPE_IPV6:
01546             <a class="code" href="gencode_8c.html#a46">proto</a> = AF_INET6;
01547             <span class="keywordflow">break</span>;
01548 <span class="preprocessor">#endif</span>
01549 <span class="preprocessor"></span>
01550         <span class="keywordflow">default</span>:
01551             <span class="comment">/*</span>
01552 <span class="comment">             * Not a type on which we support filtering.</span>
01553 <span class="comment">             * XXX - support those that have AF_ values</span>
01554 <span class="comment">             * #defined on this platform, at least?</span>
01555 <span class="comment">             */</span>
01556             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a83">gen_false</a>();
01557         }
01558 
01559         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_NULL) {
01560             <span class="comment">/*</span>
01561 <span class="comment">             * The AF_ value is in host byte order, but</span>
01562 <span class="comment">             * the BPF interpreter will convert it to</span>
01563 <span class="comment">             * network byte order.</span>
01564 <span class="comment">             *</span>
01565 <span class="comment">             * If this is a save file, and it's from a</span>
01566 <span class="comment">             * machine with the opposite byte order to</span>
01567 <span class="comment">             * ours, we byte-swap the AF_ value.</span>
01568 <span class="comment">             *</span>
01569 <span class="comment">             * Then we run it through "htonl()", and</span>
01570 <span class="comment">             * generate code to compare against the result.</span>
01571 <span class="comment">             */</span>
01572             <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a15">bpf_pcap</a>-&gt;sf.rfile != NULL &amp;&amp;
01573                 <a class="code" href="gencode_8c.html#a15">bpf_pcap</a>-&gt;sf.swapped)
01574                 <a class="code" href="gencode_8c.html#a46">proto</a> = SWAPLONG(proto);
01575             <a class="code" href="gencode_8c.html#a46">proto</a> = htonl(proto);
01576         }
01577         <span class="keywordflow">return</span> (<a class="code" href="gencode_8c.html#a76">gen_cmp</a>(0, BPF_W, (bpf_int32)proto));
01578 
01579     <span class="keywordflow">case</span> DLT_ARCNET:
01580     <span class="keywordflow">case</span> DLT_ARCNET_LINUX:
01581         <span class="comment">/*</span>
01582 <span class="comment">         * XXX should we check for first fragment if the protocol</span>
01583 <span class="comment">         * uses PHDS?</span>
01584 <span class="comment">         */</span>
01585         <span class="keywordflow">switch</span> (proto) {
01586 
01587         <span class="keywordflow">default</span>:
01588             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a83">gen_false</a>();
01589 
01590 <span class="preprocessor">#ifdef INET6</span>
01591 <span class="preprocessor"></span>        <span class="keywordflow">case</span> ETHERTYPE_IPV6:
01592             <span class="keywordflow">return</span> (<a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B,
01593                 (bpf_int32)ARCTYPE_INET6));
01594 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
01595 
01596         <span class="keywordflow">case</span> ETHERTYPE_IP:
01597             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B, 
01598                      (bpf_int32)ARCTYPE_IP);
01599             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B,
01600                      (bpf_int32)ARCTYPE_IP_OLD);
01601             gen_or(b0, b1);
01602             <span class="keywordflow">return</span> (b1);
01603 
01604         <span class="keywordflow">case</span> ETHERTYPE_ARP:
01605             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B,
01606                      (bpf_int32)ARCTYPE_ARP);
01607             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B, 
01608                      (bpf_int32)ARCTYPE_ARP_OLD);
01609             gen_or(b0, b1);
01610             <span class="keywordflow">return</span> (b1);
01611 
01612         <span class="keywordflow">case</span> ETHERTYPE_REVARP:
01613             <span class="keywordflow">return</span> (<a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B,
01614                     (bpf_int32)ARCTYPE_REVARP));
01615 
01616         <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01617             <span class="keywordflow">return</span> (<a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B,
01618                     (bpf_int32)ARCTYPE_ATALK));
01619         }
01620         <span class="keywordflow">break</span>;
01621 
01622     <span class="keywordflow">case</span> DLT_LTALK:
01623         <span class="keywordflow">switch</span> (proto) {
01624         <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01625             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a82">gen_true</a>();
01626         <span class="keywordflow">default</span>:
01627             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a83">gen_false</a>();
01628         }
01629         <span class="keywordflow">break</span>;
01630 
01631     <span class="keywordflow">case</span> DLT_FRELAY:
01632         <span class="comment">/*</span>
01633 <span class="comment">         * XXX - assumes a 2-byte Frame Relay header with</span>
01634 <span class="comment">         * DLCI and flags.  What if the address is longer?</span>
01635 <span class="comment">         */</span>
01636         <span class="keywordflow">switch</span> (proto) {
01637 
01638         <span class="keywordflow">case</span> ETHERTYPE_IP:
01639             <span class="comment">/*</span>
01640 <span class="comment">             * Check for the special NLPID for IP.</span>
01641 <span class="comment">             */</span>
01642             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(2, BPF_H, (0x03&lt;&lt;8) | 0xcc);
01643 
01644 <span class="preprocessor">#ifdef INET6</span>
01645 <span class="preprocessor"></span>        <span class="keywordflow">case</span> ETHERTYPE_IPV6:
01646             <span class="comment">/*</span>
01647 <span class="comment">             * Check for the special NLPID for IPv6.</span>
01648 <span class="comment">             */</span>
01649             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(2, BPF_H, (0x03&lt;&lt;8) | 0x8e);
01650 <span class="preprocessor">#endif</span>
01651 <span class="preprocessor"></span>
01652         <span class="keywordflow">case</span> LLCSAP_ISONS:
01653             <span class="comment">/*</span>
01654 <span class="comment">             * Check for several OSI protocols.</span>
01655 <span class="comment">             *</span>
01656 <span class="comment">             * Frame Relay packets typically have an OSI</span>
01657 <span class="comment">             * NLPID at the beginning; we check for each</span>
01658 <span class="comment">             * of them.</span>
01659 <span class="comment">             *</span>
01660 <span class="comment">             * What we check for is the NLPID and a frame</span>
01661 <span class="comment">             * control field of UI, i.e. 0x03 followed</span>
01662 <span class="comment">             * by the NLPID.</span>
01663 <span class="comment">             */</span>
01664             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(2, BPF_H, (0x03&lt;&lt;8) | ISO8473_CLNP);
01665             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(2, BPF_H, (0x03&lt;&lt;8) | ISO9542_ESIS);
01666             b2 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(2, BPF_H, (0x03&lt;&lt;8) | ISO10589_ISIS);
01667             gen_or(b1, b2);
01668             gen_or(b0, b2);
01669             <span class="keywordflow">return</span> b2;
01670 
01671         <span class="keywordflow">default</span>:
01672             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a83">gen_false</a>();
01673         }
01674         <span class="keywordflow">break</span>;
01675     }
01676 
01677     <span class="comment">/*</span>
01678 <span class="comment">     * All the types that have no encapsulation should either be</span>
01679 <span class="comment">     * handled as DLT_SLIP, DLT_SLIP_BSDOS, and DLT_RAW are, if</span>
01680 <span class="comment">     * all packets are IP packets, or should be handled in some</span>
01681 <span class="comment">     * special case, if none of them are (if some are and some</span>
01682 <span class="comment">     * aren't, the lack of encapsulation is a problem, as we'd</span>
01683 <span class="comment">     * have to find some other way of determining the packet type).</span>
01684 <span class="comment">     *</span>
01685 <span class="comment">     * Therefore, if "off_linktype" is -1, there's an error.</span>
01686 <span class="comment">     */</span>
01687     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a34">off_linktype</a> == -1)
01688         abort();
01689 
01690     <span class="comment">/*</span>
01691 <span class="comment">     * Any type not handled above should always have an Ethernet</span>
01692 <span class="comment">     * type at an offset of "off_linktype".  (PPP is partially</span>
01693 <span class="comment">     * handled above - the protocol type is mapped from the</span>
01694 <span class="comment">     * Ethernet and LLC types we use internally to the corresponding</span>
01695 <span class="comment">     * PPP type - but the PPP type is always specified by a value</span>
01696 <span class="comment">     * at "off_linktype", so we don't have to do the code generation</span>
01697 <span class="comment">     * above.)</span>
01698 <span class="comment">     */</span>
01699     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (bpf_int32)proto);
01700 }
01701 
01702 <span class="comment">/*</span>
01703 <span class="comment"> * Check for an LLC SNAP packet with a given organization code and</span>
01704 <span class="comment"> * protocol type; we check the entire contents of the 802.2 LLC and</span>
01705 <span class="comment"> * snap headers, checking for DSAP and SSAP of SNAP and a control</span>
01706 <span class="comment"> * field of 0x03 in the LLC header, and for the specified organization</span>
01707 <span class="comment"> * code and protocol type in the SNAP header.</span>
01708 <span class="comment"> */</span>
01709 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01710 <a class="code" href="gencode_8c.html#a86">gen_snap</a>(orgcode, <a class="code" href="gencode_8c.html#a44">ptype</a>, <a class="code" href="gencode_8c.html#a30">offset</a>)
01711     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> orgcode;
<a name="l01712"></a><a class="code" href="gencode_8c.html#a44">01712</a>     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a44">ptype</a>;
<a name="l01713"></a><a class="code" href="gencode_8c.html#a30">01713</a>     u_int <a class="code" href="gencode_8c.html#a30">offset</a>;
01714 {
01715     u_char snapblock[8];
01716 
01717     snapblock[0] = LLCSAP_SNAP; <span class="comment">/* DSAP = SNAP */</span>
01718     snapblock[1] = LLCSAP_SNAP; <span class="comment">/* SSAP = SNAP */</span>
01719     snapblock[2] = 0x03;        <span class="comment">/* control = UI */</span>
01720     snapblock[3] = (orgcode &gt;&gt; 16); <span class="comment">/* upper 8 bits of organization code */</span>
01721     snapblock[4] = (orgcode &gt;&gt; 8);  <span class="comment">/* middle 8 bits of organization code */</span>
01722     snapblock[5] = (orgcode &gt;&gt; 0);  <span class="comment">/* lower 8 bits of organization code */</span>
01723     snapblock[6] = (<a class="code" href="gencode_8c.html#a44">ptype</a> &gt;&gt; 8);    <span class="comment">/* upper 8 bits of protocol type */</span>
01724     snapblock[7] = (<a class="code" href="gencode_8c.html#a44">ptype</a> &gt;&gt; 0);    <span class="comment">/* lower 8 bits of protocol type */</span>
01725     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(offset, 8, snapblock);
01726 }
01727 
01728 <span class="comment">/*</span>
01729 <span class="comment"> * Check for a given protocol value assuming an 802.2 LLC header.</span>
01730 <span class="comment"> */</span>
01731 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01732 <a class="code" href="gencode_8c.html#a87">gen_llc</a>(<a class="code" href="gencode_8c.html#a46">proto</a>)
01733     int <a class="code" href="gencode_8c.html#a46">proto</a>;
01734 {
01735     <span class="comment">/*</span>
01736 <span class="comment">     * XXX - handle token-ring variable-length header.</span>
01737 <span class="comment">     */</span>
01738     <span class="keywordflow">switch</span> (proto) {
01739 
01740         <span class="keywordflow">case</span> LLCSAP_IP:
01741         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (<span class="keywordtype">long</span>)
01742                  ((LLCSAP_IP &lt;&lt; 8) | LLCSAP_IP));
01743                 
01744     <span class="keywordflow">case</span> LLCSAP_ISONS:
01745         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (<span class="keywordtype">long</span>)
01746                  ((LLCSAP_ISONS &lt;&lt; 8) | LLCSAP_ISONS));
01747 
01748     <span class="keywordflow">case</span> LLCSAP_NETBEUI:
01749         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_H, (<span class="keywordtype">long</span>)
01750                  ((LLCSAP_NETBEUI &lt;&lt; 8) | LLCSAP_NETBEUI));
01751 
01752     <span class="keywordflow">case</span> LLCSAP_IPX:
01753         <span class="comment">/*</span>
01754 <span class="comment">         * XXX - are there ever SNAP frames for IPX on</span>
01755 <span class="comment">         * non-Ethernet 802.x networks?</span>
01756 <span class="comment">         */</span>
01757         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B, (bpf_int32)LLCSAP_IPX);
01758 
01759     <span class="keywordflow">case</span> ETHERTYPE_ATALK:
01760         <span class="comment">/*</span>
01761 <span class="comment">         * 802.2-encapsulated ETHERTYPE_ATALK packets are</span>
01762 <span class="comment">         * SNAP packets with an organization code of</span>
01763 <span class="comment">         * 0x080007 (Apple, for Appletalk) and a protocol</span>
01764 <span class="comment">         * type of ETHERTYPE_ATALK (Appletalk).</span>
01765 <span class="comment">         *</span>
01766 <span class="comment">         * XXX - check for an organization code of</span>
01767 <span class="comment">         * encapsulated Ethernet as well?</span>
01768 <span class="comment">         */</span>
01769         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a86">gen_snap</a>(0x080007, ETHERTYPE_ATALK, off_linktype);
01770 
01771     <span class="keywordflow">default</span>:
01772         <span class="comment">/*</span>
01773 <span class="comment">         * XXX - we don't have to check for IPX 802.3</span>
01774 <span class="comment">         * here, but should we check for the IPX Ethertype?</span>
01775 <span class="comment">         */</span>
01776         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> &lt;= <a class="code" href="gencode_8c.html#a0">ETHERMTU</a>) {
01777             <span class="comment">/*</span>
01778 <span class="comment">             * This is an LLC SAP value, so check</span>
01779 <span class="comment">             * the DSAP.</span>
01780 <span class="comment">             */</span>
01781             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype, BPF_B, (bpf_int32)proto);
01782         } <span class="keywordflow">else</span> {
01783             <span class="comment">/*</span>
01784 <span class="comment">             * This is an Ethernet type; we assume that it's</span>
01785 <span class="comment">             * unlikely that it'll appear in the right place</span>
01786 <span class="comment">             * at random, and therefore check only the</span>
01787 <span class="comment">             * location that would hold the Ethernet type</span>
01788 <span class="comment">             * in a SNAP frame with an organization code of</span>
01789 <span class="comment">             * 0x000000 (encapsulated Ethernet).</span>
01790 <span class="comment">             *</span>
01791 <span class="comment">             * XXX - if we were to check for the SNAP DSAP and</span>
01792 <span class="comment">             * LSAP, as per XXX, and were also to check for an</span>
01793 <span class="comment">             * organization code of 0x000000 (encapsulated</span>
01794 <span class="comment">             * Ethernet), we'd do</span>
01795 <span class="comment">             *</span>
01796 <span class="comment">             *  return gen_snap(0x000000, proto,</span>
01797 <span class="comment">             *      off_linktype);</span>
01798 <span class="comment">             *</span>
01799 <span class="comment">             * here; for now, we don't, as per the above.</span>
01800 <span class="comment">             * I don't know whether it's worth the extra CPU</span>
01801 <span class="comment">             * time to do the right check or not.</span>
01802 <span class="comment">             */</span>
01803             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_linktype+6, BPF_H, (bpf_int32)proto);
01804         }
01805     }
01806 }
01807 
01808 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01809 <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, <a class="code" href="gencode_8c.html#a29">mask</a>, <a class="code" href="gencode_8c.html#a45">dir</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a47">src_off</a>, <a class="code" href="gencode_8c.html#a48">dst_off</a>)
01810     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> addr;
01811     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a29">mask</a>;
01812     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>, <a class="code" href="gencode_8c.html#a46">proto</a>;
<a name="l01813"></a><a class="code" href="gencode_8c.html#a47">01813</a>     u_int <a class="code" href="gencode_8c.html#a47">src_off</a>, <a class="code" href="gencode_8c.html#a48">dst_off</a>;
01814 {
01815     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
01816     u_int <a class="code" href="gencode_8c.html#a30">offset</a>;
01817 
01818     <span class="keywordflow">switch</span> (dir) {
01819 
01820     <span class="keywordflow">case</span> Q_SRC:
01821         <a class="code" href="gencode_8c.html#a30">offset</a> = <a class="code" href="gencode_8c.html#a47">src_off</a>;
01822         <span class="keywordflow">break</span>;
01823 
01824     <span class="keywordflow">case</span> Q_DST:
01825         <a class="code" href="gencode_8c.html#a30">offset</a> = <a class="code" href="gencode_8c.html#a48">dst_off</a>;
01826         <span class="keywordflow">break</span>;
01827 
01828     <span class="keywordflow">case</span> Q_AND:
01829         b0 = <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, Q_SRC, proto, src_off, dst_off);
01830         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, Q_DST, proto, src_off, dst_off);
01831         gen_and(b0, b1);
01832         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01833 
01834     <span class="keywordflow">case</span> Q_OR:
01835     <span class="keywordflow">case</span> Q_DEFAULT:
01836         b0 = <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, Q_SRC, proto, src_off, dst_off);
01837         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, Q_DST, proto, src_off, dst_off);
01838         gen_or(b0, b1);
01839         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01840 
01841     <span class="keywordflow">default</span>:
01842         abort();
01843     }
01844     b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(proto);
01845     <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(offset, BPF_W, (bpf_int32)addr, mask);
01846     gen_and(b0, b1);
01847     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01848 }
01849 
01850 <span class="preprocessor">#ifdef INET6</span>
01851 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *
01852 gen_hostop6(addr, <a class="code" href="gencode_8c.html#a29">mask</a>, <a class="code" href="gencode_8c.html#a45">dir</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a47">src_off</a>, <a class="code" href="gencode_8c.html#a48">dst_off</a>)
01853     struct in6_addr *addr;
01854     <span class="keyword">struct </span>in6_addr *<a class="code" href="gencode_8c.html#a29">mask</a>;
01855     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>, <a class="code" href="gencode_8c.html#a46">proto</a>;
01856     u_int <a class="code" href="gencode_8c.html#a47">src_off</a>, <a class="code" href="gencode_8c.html#a48">dst_off</a>;
01857 {
01858     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
01859     u_int <a class="code" href="gencode_8c.html#a30">offset</a>;
01860     u_int32_t *a, *m;
01861 
01862     <span class="keywordflow">switch</span> (dir) {
01863 
01864     <span class="keywordflow">case</span> Q_SRC:
01865         <a class="code" href="gencode_8c.html#a30">offset</a> = <a class="code" href="gencode_8c.html#a47">src_off</a>;
01866         <span class="keywordflow">break</span>;
01867 
01868     <span class="keywordflow">case</span> Q_DST:
01869         <a class="code" href="gencode_8c.html#a30">offset</a> = <a class="code" href="gencode_8c.html#a48">dst_off</a>;
01870         <span class="keywordflow">break</span>;
01871 
01872     <span class="keywordflow">case</span> Q_AND:
01873         b0 = gen_hostop6(addr, mask, Q_SRC, proto, src_off, dst_off);
01874         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_hostop6(addr, mask, Q_DST, proto, src_off, dst_off);
01875         gen_and(b0, b1);
01876         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01877 
01878     <span class="keywordflow">case</span> Q_OR:
01879     <span class="keywordflow">case</span> Q_DEFAULT:
01880         b0 = gen_hostop6(addr, mask, Q_SRC, proto, src_off, dst_off);
01881         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_hostop6(addr, mask, Q_DST, proto, src_off, dst_off);
01882         gen_or(b0, b1);
01883         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01884 
01885     <span class="keywordflow">default</span>:
01886         abort();
01887     }
01888     <span class="comment">/* this order is important */</span>
01889     a = (u_int32_t *)addr;
01890     m = (u_int32_t *)<a class="code" href="gencode_8c.html#a29">mask</a>;
01891     <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(offset + 12, BPF_W, ntohl(a[3]), ntohl(m[3]));
01892     b0 = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(offset + 8, BPF_W, ntohl(a[2]), ntohl(m[2]));
01893     gen_and(b0, b1);
01894     b0 = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(offset + 4, BPF_W, ntohl(a[1]), ntohl(m[1]));
01895     gen_and(b0, b1);
01896     b0 = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(offset + 0, BPF_W, ntohl(a[0]), ntohl(m[0]));
01897     gen_and(b0, b1);
01898     b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(proto);
01899     gen_and(b0, b1);
01900     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01901 }
01902 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
01903 
01904 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01905 <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, <a class="code" href="gencode_8c.html#a45">dir</a>)
01906     register const u_char *eaddr;
01907     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
01908 {
01909     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
01910 
01911     <span class="keywordflow">switch</span> (dir) {
01912     <span class="keywordflow">case</span> Q_SRC:
01913         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(off_mac + 6, 6, eaddr);
01914 
01915     <span class="keywordflow">case</span> Q_DST:
01916         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(off_mac + 0, 6, eaddr);
01917 
01918     <span class="keywordflow">case</span> Q_AND:
01919         b0 = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, Q_SRC);
01920         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, Q_DST);
01921         gen_and(b0, b1);
01922         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01923 
01924     <span class="keywordflow">case</span> Q_DEFAULT:
01925     <span class="keywordflow">case</span> Q_OR:
01926         b0 = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, Q_SRC);
01927         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, Q_DST);
01928         gen_or(b0, b1);
01929         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01930     }
01931     abort();
01932     <span class="comment">/* NOTREACHED */</span>
01933 }
01934 
01935 <span class="comment">/*</span>
01936 <span class="comment"> * Like gen_ehostop, but for DLT_FDDI</span>
01937 <span class="comment"> */</span>
01938 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01939 <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, <a class="code" href="gencode_8c.html#a45">dir</a>)
01940     register const u_char *eaddr;
01941     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
01942 {
01943     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
01944 
01945     <span class="keywordflow">switch</span> (dir) {
01946     <span class="keywordflow">case</span> Q_SRC:
01947 <span class="preprocessor">#ifdef PCAP_FDDIPAD</span>
01948 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(6 + 1 + pcap_fddipad, 6, eaddr);
01949 <span class="preprocessor">#else</span>
01950 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(6 + 1, 6, eaddr);
01951 <span class="preprocessor">#endif</span>
01952 <span class="preprocessor"></span>
01953     <span class="keywordflow">case</span> Q_DST:
01954 <span class="preprocessor">#ifdef PCAP_FDDIPAD</span>
01955 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(0 + 1 + pcap_fddipad, 6, eaddr);
01956 <span class="preprocessor">#else</span>
01957 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(0 + 1, 6, eaddr);
01958 <span class="preprocessor">#endif</span>
01959 <span class="preprocessor"></span>
01960     <span class="keywordflow">case</span> Q_AND:
01961         b0 = <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, Q_SRC);
01962         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, Q_DST);
01963         gen_and(b0, b1);
01964         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01965 
01966     <span class="keywordflow">case</span> Q_DEFAULT:
01967     <span class="keywordflow">case</span> Q_OR:
01968         b0 = <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, Q_SRC);
01969         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, Q_DST);
01970         gen_or(b0, b1);
01971         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01972     }
01973     abort();
01974     <span class="comment">/* NOTREACHED */</span>
01975 }
01976 
01977 <span class="comment">/*</span>
01978 <span class="comment"> * Like gen_ehostop, but for DLT_IEEE802 (Token Ring)</span>
01979 <span class="comment"> */</span>
01980 <span class="keyword">static</span> <span class="keyword">struct </span>block *
01981 <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, <a class="code" href="gencode_8c.html#a45">dir</a>)
01982     register const u_char *eaddr;
01983     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
01984 {
01985     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
01986 
01987     <span class="keywordflow">switch</span> (dir) {
01988     <span class="keywordflow">case</span> Q_SRC:
01989         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(8, 6, eaddr);
01990 
01991     <span class="keywordflow">case</span> Q_DST:
01992         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(2, 6, eaddr);
01993 
01994     <span class="keywordflow">case</span> Q_AND:
01995         b0 = <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, Q_SRC);
01996         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, Q_DST);
01997         gen_and(b0, b1);
01998         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
01999 
02000     <span class="keywordflow">case</span> Q_DEFAULT:
02001     <span class="keywordflow">case</span> Q_OR:
02002         b0 = <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, Q_SRC);
02003         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, Q_DST);
02004         gen_or(b0, b1);
02005         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02006     }
02007     abort();
02008     <span class="comment">/* NOTREACHED */</span>
02009 }
02010 
02011 <span class="comment">/*</span>
02012 <span class="comment"> * Like gen_ehostop, but for DLT_IEEE802_11 (802.11 wireless LAN)</span>
02013 <span class="comment"> */</span>
02014 <span class="keyword">static</span> <span class="keyword">struct </span>block *
02015 <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, <a class="code" href="gencode_8c.html#a45">dir</a>)
02016     register const u_char *eaddr;
02017     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
02018 {
02019     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *b2;
02020     <span class="keyword">register</span> <span class="keyword">struct </span>slist *s;
02021 
02022     <span class="keywordflow">switch</span> (dir) {
02023     <span class="keywordflow">case</span> Q_SRC:
02024         <span class="comment">/*</span>
02025 <span class="comment">         * Oh, yuk.</span>
02026 <span class="comment">         *</span>
02027 <span class="comment">         *  For control frames, there is no SA.</span>
02028 <span class="comment">         *</span>
02029 <span class="comment">         *  For management frames, SA is at an</span>
02030 <span class="comment">         *  offset of 10 from the beginning of</span>
02031 <span class="comment">         *  the packet.</span>
02032 <span class="comment">         *</span>
02033 <span class="comment">         *  For data frames, SA is at an offset</span>
02034 <span class="comment">         *  of 10 from the beginning of the packet</span>
02035 <span class="comment">         *  if From DS is clear, at an offset of</span>
02036 <span class="comment">         *  16 from the beginning of the packet</span>
02037 <span class="comment">         *  if From DS is set and To DS is clear,</span>
02038 <span class="comment">         *  and an offset of 24 from the beginning</span>
02039 <span class="comment">         *  of the packet if From DS is set and To DS</span>
02040 <span class="comment">         *  is set.</span>
02041 <span class="comment">         */</span>
02042 
02043         <span class="comment">/*</span>
02044 <span class="comment">         * Generate the tests to be done for data frames</span>
02045 <span class="comment">         * with From DS set.</span>
02046 <span class="comment">         *</span>
02047 <span class="comment">         * First, check for To DS set, i.e. check "link[1] &amp; 0x01".</span>
02048 <span class="comment">         */</span>
02049         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02050         s-&gt;s.k = 1;
02051         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02052         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x01; <span class="comment">/* To DS */</span>
02053         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02054 
02055         <span class="comment">/*</span>
02056 <span class="comment">         * If To DS is set, the SA is at 24.</span>
02057 <span class="comment">         */</span>
02058         b0 = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(24, 6, eaddr);
02059         gen_and(b1, b0);
02060 
02061         <span class="comment">/*</span>
02062 <span class="comment">         * Now, check for To DS not set, i.e. check</span>
02063 <span class="comment">         * "!(link[1] &amp; 0x01)".</span>
02064 <span class="comment">         */</span>
02065         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02066         s-&gt;s.k = 1;
02067         b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02068         b2-&gt;s.k = 0x01; <span class="comment">/* To DS */</span>
02069         b2-&gt;stmts = s;
02070         gen_not(b2);
02071 
02072         <span class="comment">/*</span>
02073 <span class="comment">         * If To DS is not set, the SA is at 16.</span>
02074 <span class="comment">         */</span>
02075         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(16, 6, eaddr);
02076         gen_and(b2, b1);
02077 
02078         <span class="comment">/*</span>
02079 <span class="comment">         * Now OR together the last two checks.  That gives</span>
02080 <span class="comment">         * the complete set of checks for data frames with</span>
02081 <span class="comment">         * From DS set.</span>
02082 <span class="comment">         */</span>
02083         gen_or(b1, b0);
02084 
02085         <span class="comment">/*</span>
02086 <span class="comment">         * Now check for From DS being set, and AND that with</span>
02087 <span class="comment">         * the ORed-together checks.</span>
02088 <span class="comment">         */</span>
02089         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02090         s-&gt;s.k = 1;
02091         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02092         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x02; <span class="comment">/* From DS */</span>
02093         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02094         gen_and(b1, b0);
02095 
02096         <span class="comment">/*</span>
02097 <span class="comment">         * Now check for data frames with From DS not set.</span>
02098 <span class="comment">         */</span>
02099         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02100         s-&gt;s.k = 1;
02101         b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02102         b2-&gt;s.k = 0x02; <span class="comment">/* From DS */</span>
02103         b2-&gt;stmts = s;
02104         gen_not(b2);
02105 
02106         <span class="comment">/*</span>
02107 <span class="comment">         * If From DS isn't set, the SA is at 10.</span>
02108 <span class="comment">         */</span>
02109         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(10, 6, eaddr);
02110         gen_and(b2, b1);
02111 
02112         <span class="comment">/*</span>
02113 <span class="comment">         * Now OR together the checks for data frames with</span>
02114 <span class="comment">         * From DS not set and for data frames with From DS</span>
02115 <span class="comment">         * set; that gives the checks done for data frames.</span>
02116 <span class="comment">         */</span>
02117         gen_or(b1, b0);
02118 
02119         <span class="comment">/*</span>
02120 <span class="comment">         * Now check for a data frame.</span>
02121 <span class="comment">         * I.e, check "link[0] &amp; 0x08".</span>
02122 <span class="comment">         */</span>
02123         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02124         s-&gt;s.k = 0;
02125         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02126         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x08;
02127         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02128 
02129         <span class="comment">/*</span>
02130 <span class="comment">         * AND that with the checks done for data frames.</span>
02131 <span class="comment">         */</span>
02132         gen_and(b1, b0);
02133 
02134         <span class="comment">/*</span>
02135 <span class="comment">         * If the high-order bit of the type value is 0, this</span>
02136 <span class="comment">         * is a management frame.</span>
02137 <span class="comment">         * I.e, check "!(link[0] &amp; 0x08)".</span>
02138 <span class="comment">         */</span>
02139         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02140         s-&gt;s.k = 0;
02141         b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02142         b2-&gt;s.k = 0x08;
02143         b2-&gt;stmts = s;
02144         gen_not(b2);
02145 
02146         <span class="comment">/*</span>
02147 <span class="comment">         * For management frames, the SA is at 10.</span>
02148 <span class="comment">         */</span>
02149         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(10, 6, eaddr);
02150         gen_and(b2, b1);
02151 
02152         <span class="comment">/*</span>
02153 <span class="comment">         * OR that with the checks done for data frames.</span>
02154 <span class="comment">         * That gives the checks done for management and</span>
02155 <span class="comment">         * data frames.</span>
02156 <span class="comment">         */</span>
02157         gen_or(b1, b0);
02158 
02159         <span class="comment">/*</span>
02160 <span class="comment">         * If the low-order bit of the type value is 1,</span>
02161 <span class="comment">         * this is either a control frame or a frame</span>
02162 <span class="comment">         * with a reserved type, and thus not a</span>
02163 <span class="comment">         * frame with an SA.</span>
02164 <span class="comment">         *</span>
02165 <span class="comment">         * I.e., check "!(link[0] &amp; 0x04)".</span>
02166 <span class="comment">         */</span>
02167         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02168         s-&gt;s.k = 0;
02169         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02170         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x04;
02171         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02172         gen_not(b1);
02173 
02174         <span class="comment">/*</span>
02175 <span class="comment">         * AND that with the checks for data and management</span>
02176 <span class="comment">         * frames.</span>
02177 <span class="comment">         */</span>
02178         gen_and(b1, b0);
02179         <span class="keywordflow">return</span> b0;
02180 
02181     <span class="keywordflow">case</span> Q_DST:
02182         <span class="comment">/*</span>
02183 <span class="comment">         * Oh, yuk.</span>
02184 <span class="comment">         *</span>
02185 <span class="comment">         *  For control frames, there is no DA.</span>
02186 <span class="comment">         *</span>
02187 <span class="comment">         *  For management frames, DA is at an</span>
02188 <span class="comment">         *  offset of 4 from the beginning of</span>
02189 <span class="comment">         *  the packet.</span>
02190 <span class="comment">         *</span>
02191 <span class="comment">         *  For data frames, DA is at an offset</span>
02192 <span class="comment">         *  of 4 from the beginning of the packet</span>
02193 <span class="comment">         *  if To DS is clear and at an offset of</span>
02194 <span class="comment">         *  16 from the beginning of the packet</span>
02195 <span class="comment">         *  if To DS is set.</span>
02196 <span class="comment">         */</span>
02197 
02198         <span class="comment">/*</span>
02199 <span class="comment">         * Generate the tests to be done for data frames.</span>
02200 <span class="comment">         *</span>
02201 <span class="comment">         * First, check for To DS set, i.e. "link[1] &amp; 0x01".</span>
02202 <span class="comment">         */</span>
02203         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02204         s-&gt;s.k = 1;
02205         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02206         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x01; <span class="comment">/* To DS */</span>
02207         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02208 
02209         <span class="comment">/*</span>
02210 <span class="comment">         * If To DS is set, the DA is at 16.</span>
02211 <span class="comment">         */</span>
02212         b0 = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(16, 6, eaddr);
02213         gen_and(b1, b0);
02214 
02215         <span class="comment">/*</span>
02216 <span class="comment">         * Now, check for To DS not set, i.e. check</span>
02217 <span class="comment">         * "!(link[1] &amp; 0x01)".</span>
02218 <span class="comment">         */</span>
02219         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02220         s-&gt;s.k = 1;
02221         b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02222         b2-&gt;s.k = 0x01; <span class="comment">/* To DS */</span>
02223         b2-&gt;stmts = s;
02224         gen_not(b2);
02225 
02226         <span class="comment">/*</span>
02227 <span class="comment">         * If To DS is not set, the DA is at 4.</span>
02228 <span class="comment">         */</span>
02229         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(4, 6, eaddr);
02230         gen_and(b2, b1);
02231 
02232         <span class="comment">/*</span>
02233 <span class="comment">         * Now OR together the last two checks.  That gives</span>
02234 <span class="comment">         * the complete set of checks for data frames.</span>
02235 <span class="comment">         */</span>
02236         gen_or(b1, b0);
02237 
02238         <span class="comment">/*</span>
02239 <span class="comment">         * Now check for a data frame.</span>
02240 <span class="comment">         * I.e, check "link[0] &amp; 0x08".</span>
02241 <span class="comment">         */</span>
02242         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02243         s-&gt;s.k = 0;
02244         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02245         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x08;
02246         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02247 
02248         <span class="comment">/*</span>
02249 <span class="comment">         * AND that with the checks done for data frames.</span>
02250 <span class="comment">         */</span>
02251         gen_and(b1, b0);
02252 
02253         <span class="comment">/*</span>
02254 <span class="comment">         * If the high-order bit of the type value is 0, this</span>
02255 <span class="comment">         * is a management frame.</span>
02256 <span class="comment">         * I.e, check "!(link[0] &amp; 0x08)".</span>
02257 <span class="comment">         */</span>
02258         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02259         s-&gt;s.k = 0;
02260         b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02261         b2-&gt;s.k = 0x08;
02262         b2-&gt;stmts = s;
02263         gen_not(b2);
02264 
02265         <span class="comment">/*</span>
02266 <span class="comment">         * For management frames, the DA is at 4.</span>
02267 <span class="comment">         */</span>
02268         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(4, 6, eaddr);
02269         gen_and(b2, b1);
02270 
02271         <span class="comment">/*</span>
02272 <span class="comment">         * OR that with the checks done for data frames.</span>
02273 <span class="comment">         * That gives the checks done for management and</span>
02274 <span class="comment">         * data frames.</span>
02275 <span class="comment">         */</span>
02276         gen_or(b1, b0);
02277 
02278         <span class="comment">/*</span>
02279 <span class="comment">         * If the low-order bit of the type value is 1,</span>
02280 <span class="comment">         * this is either a control frame or a frame</span>
02281 <span class="comment">         * with a reserved type, and thus not a</span>
02282 <span class="comment">         * frame with an SA.</span>
02283 <span class="comment">         *</span>
02284 <span class="comment">         * I.e., check "!(link[0] &amp; 0x04)".</span>
02285 <span class="comment">         */</span>
02286         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
02287         s-&gt;s.k = 0;
02288         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02289         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x04;
02290         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
02291         gen_not(b1);
02292 
02293         <span class="comment">/*</span>
02294 <span class="comment">         * AND that with the checks for data and management</span>
02295 <span class="comment">         * frames.</span>
02296 <span class="comment">         */</span>
02297         gen_and(b1, b0);
02298         <span class="keywordflow">return</span> b0;
02299 
02300     <span class="keywordflow">case</span> Q_AND:
02301         b0 = <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, Q_SRC);
02302         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, Q_DST);
02303         gen_and(b0, b1);
02304         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02305 
02306     <span class="keywordflow">case</span> Q_DEFAULT:
02307     <span class="keywordflow">case</span> Q_OR:
02308         b0 = <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, Q_SRC);
02309         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, Q_DST);
02310         gen_or(b0, b1);
02311         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02312     }
02313     abort();
02314     <span class="comment">/* NOTREACHED */</span>
02315 }
02316 
02317 <span class="comment">/*</span>
02318 <span class="comment"> * Like gen_ehostop, but for RFC 2625 IP-over-Fibre-Channel.</span>
02319 <span class="comment"> * (We assume that the addresses are IEEE 48-bit MAC addresses,</span>
02320 <span class="comment"> * as the RFC states.)</span>
02321 <span class="comment"> */</span>
02322 <span class="keyword">static</span> <span class="keyword">struct </span>block *
02323 <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, <a class="code" href="gencode_8c.html#a45">dir</a>)
02324     register const u_char *eaddr;
02325     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
02326 {
02327     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
02328 
02329     <span class="keywordflow">switch</span> (dir) {
02330     <span class="keywordflow">case</span> Q_SRC:
02331         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(10, 6, eaddr);
02332 
02333     <span class="keywordflow">case</span> Q_DST:
02334         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(2, 6, eaddr);
02335 
02336     <span class="keywordflow">case</span> Q_AND:
02337         b0 = <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, Q_SRC);
02338         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, Q_DST);
02339         gen_and(b0, b1);
02340         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02341 
02342     <span class="keywordflow">case</span> Q_DEFAULT:
02343     <span class="keywordflow">case</span> Q_OR:
02344         b0 = <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, Q_SRC);
02345         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, Q_DST);
02346         gen_or(b0, b1);
02347         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02348     }
02349     abort();
02350     <span class="comment">/* NOTREACHED */</span>
02351 }
02352 
02353 <span class="comment">/*</span>
02354 <span class="comment"> * This is quite tricky because there may be pad bytes in front of the</span>
02355 <span class="comment"> * DECNET header, and then there are two possible data packet formats that</span>
02356 <span class="comment"> * carry both src and dst addresses, plus 5 packet types in a format that</span>
02357 <span class="comment"> * carries only the src node, plus 2 types that use a different format and</span>
02358 <span class="comment"> * also carry just the src node.</span>
02359 <span class="comment"> *</span>
02360 <span class="comment"> * Yuck.</span>
02361 <span class="comment"> *</span>
02362 <span class="comment"> * Instead of doing those all right, we just look for data packets with</span>
02363 <span class="comment"> * 0 or 1 bytes of padding.  If you want to look at other packets, that</span>
02364 <span class="comment"> * will require a lot more hacking.</span>
02365 <span class="comment"> *</span>
02366 <span class="comment"> * To add support for filtering on DECNET "areas" (network numbers)</span>
02367 <span class="comment"> * one would want to add a "mask" argument to this routine.  That would</span>
02368 <span class="comment"> * make the filter even more inefficient, although one could be clever</span>
02369 <span class="comment"> * and not generate masking instructions if the mask is 0xFFFF.</span>
02370 <span class="comment"> */</span>
02371 <span class="keyword">static</span> <span class="keyword">struct </span>block *
02372 <a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(addr, <a class="code" href="gencode_8c.html#a45">dir</a>, <a class="code" href="gencode_8c.html#a49">base_off</a>)
02373     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> addr;
02374     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
<a name="l02375"></a><a class="code" href="gencode_8c.html#a49">02375</a>     u_int <a class="code" href="gencode_8c.html#a49">base_off</a>;
02376 {
02377     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *b2, *tmp;
02378     u_int offset_lh;    <span class="comment">/* offset if long header is received */</span>
02379     u_int offset_sh;    <span class="comment">/* offset if short header is received */</span>
02380 
02381     <span class="keywordflow">switch</span> (dir) {
02382 
02383     <span class="keywordflow">case</span> Q_DST:
02384         offset_sh = 1;  <span class="comment">/* follows flags */</span>
02385         offset_lh = 7;  <span class="comment">/* flgs,darea,dsubarea,HIORD */</span>
02386         <span class="keywordflow">break</span>;
02387 
02388     <span class="keywordflow">case</span> Q_SRC:
02389         offset_sh = 3;  <span class="comment">/* follows flags, dstnode */</span>
02390         offset_lh = 15; <span class="comment">/* flgs,darea,dsubarea,did,sarea,ssub,HIORD */</span>
02391         <span class="keywordflow">break</span>;
02392 
02393     <span class="keywordflow">case</span> Q_AND:
02394         <span class="comment">/* Inefficient because we do our Calvinball dance twice */</span>
02395         b0 = <a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(addr, Q_SRC, base_off);
02396         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(addr, Q_DST, base_off);
02397         gen_and(b0, b1);
02398         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02399 
02400     <span class="keywordflow">case</span> Q_OR:
02401     <span class="keywordflow">case</span> Q_DEFAULT:
02402         <span class="comment">/* Inefficient because we do our Calvinball dance twice */</span>
02403         b0 = <a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(addr, Q_SRC, base_off);
02404         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(addr, Q_DST, base_off);
02405         gen_or(b0, b1);
02406         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02407 
02408     <span class="keywordflow">case</span> Q_ISO:
02409             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ISO host filtering not implemented"</span>);
02410 
02411     <span class="keywordflow">default</span>:
02412         abort();
02413     }
02414     b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_DN);
02415     <span class="comment">/* Check for pad = 1, long header case */</span>
02416     tmp = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(base_off + 2, BPF_H,
02417         (bpf_int32)ntohs(0x0681), (bpf_int32)ntohs(0x07FF));
02418     <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(base_off + 2 + 1 + offset_lh,
02419         BPF_H, (bpf_int32)ntohs(addr));
02420     gen_and(tmp, b1);
02421     <span class="comment">/* Check for pad = 0, long header case */</span>
02422     tmp = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(base_off + 2, BPF_B, (bpf_int32)0x06, (bpf_int32)0x7);
02423     b2 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(base_off + 2 + offset_lh, BPF_H, (bpf_int32)ntohs(addr));
02424     gen_and(tmp, b2);
02425     gen_or(b2, b1);
02426     <span class="comment">/* Check for pad = 1, short header case */</span>
02427     tmp = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(base_off + 2, BPF_H,
02428         (bpf_int32)ntohs(0x0281), (bpf_int32)ntohs(0x07FF));
02429     b2 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(base_off + 2 + 1 + offset_sh,
02430         BPF_H, (bpf_int32)ntohs(addr));
02431     gen_and(tmp, b2);
02432     gen_or(b2, b1);
02433     <span class="comment">/* Check for pad = 0, short header case */</span>
02434     tmp = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(base_off + 2, BPF_B, (bpf_int32)0x02, (bpf_int32)0x7);
02435     b2 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(base_off + 2 + offset_sh, BPF_H, (bpf_int32)ntohs(addr));
02436     gen_and(tmp, b2);
02437     gen_or(b2, b1);
02438 
02439     <span class="comment">/* Combine with test for linktype */</span>
02440     gen_and(b0, b1);
02441     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02442 }
02443 
02444 <span class="keyword">static</span> <span class="keyword">struct </span>block *
02445 <a class="code" href="gencode_8c.html#a96">gen_host</a>(addr, <a class="code" href="gencode_8c.html#a29">mask</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
02446     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> addr;
<a name="l02447"></a><a class="code" href="gencode_8c.html#a29">02447</a>     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a29">mask</a>;
02448     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a>;
02449     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
02450 {
02451     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
02452 
02453     <span class="keywordflow">switch</span> (proto) {
02454 
02455     <span class="keywordflow">case</span> Q_DEFAULT:
02456         b0 = <a class="code" href="gencode_8c.html#a96">gen_host</a>(addr, mask, Q_IP, dir);
02457         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a34">off_linktype</a> != -1) {
02458             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a96">gen_host</a>(addr, mask, Q_ARP, dir);
02459             gen_or(b0, b1);
02460             b0 = <a class="code" href="gencode_8c.html#a96">gen_host</a>(addr, mask, Q_RARP, dir);
02461             gen_or(b1, b0);
02462         }
02463         <span class="keywordflow">return</span> b0;
02464 
02465     <span class="keywordflow">case</span> Q_IP:
02466         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, dir, ETHERTYPE_IP,
02467                   off_nl + 12, off_nl + 16);
02468 
02469     <span class="keywordflow">case</span> Q_RARP:
02470         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, dir, ETHERTYPE_REVARP,
02471                   off_nl + 14, off_nl + 24);
02472 
02473     <span class="keywordflow">case</span> Q_ARP:
02474         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a88">gen_hostop</a>(addr, mask, dir, ETHERTYPE_ARP,
02475                   off_nl + 14, off_nl + 24);
02476 
02477     <span class="keywordflow">case</span> Q_TCP:
02478         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'tcp' modifier applied to host"</span>);
02479 
02480     <span class="keywordflow">case</span> Q_SCTP:
02481         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'sctp' modifier applied to host"</span>);
02482 
02483     <span class="keywordflow">case</span> Q_UDP:
02484         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'udp' modifier applied to host"</span>);
02485 
02486     <span class="keywordflow">case</span> Q_ICMP:
02487         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'icmp' modifier applied to host"</span>);
02488 
02489     <span class="keywordflow">case</span> Q_IGMP:
02490         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'igmp' modifier applied to host"</span>);
02491 
02492     <span class="keywordflow">case</span> Q_IGRP:
02493         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'igrp' modifier applied to host"</span>);
02494 
02495     <span class="keywordflow">case</span> Q_PIM:
02496         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'pim' modifier applied to host"</span>);
02497 
02498     <span class="keywordflow">case</span> Q_VRRP:
02499         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'vrrp' modifier applied to host"</span>);
02500 
02501     <span class="keywordflow">case</span> Q_ATALK:
02502         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ATALK host filtering not implemented"</span>);
02503 
02504     <span class="keywordflow">case</span> Q_AARP:
02505         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"AARP host filtering not implemented"</span>);
02506 
02507     <span class="keywordflow">case</span> Q_DECNET:
02508         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a95">gen_dnhostop</a>(addr, dir, off_nl);
02509 
02510     <span class="keywordflow">case</span> Q_SCA:
02511         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"SCA host filtering not implemented"</span>);
02512 
02513     <span class="keywordflow">case</span> Q_LAT:
02514         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"LAT host filtering not implemented"</span>);
02515 
02516     <span class="keywordflow">case</span> Q_MOPDL:
02517         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"MOPDL host filtering not implemented"</span>);
02518 
02519     <span class="keywordflow">case</span> Q_MOPRC:
02520         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"MOPRC host filtering not implemented"</span>);
02521 
02522 <span class="preprocessor">#ifdef INET6</span>
02523 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IPV6:
02524         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ip6' modifier applied to ip host"</span>);
02525 
02526     <span class="keywordflow">case</span> Q_ICMPV6:
02527         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'icmp6' modifier applied to host"</span>);
02528 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
02529 
02530     <span class="keywordflow">case</span> Q_AH:
02531         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ah' modifier applied to host"</span>);
02532 
02533     <span class="keywordflow">case</span> Q_ESP:
02534         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'esp' modifier applied to host"</span>);
02535 
02536     <span class="keywordflow">case</span> Q_ISO:
02537         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ISO host filtering not implemented"</span>);
02538 
02539     <span class="keywordflow">case</span> Q_ESIS:
02540         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'esis' modifier applied to host"</span>);
02541 
02542     <span class="keywordflow">case</span> Q_ISIS:
02543         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'isis' modifier applied to host"</span>);
02544 
02545     <span class="keywordflow">case</span> Q_CLNP:
02546         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'clnp' modifier applied to host"</span>);
02547 
02548     <span class="keywordflow">case</span> Q_STP:
02549         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'stp' modifier applied to host"</span>);
02550 
02551     <span class="keywordflow">case</span> Q_IPX:
02552         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"IPX host filtering not implemented"</span>);
02553 
02554     <span class="keywordflow">case</span> Q_NETBEUI:
02555         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'netbeui' modifier applied to host"</span>);
02556 
02557     <span class="keywordflow">default</span>:
02558         abort();
02559     }
02560     <span class="comment">/* NOTREACHED */</span>
02561 }
02562 
02563 <span class="preprocessor">#ifdef INET6</span>
02564 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *
02565 gen_host6(addr, <a class="code" href="gencode_8c.html#a29">mask</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
02566     struct in6_addr *addr;
02567     <span class="keyword">struct </span>in6_addr *<a class="code" href="gencode_8c.html#a29">mask</a>;
02568     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a>;
02569     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
02570 {
02571     <span class="keywordflow">switch</span> (proto) {
02572 
02573     <span class="keywordflow">case</span> Q_DEFAULT:
02574         <span class="keywordflow">return</span> gen_host6(addr, mask, Q_IPV6, dir);
02575 
02576     <span class="keywordflow">case</span> Q_IP:
02577         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ip' modifier applied to ip6 host"</span>);
02578 
02579     <span class="keywordflow">case</span> Q_RARP:
02580         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'rarp' modifier applied to ip6 host"</span>);
02581 
02582     <span class="keywordflow">case</span> Q_ARP:
02583         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'arp' modifier applied to ip6 host"</span>);
02584 
02585     <span class="keywordflow">case</span> Q_SCTP:
02586         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'sctp' modifier applied to host"</span>);
02587 
02588     <span class="keywordflow">case</span> Q_TCP:
02589         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'tcp' modifier applied to host"</span>);
02590 
02591     <span class="keywordflow">case</span> Q_UDP:
02592         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'udp' modifier applied to host"</span>);
02593 
02594     <span class="keywordflow">case</span> Q_ICMP:
02595         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'icmp' modifier applied to host"</span>);
02596 
02597     <span class="keywordflow">case</span> Q_IGMP:
02598         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'igmp' modifier applied to host"</span>);
02599 
02600     <span class="keywordflow">case</span> Q_IGRP:
02601         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'igrp' modifier applied to host"</span>);
02602 
02603     <span class="keywordflow">case</span> Q_PIM:
02604         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'pim' modifier applied to host"</span>);
02605 
02606     <span class="keywordflow">case</span> Q_VRRP:
02607         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'vrrp' modifier applied to host"</span>);
02608 
02609     <span class="keywordflow">case</span> Q_ATALK:
02610         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ATALK host filtering not implemented"</span>);
02611 
02612     <span class="keywordflow">case</span> Q_AARP:
02613         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"AARP host filtering not implemented"</span>);
02614 
02615     <span class="keywordflow">case</span> Q_DECNET:
02616         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'decnet' modifier applied to ip6 host"</span>);
02617 
02618     <span class="keywordflow">case</span> Q_SCA:
02619         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"SCA host filtering not implemented"</span>);
02620 
02621     <span class="keywordflow">case</span> Q_LAT:
02622         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"LAT host filtering not implemented"</span>);
02623 
02624     <span class="keywordflow">case</span> Q_MOPDL:
02625         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"MOPDL host filtering not implemented"</span>);
02626 
02627     <span class="keywordflow">case</span> Q_MOPRC:
02628         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"MOPRC host filtering not implemented"</span>);
02629 
02630     <span class="keywordflow">case</span> Q_IPV6:
02631         <span class="keywordflow">return</span> gen_hostop6(addr, mask, dir, ETHERTYPE_IPV6,
02632                   off_nl + 8, off_nl + 24);
02633 
02634     <span class="keywordflow">case</span> Q_ICMPV6:
02635         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'icmp6' modifier applied to host"</span>);
02636 
02637     <span class="keywordflow">case</span> Q_AH:
02638         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ah' modifier applied to host"</span>);
02639 
02640     <span class="keywordflow">case</span> Q_ESP:
02641         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'esp' modifier applied to host"</span>);
02642 
02643     <span class="keywordflow">case</span> Q_ISO:
02644         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ISO host filtering not implemented"</span>);
02645 
02646     <span class="keywordflow">case</span> Q_ESIS:
02647         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'esis' modifier applied to host"</span>);
02648 
02649     <span class="keywordflow">case</span> Q_ISIS:
02650         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'isis' modifier applied to host"</span>);
02651 
02652     <span class="keywordflow">case</span> Q_CLNP:
02653         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'clnp' modifier applied to host"</span>);
02654 
02655     <span class="keywordflow">case</span> Q_STP:
02656         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'stp' modifier applied to host"</span>);
02657 
02658     <span class="keywordflow">case</span> Q_IPX:
02659         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"IPX host filtering not implemented"</span>);
02660 
02661     <span class="keywordflow">case</span> Q_NETBEUI:
02662         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'netbeui' modifier applied to host"</span>);
02663 
02664     <span class="keywordflow">default</span>:
02665         abort();
02666     }
02667     <span class="comment">/* NOTREACHED */</span>
02668 }
02669 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
02670 
02671 <span class="preprocessor">#ifndef INET6</span>
02672 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *
02673 <a class="code" href="gencode_8c.html#a97">gen_gateway</a>(eaddr, <a class="code" href="gencode_8c.html#a50">alist</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
02674     const u_char *eaddr;
<a name="l02675"></a><a class="code" href="gencode_8c.html#a50">02675</a>     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> **<a class="code" href="gencode_8c.html#a50">alist</a>;
02676     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a>;
02677     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
02678 {
02679     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *tmp;
02680 
02681     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a45">dir</a> != 0)
02682         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"direction applied to 'gateway'"</span>);
02683 
02684     <span class="keywordflow">switch</span> (proto) {
02685     <span class="keywordflow">case</span> Q_DEFAULT:
02686     <span class="keywordflow">case</span> Q_IP:
02687     <span class="keywordflow">case</span> Q_ARP:
02688     <span class="keywordflow">case</span> Q_RARP:
02689         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_EN10MB)
02690             b0 = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, Q_OR);
02691         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_FDDI)
02692             b0 = <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, Q_OR);
02693         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802)
02694             b0 = <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, Q_OR);
02695         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802_11)
02696             b0 = <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, Q_OR);
02697         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_SUNATM &amp;&amp; <a class="code" href="gencode_8c.html#a36">is_lane</a>) {
02698             <span class="comment">/*</span>
02699 <span class="comment">             * Check that the packet doesn't begin with an</span>
02700 <span class="comment">             * LE Control marker.  (We've already generated</span>
02701 <span class="comment">             * a test for LANE.)</span>
02702 <span class="comment">             */</span>
02703             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(SUNATM_PKT_BEGIN_POS, BPF_H, 0xFF00);
02704             gen_not(b1);
02705 
02706             <span class="comment">/*</span>
02707 <span class="comment">             * Now check the MAC address.</span>
02708 <span class="comment">             */</span>
02709             b0 = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, Q_OR);
02710             gen_and(b1, b0);
02711         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IP_OVER_FC)
02712             b0 = <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, Q_OR);
02713         <span class="keywordflow">else</span>
02714             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
02715                 <span class="stringliteral">"'gateway' supported only on ethernet/FDDI/token ring/802.11/Fibre Channel"</span>);
02716 
02717         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a96">gen_host</a>(**alist++, 0xffffffff, proto, Q_OR);
02718         <span class="keywordflow">while</span> (*alist) {
02719             tmp = <a class="code" href="gencode_8c.html#a96">gen_host</a>(**alist++, 0xffffffff, proto, Q_OR);
02720             gen_or(b1, tmp);
02721             <a class="code" href="gencode_8c.html#a26">b1</a> = tmp;
02722         }
02723         gen_not(b1);
02724         gen_and(b0, b1);
02725         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02726     }
02727     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"illegal modifier of 'gateway'"</span>);
02728     <span class="comment">/* NOTREACHED */</span>
02729 }
02730 <span class="preprocessor">#endif</span>
02731 <span class="preprocessor"></span>
02732 <span class="keyword">struct </span>block *
02733 gen_proto_abbrev(<a class="code" href="gencode_8c.html#a46">proto</a>)
02734     int <a class="code" href="gencode_8c.html#a46">proto</a>;
02735 {
02736     <span class="keyword">struct </span>block *b0;
02737         <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a26">b1</a>;
02738 
02739     <span class="keywordflow">switch</span> (proto) {
02740 
02741     <span class="keywordflow">case</span> Q_SCTP:
02742         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_SCTP, Q_IP, Q_DEFAULT);
02743 <span class="preprocessor">#ifdef INET6</span>
02744 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_SCTP, Q_IPV6, Q_DEFAULT);
02745         gen_or(b0, b1);
02746 <span class="preprocessor">#endif</span>
02747 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02748 
02749     <span class="keywordflow">case</span> Q_TCP:
02750         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_TCP, Q_IP, Q_DEFAULT);
02751 <span class="preprocessor">#ifdef INET6</span>
02752 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_TCP, Q_IPV6, Q_DEFAULT);
02753         gen_or(b0, b1);
02754 <span class="preprocessor">#endif</span>
02755 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02756 
02757     <span class="keywordflow">case</span> Q_UDP:
02758         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_UDP, Q_IP, Q_DEFAULT);
02759 <span class="preprocessor">#ifdef INET6</span>
02760 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_UDP, Q_IPV6, Q_DEFAULT);
02761         gen_or(b0, b1);
02762 <span class="preprocessor">#endif</span>
02763 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02764 
02765     <span class="keywordflow">case</span> Q_ICMP:
02766         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_ICMP, Q_IP, Q_DEFAULT);
02767         <span class="keywordflow">break</span>;
02768 
02769 <span class="preprocessor">#ifndef IPPROTO_IGMP</span>
02770 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_IGMP    2</span>
02771 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02772 <span class="preprocessor"></span>
02773     <span class="keywordflow">case</span> Q_IGMP:
02774         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_IGMP, Q_IP, Q_DEFAULT);
02775         <span class="keywordflow">break</span>;
02776 
02777 <span class="preprocessor">#ifndef IPPROTO_IGRP</span>
02778 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_IGRP    9</span>
02779 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02780 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IGRP:
02781         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_IGRP, Q_IP, Q_DEFAULT);
02782         <span class="keywordflow">break</span>;
02783 
02784 <span class="preprocessor">#ifndef IPPROTO_PIM</span>
02785 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_PIM 103</span>
02786 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02787 <span class="preprocessor"></span>
02788     <span class="keywordflow">case</span> Q_PIM:
02789         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_PIM, Q_IP, Q_DEFAULT);
02790 <span class="preprocessor">#ifdef INET6</span>
02791 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_PIM, Q_IPV6, Q_DEFAULT);
02792         gen_or(b0, b1);
02793 <span class="preprocessor">#endif</span>
02794 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02795 
02796 <span class="preprocessor">#ifndef IPPROTO_VRRP</span>
02797 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_VRRP    112</span>
02798 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02799 <span class="preprocessor"></span>
02800     <span class="keywordflow">case</span> Q_VRRP:
02801         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_VRRP, Q_IP, Q_DEFAULT);
02802         <span class="keywordflow">break</span>;
02803 
02804     <span class="keywordflow">case</span> Q_IP:
02805         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IP);
02806         <span class="keywordflow">break</span>;
02807 
02808     <span class="keywordflow">case</span> Q_ARP:
02809         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_ARP);
02810         <span class="keywordflow">break</span>;
02811 
02812     <span class="keywordflow">case</span> Q_RARP:
02813         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_REVARP);
02814         <span class="keywordflow">break</span>;
02815 
02816     <span class="keywordflow">case</span> Q_LINK:
02817         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"link layer applied in wrong context"</span>);
02818 
02819     <span class="keywordflow">case</span> Q_ATALK:
02820         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_ATALK);
02821         <span class="keywordflow">break</span>;
02822 
02823     <span class="keywordflow">case</span> Q_AARP:
02824         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_AARP);
02825         <span class="keywordflow">break</span>;
02826 
02827     <span class="keywordflow">case</span> Q_DECNET:
02828         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_DN);
02829         <span class="keywordflow">break</span>;
02830 
02831     <span class="keywordflow">case</span> Q_SCA:
02832         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_SCA);
02833         <span class="keywordflow">break</span>;
02834 
02835     <span class="keywordflow">case</span> Q_LAT:
02836         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_LAT);
02837         <span class="keywordflow">break</span>;
02838 
02839     <span class="keywordflow">case</span> Q_MOPDL:
02840         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_MOPDL);
02841         <span class="keywordflow">break</span>;
02842 
02843     <span class="keywordflow">case</span> Q_MOPRC:
02844         <a class="code" href="gencode_8c.html#a26">b1</a> =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_MOPRC);
02845         <span class="keywordflow">break</span>;
02846 
02847 <span class="preprocessor">#ifdef INET6</span>
02848 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IPV6:
02849         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IPV6);
02850         <span class="keywordflow">break</span>;
02851 
02852 <span class="preprocessor">#ifndef IPPROTO_ICMPV6</span>
02853 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_ICMPV6  58</span>
02854 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02855 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_ICMPV6:
02856         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_ICMPV6, Q_IPV6, Q_DEFAULT);
02857         <span class="keywordflow">break</span>;
02858 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
02859 
02860 <span class="preprocessor">#ifndef IPPROTO_AH</span>
02861 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_AH  51</span>
02862 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02863 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_AH:
02864         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_AH, Q_IP, Q_DEFAULT);
02865 <span class="preprocessor">#ifdef INET6</span>
02866 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_AH, Q_IPV6, Q_DEFAULT);
02867         gen_or(b0, b1);
02868 <span class="preprocessor">#endif</span>
02869 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02870 
02871 <span class="preprocessor">#ifndef IPPROTO_ESP</span>
02872 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_ESP 50</span>
02873 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02874 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_ESP:
02875         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_ESP, Q_IP, Q_DEFAULT);
02876 <span class="preprocessor">#ifdef INET6</span>
02877 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(IPPROTO_ESP, Q_IPV6, Q_DEFAULT);
02878         gen_or(b0, b1);
02879 <span class="preprocessor">#endif</span>
02880 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
02881 
02882     <span class="keywordflow">case</span> Q_ISO:
02883             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_ISONS);
02884         <span class="keywordflow">break</span>;
02885 
02886     <span class="keywordflow">case</span> Q_ESIS:
02887             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISO9542_ESIS, Q_ISO, Q_DEFAULT);
02888         <span class="keywordflow">break</span>;
02889 
02890     <span class="keywordflow">case</span> Q_ISIS:
02891             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISO10589_ISIS, Q_ISO, Q_DEFAULT);
02892         <span class="keywordflow">break</span>;
02893 
02894     <span class="keywordflow">case</span> Q_ISIS_L1: <span class="comment">/* all IS-IS Level1 PDU-Types */</span>
02895             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_LAN_IIH, Q_ISIS, Q_DEFAULT);
02896             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_PTP_IIH, Q_ISIS, Q_DEFAULT); <span class="comment">/* FIXME extract the circuit-type bits */</span>
02897         gen_or(b0, b1);
02898             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_LSP, Q_ISIS, Q_DEFAULT);
02899         gen_or(b0, b1);
02900             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_CSNP, Q_ISIS, Q_DEFAULT);
02901         gen_or(b0, b1);
02902             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_PSNP, Q_ISIS, Q_DEFAULT);
02903         gen_or(b0, b1);
02904         <span class="keywordflow">break</span>;
02905 
02906     <span class="keywordflow">case</span> Q_ISIS_L2: <span class="comment">/* all IS-IS Level2 PDU-Types */</span>
02907             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_LAN_IIH, Q_ISIS, Q_DEFAULT);
02908             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_PTP_IIH, Q_ISIS, Q_DEFAULT); <span class="comment">/* FIXME extract the circuit-type bits */</span>
02909         gen_or(b0, b1);
02910             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_LSP, Q_ISIS, Q_DEFAULT);
02911         gen_or(b0, b1);
02912             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_CSNP, Q_ISIS, Q_DEFAULT);
02913         gen_or(b0, b1);
02914             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_PSNP, Q_ISIS, Q_DEFAULT);
02915         gen_or(b0, b1);
02916         <span class="keywordflow">break</span>;
02917 
02918     <span class="keywordflow">case</span> Q_ISIS_IIH: <span class="comment">/* all IS-IS Hello PDU-Types */</span>
02919             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_LAN_IIH, Q_ISIS, Q_DEFAULT);
02920             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_LAN_IIH, Q_ISIS, Q_DEFAULT);
02921         gen_or(b0, b1);
02922             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_PTP_IIH, Q_ISIS, Q_DEFAULT);                
02923                 gen_or(b0, b1);
02924         <span class="keywordflow">break</span>;
02925 
02926     <span class="keywordflow">case</span> Q_ISIS_LSP: 
02927             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_LSP, Q_ISIS, Q_DEFAULT);
02928             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_LSP, Q_ISIS, Q_DEFAULT);
02929         gen_or(b0, b1);
02930         <span class="keywordflow">break</span>;
02931 
02932     <span class="keywordflow">case</span> Q_ISIS_SNP:
02933             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_CSNP, Q_ISIS, Q_DEFAULT);
02934             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_CSNP, Q_ISIS, Q_DEFAULT);
02935         gen_or(b0, b1);
02936             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_PSNP, Q_ISIS, Q_DEFAULT);
02937         gen_or(b0, b1);
02938             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_PSNP, Q_ISIS, Q_DEFAULT);
02939         gen_or(b0, b1);
02940         <span class="keywordflow">break</span>;
02941 
02942     <span class="keywordflow">case</span> Q_ISIS_CSNP:
02943             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_PSNP, Q_ISIS, Q_DEFAULT);
02944             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_PSNP, Q_ISIS, Q_DEFAULT);
02945         gen_or(b0, b1);
02946         <span class="keywordflow">break</span>;
02947 
02948     <span class="keywordflow">case</span> Q_ISIS_PSNP:
02949             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L1_PSNP, Q_ISIS, Q_DEFAULT);
02950             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISIS_L2_PSNP, Q_ISIS, Q_DEFAULT);
02951         gen_or(b0, b1);
02952         <span class="keywordflow">break</span>;
02953 
02954     <span class="keywordflow">case</span> Q_CLNP:
02955             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISO8473_CLNP, Q_ISO, Q_DEFAULT);
02956         <span class="keywordflow">break</span>;
02957 
02958     <span class="keywordflow">case</span> Q_STP:
02959             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_8021D);
02960         <span class="keywordflow">break</span>;
02961 
02962     <span class="keywordflow">case</span> Q_IPX:
02963             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_IPX);
02964         <span class="keywordflow">break</span>;
02965 
02966     <span class="keywordflow">case</span> Q_NETBEUI:
02967             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_NETBEUI);
02968         <span class="keywordflow">break</span>;
02969 
02970     <span class="keywordflow">default</span>:
02971         abort();
02972     }
02973     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
02974 }
02975 
02976 <span class="keyword">static</span> <span class="keyword">struct </span>block *
02977 <a class="code" href="gencode_8c.html#a98">gen_ipfrag</a>()
02978 {
02979     <span class="keyword">struct </span>slist *s;
02980     <span class="keyword">struct </span>block *b;
02981 
02982     <span class="comment">/* not ip frag */</span>
02983     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_H|BPF_ABS);
02984     s-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a> + 6;
02985     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
02986     b-&gt;s.k = 0x1fff;
02987     b-&gt;stmts = s;
02988     gen_not(b);
02989 
02990     <span class="keywordflow">return</span> b;
02991 }
02992 
02993 <span class="keyword">static</span> <span class="keyword">struct </span>block *
02994 <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(off, <a class="code" href="gencode_8c.html#a28">v</a>)
02995     int off;
02996     <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> <a class="code" href="gencode_8c.html#a28">v</a>;
02997 {
02998     <span class="keyword">struct </span>slist *s;
02999     <span class="keyword">struct </span>block *b;
03000 
03001     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LDX|BPF_MSH|BPF_B);
03002     s-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
03003 
03004     s-&gt;next = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|BPF_H);
03005     s-&gt;next-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a> + off;
03006 
03007     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JEQ));
03008     b-&gt;stmts = s;
03009     b-&gt;s.k = <a class="code" href="gencode_8c.html#a28">v</a>;
03010 
03011     <span class="keywordflow">return</span> b;
03012 }
03013 
03014 <span class="preprocessor">#ifdef INET6</span>
03015 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>block *
03016 gen_portatom6(off, <a class="code" href="gencode_8c.html#a28">v</a>)
03017     int off;
03018     <a class="code" href="group__wpcap__def.html#a0">bpf_int32</a> <a class="code" href="gencode_8c.html#a28">v</a>;
03019 {
03020     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 40 + off, BPF_H, v);
03021 }
03022 <span class="preprocessor">#endif</span><span class="comment">/*INET6*/</span>
03023 
03024 <span class="keyword">struct </span>block *
03025 <a class="code" href="gencode_8c.html#a100">gen_portop</a>(<a class="code" href="rpcapd_8c.html#a8">port</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
03026     int <a class="code" href="rpcapd_8c.html#a8">port</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>;
03027 {
03028     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *tmp;
03029 
03030     <span class="comment">/* ip proto 'proto' */</span>
03031     tmp = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 9, BPF_B, (bpf_int32)proto);
03032     b0 = <a class="code" href="gencode_8c.html#a98">gen_ipfrag</a>();
03033     gen_and(tmp, b0);
03034 
03035     <span class="keywordflow">switch</span> (dir) {
03036     <span class="keywordflow">case</span> Q_SRC:
03037         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(0, (bpf_int32)port);
03038         <span class="keywordflow">break</span>;
03039 
03040     <span class="keywordflow">case</span> Q_DST:
03041         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(2, (bpf_int32)port);
03042         <span class="keywordflow">break</span>;
03043 
03044     <span class="keywordflow">case</span> Q_OR:
03045     <span class="keywordflow">case</span> Q_DEFAULT:
03046         tmp = <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(0, (bpf_int32)port);
03047         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(2, (bpf_int32)port);
03048         gen_or(tmp, b1);
03049         <span class="keywordflow">break</span>;
03050 
03051     <span class="keywordflow">case</span> Q_AND:
03052         tmp = <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(0, (bpf_int32)port);
03053         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a99">gen_portatom</a>(2, (bpf_int32)port);
03054         gen_and(tmp, b1);
03055         <span class="keywordflow">break</span>;
03056 
03057     <span class="keywordflow">default</span>:
03058         abort();
03059     }
03060     gen_and(b0, b1);
03061 
03062     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03063 }
03064 
03065 <span class="keyword">static</span> <span class="keyword">struct </span>block *
03066 <a class="code" href="gencode_8c.html#a101">gen_port</a>(<a class="code" href="rpcapd_8c.html#a8">port</a>, <a class="code" href="gencode_8c.html#a51">ip_proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
03067     int <a class="code" href="rpcapd_8c.html#a8">port</a>;
<a name="l03068"></a><a class="code" href="gencode_8c.html#a51">03068</a>     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a51">ip_proto</a>;
03069     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
03070 {
03071     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *tmp;
03072 
03073         <span class="keywordflow">switch</span> (linktype) {
03074         <span class="keywordflow">case</span> DLT_IEEE802_11:
03075         <span class="keywordflow">case</span> DLT_PRISM_HEADER:
03076     <span class="keywordflow">case</span> DLT_IEEE802_11_RADIO:
03077         <span class="keywordflow">case</span> DLT_FDDI:
03078         <span class="keywordflow">case</span> DLT_IEEE802:
03079         <span class="keywordflow">case</span> DLT_ATM_RFC1483:
03080         <span class="keywordflow">case</span> DLT_ATM_CLIP:
03081                 b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_IP);
03082                 <span class="keywordflow">break</span>;
03083         <span class="keywordflow">default</span>:
03084                 b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IP);
03085                 <span class="keywordflow">break</span>;
03086         }
03087 
03088     <span class="keywordflow">switch</span> (ip_proto) {
03089     <span class="keywordflow">case</span> IPPROTO_UDP:
03090     <span class="keywordflow">case</span> IPPROTO_TCP:
03091     <span class="keywordflow">case</span> <a class="code" href="gencode_8c.html#a1">IPPROTO_SCTP</a>:
03092         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a100">gen_portop</a>(port, ip_proto, dir);
03093         <span class="keywordflow">break</span>;
03094 
03095     <span class="keywordflow">case</span> PROTO_UNDEF:
03096         tmp = <a class="code" href="gencode_8c.html#a100">gen_portop</a>(port, IPPROTO_TCP, dir);
03097         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a100">gen_portop</a>(port, IPPROTO_UDP, dir);
03098         gen_or(tmp, b1);
03099         tmp = <a class="code" href="gencode_8c.html#a100">gen_portop</a>(port, IPPROTO_SCTP, dir);
03100         gen_or(tmp, b1);
03101         <span class="keywordflow">break</span>;
03102 
03103     <span class="keywordflow">default</span>:
03104         abort();
03105     }
03106     gen_and(b0, b1);
03107     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03108 }
03109 
03110 <span class="preprocessor">#ifdef INET6</span>
03111 <span class="preprocessor"></span><span class="keyword">struct </span>block *
03112 gen_portop6(<a class="code" href="rpcapd_8c.html#a8">port</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
03113     int <a class="code" href="rpcapd_8c.html#a8">port</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>;
03114 {
03115     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *tmp;
03116 
03117     <span class="comment">/* ip proto 'proto' */</span>
03118     b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 6, BPF_B, (bpf_int32)proto);
03119 
03120     <span class="keywordflow">switch</span> (dir) {
03121     <span class="keywordflow">case</span> Q_SRC:
03122         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_portatom6(0, (bpf_int32)port);
03123         <span class="keywordflow">break</span>;
03124 
03125     <span class="keywordflow">case</span> Q_DST:
03126         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_portatom6(2, (bpf_int32)port);
03127         <span class="keywordflow">break</span>;
03128 
03129     <span class="keywordflow">case</span> Q_OR:
03130     <span class="keywordflow">case</span> Q_DEFAULT:
03131         tmp = gen_portatom6(0, (bpf_int32)port);
03132         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_portatom6(2, (bpf_int32)port);
03133         gen_or(tmp, b1);
03134         <span class="keywordflow">break</span>;
03135 
03136     <span class="keywordflow">case</span> Q_AND:
03137         tmp = gen_portatom6(0, (bpf_int32)port);
03138         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_portatom6(2, (bpf_int32)port);
03139         gen_and(tmp, b1);
03140         <span class="keywordflow">break</span>;
03141 
03142     <span class="keywordflow">default</span>:
03143         abort();
03144     }
03145     gen_and(b0, b1);
03146 
03147     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03148 }
03149 
03150 <span class="keyword">static</span> <span class="keyword">struct </span>block *
03151 gen_port6(<a class="code" href="rpcapd_8c.html#a8">port</a>, <a class="code" href="gencode_8c.html#a51">ip_proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
03152     int <a class="code" href="rpcapd_8c.html#a8">port</a>;
03153     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a51">ip_proto</a>;
03154     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
03155 {
03156     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *tmp;
03157 
03158     <span class="comment">/* ether proto ip */</span>
03159     b0 =  <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IPV6);
03160 
03161     <span class="keywordflow">switch</span> (ip_proto) {
03162     <span class="keywordflow">case</span> IPPROTO_UDP:
03163     <span class="keywordflow">case</span> IPPROTO_TCP:
03164     <span class="keywordflow">case</span> <a class="code" href="gencode_8c.html#a1">IPPROTO_SCTP</a>:
03165         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_portop6(port, ip_proto, dir);
03166         <span class="keywordflow">break</span>;
03167 
03168     <span class="keywordflow">case</span> PROTO_UNDEF:
03169         tmp = gen_portop6(port, IPPROTO_TCP, dir);
03170         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_portop6(port, IPPROTO_UDP, dir);
03171         gen_or(tmp, b1);
03172         tmp = gen_portop6(port, IPPROTO_SCTP, dir);
03173         gen_or(tmp, b1);
03174         <span class="keywordflow">break</span>;
03175 
03176     <span class="keywordflow">default</span>:
03177         abort();
03178     }
03179     gen_and(b0, b1);
03180     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03181 }
03182 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
03183 
03184 <span class="keyword">static</span> <span class="keywordtype">int</span>
03185 <a class="code" href="gencode_8c.html#a102">lookup_proto</a>(name, proto)
03186     <span class="keyword">register</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *name;
03187     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a>;
03188 {
03189     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a28">v</a>;
03190 
03191     <span class="keywordflow">switch</span> (proto) {
03192 
03193     <span class="keywordflow">case</span> Q_DEFAULT:
03194     <span class="keywordflow">case</span> Q_IP:
03195     <span class="keywordflow">case</span> Q_IPV6:
03196         <a class="code" href="gencode_8c.html#a28">v</a> = pcap_nametoproto(name);
03197         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a28">v</a> == PROTO_UNDEF)
03198             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown ip proto '%s'"</span>, name);
03199         <span class="keywordflow">break</span>;
03200 
03201     <span class="keywordflow">case</span> Q_LINK:
03202         <span class="comment">/* XXX should look up h/w protocol type based on linktype */</span>
03203         <a class="code" href="gencode_8c.html#a28">v</a> = pcap_nametoeproto(name);
03204         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a28">v</a> == PROTO_UNDEF)
03205             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown ether proto '%s'"</span>, name);
03206         <span class="keywordflow">break</span>;
03207 
03208     <span class="keywordflow">case</span> Q_ISO:
03209         <span class="keywordflow">if</span> (strcmp(name, <span class="stringliteral">"esis"</span>) == 0)
03210             <a class="code" href="gencode_8c.html#a28">v</a> = ISO9542_ESIS;
03211         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(name, <span class="stringliteral">"isis"</span>) == 0)
03212             <a class="code" href="gencode_8c.html#a28">v</a> = ISO10589_ISIS;
03213         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(name, <span class="stringliteral">"clnp"</span>) == 0)
03214             <a class="code" href="gencode_8c.html#a28">v</a> = ISO8473_CLNP;
03215         <span class="keywordflow">else</span>
03216             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown osi proto '%s'"</span>, name);
03217         <span class="keywordflow">break</span>;
03218 
03219     <span class="keywordflow">default</span>:
03220         <a class="code" href="gencode_8c.html#a28">v</a> = PROTO_UNDEF;
03221         <span class="keywordflow">break</span>;
03222     }
03223     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a28">v</a>;
03224 }
03225 
03226 <span class="preprocessor">#if 0</span>
03227 <span class="preprocessor"></span><span class="keyword">struct </span>stmt *
03228 gen_joinsp(s, <a class="code" href="bpf__image_8c.html#a1">n</a>)
03229     struct stmt **s;
03230     <span class="keywordtype">int</span> <a class="code" href="bpf__image_8c.html#a1">n</a>;
03231 {
03232     <span class="keywordflow">return</span> NULL;
03233 }
03234 <span class="preprocessor">#endif</span>
03235 <span class="preprocessor"></span>
03236 <span class="keyword">static</span> <span class="keyword">struct </span>block *
03237 <a class="code" href="gencode_8c.html#a103">gen_protochain</a>(<a class="code" href="gencode_8c.html#a28">v</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
03238     int <a class="code" href="gencode_8c.html#a28">v</a>;
03239     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a>;
03240     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
03241 {
03242 <span class="preprocessor">#ifdef NO_PROTOCHAIN</span>
03243 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a104">gen_proto</a>(v, proto, dir);
03244 <span class="preprocessor">#else</span>
03245 <span class="preprocessor"></span>    <span class="keyword">struct </span>block *b0, *b;
03246     <span class="keyword">struct </span>slist *s[100];
03247     <span class="keywordtype">int</span> fix2, fix3, fix4, fix5;
03248     <span class="keywordtype">int</span> ahcheck, again, end;
03249     <span class="keywordtype">int</span> i, max;
03250     <span class="keywordtype">int</span> reg2 = <a class="code" href="gencode_8c.html#a66">alloc_reg</a>();
03251 
03252     memset(s, 0, <span class="keyword">sizeof</span>(s));
03253     fix2 = fix3 = fix4 = fix5 = 0;
03254 
03255     <span class="keywordflow">switch</span> (proto) {
03256     <span class="keywordflow">case</span> Q_IP:
03257     <span class="keywordflow">case</span> Q_IPV6:
03258         <span class="keywordflow">break</span>;
03259     <span class="keywordflow">case</span> Q_DEFAULT:
03260         b0 = <a class="code" href="gencode_8c.html#a103">gen_protochain</a>(v, Q_IP, dir);
03261         b = <a class="code" href="gencode_8c.html#a103">gen_protochain</a>(v, Q_IPV6, dir);
03262         gen_or(b0, b);
03263         <span class="keywordflow">return</span> b;
03264     <span class="keywordflow">default</span>:
03265         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"bad protocol applied for 'protochain'"</span>);
03266         <span class="comment">/*NOTREACHED*/</span>
03267     }
03268 
03269     <a class="code" href="gencode_8c.html#a24">no_optimize</a> = 1; <span class="comment">/*this code is not compatible with optimzer yet */</span>
03270 
03271     <span class="comment">/*</span>
03272 <span class="comment">     * s[0] is a dummy entry to protect other BPF insn from damaged</span>
03273 <span class="comment">     * by s[fix] = foo with uninitialized variable "fix".  It is somewhat</span>
03274 <span class="comment">     * hard to find interdependency made by jump table fixup.</span>
03275 <span class="comment">     */</span>
03276     i = 0;
03277     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(0); <span class="comment">/*dummy*/</span>
03278     i++;
03279 
03280     <span class="keywordflow">switch</span> (proto) {
03281     <span class="keywordflow">case</span> Q_IP:
03282         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IP);
03283 
03284         <span class="comment">/* A = ip-&gt;ip_p */</span>
03285         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_ABS|BPF_B);
03286         s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a> + 9;
03287         i++;
03288         <span class="comment">/* X = ip-&gt;ip_hl &lt;&lt; 2 */</span>
03289         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LDX|BPF_MSH|BPF_B);
03290         s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
03291         i++;
03292         <span class="keywordflow">break</span>;
03293 <span class="preprocessor">#ifdef INET6</span>
03294 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IPV6:
03295         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IPV6);
03296 
03297         <span class="comment">/* A = ip6-&gt;ip_nxt */</span>
03298         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_ABS|BPF_B);
03299         s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a> + 6;
03300         i++;
03301         <span class="comment">/* X = sizeof(struct ip6_hdr) */</span>
03302         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LDX|BPF_IMM);
03303         s[i]-&gt;s.k = 40;
03304         i++;
03305         <span class="keywordflow">break</span>;
03306 <span class="preprocessor">#endif</span>
03307 <span class="preprocessor"></span>    <span class="keywordflow">default</span>:
03308         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unsupported proto to gen_protochain"</span>);
03309         <span class="comment">/*NOTREACHED*/</span>
03310     }
03311 
03312     <span class="comment">/* again: if (A == v) goto end; else fall through; */</span>
03313     again = i;
03314     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03315     s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a28">v</a>;
03316     s[i]-&gt;s.jt = NULL;      <span class="comment">/*later*/</span>
03317     s[i]-&gt;s.jf = NULL;      <span class="comment">/*update in next stmt*/</span>
03318     fix5 = i;
03319     i++;
03320 
03321 <span class="preprocessor">#ifndef IPPROTO_NONE</span>
03322 <span class="preprocessor"></span><span class="preprocessor">#define IPPROTO_NONE    59</span>
03323 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03324 <span class="preprocessor"></span>    <span class="comment">/* if (A == IPPROTO_NONE) goto end */</span>
03325     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03326     s[i]-&gt;s.jt = NULL;  <span class="comment">/*later*/</span>
03327     s[i]-&gt;s.jf = NULL;  <span class="comment">/*update in next stmt*/</span>
03328     s[i]-&gt;s.k = IPPROTO_NONE;
03329     s[fix5]-&gt;s.jf = s[i];
03330     fix2 = i;
03331     i++;
03332 
03333 <span class="preprocessor">#ifdef INET6</span>
03334 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_IPV6) {
03335         <span class="keywordtype">int</span> v6start, v6end, v6advance, j;
03336 
03337         v6start = i;
03338         <span class="comment">/* if (A == IPPROTO_HOPOPTS) goto v6advance */</span>
03339         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03340         s[i]-&gt;s.jt = NULL;  <span class="comment">/*later*/</span>
03341         s[i]-&gt;s.jf = NULL;  <span class="comment">/*update in next stmt*/</span>
03342         s[i]-&gt;s.k = IPPROTO_HOPOPTS;
03343         s[fix2]-&gt;s.jf = s[i];
03344         i++;
03345         <span class="comment">/* if (A == IPPROTO_DSTOPTS) goto v6advance */</span>
03346         s[i - 1]-&gt;s.jf = s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03347         s[i]-&gt;s.jt = NULL;  <span class="comment">/*later*/</span>
03348         s[i]-&gt;s.jf = NULL;  <span class="comment">/*update in next stmt*/</span>
03349         s[i]-&gt;s.k = IPPROTO_DSTOPTS;
03350         i++;
03351         <span class="comment">/* if (A == IPPROTO_ROUTING) goto v6advance */</span>
03352         s[i - 1]-&gt;s.jf = s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03353         s[i]-&gt;s.jt = NULL;  <span class="comment">/*later*/</span>
03354         s[i]-&gt;s.jf = NULL;  <span class="comment">/*update in next stmt*/</span>
03355         s[i]-&gt;s.k = IPPROTO_ROUTING;
03356         i++;
03357         <span class="comment">/* if (A == IPPROTO_FRAGMENT) goto v6advance; else goto ahcheck; */</span>
03358         s[i - 1]-&gt;s.jf = s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03359         s[i]-&gt;s.jt = NULL;  <span class="comment">/*later*/</span>
03360         s[i]-&gt;s.jf = NULL;  <span class="comment">/*later*/</span>
03361         s[i]-&gt;s.k = IPPROTO_FRAGMENT;
03362         fix3 = i;
03363         v6end = i;
03364         i++;
03365 
03366         <span class="comment">/* v6advance: */</span>
03367         v6advance = i;
03368 
03369         <span class="comment">/*</span>
03370 <span class="comment">         * in short,</span>
03371 <span class="comment">         * A = P[X];</span>
03372 <span class="comment">         * X = X + (P[X + 1] + 1) * 8;</span>
03373 <span class="comment">         */</span>
03374         <span class="comment">/* A = X */</span>
03375         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TXA);
03376         i++;
03377         <span class="comment">/* A = P[X + packet head] */</span>
03378         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|BPF_B);
03379         s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
03380         i++;
03381         <span class="comment">/* MEM[reg2] = A */</span>
03382         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
03383         s[i]-&gt;s.k = reg2;
03384         i++;
03385         <span class="comment">/* A = X */</span>
03386         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TXA);
03387         i++;
03388         <span class="comment">/* A += 1 */</span>
03389         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_K);
03390         s[i]-&gt;s.k = 1;
03391         i++;
03392         <span class="comment">/* X = A */</span>
03393         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TAX);
03394         i++;
03395         <span class="comment">/* A = P[X + packet head]; */</span>
03396         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|BPF_B);
03397         s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
03398         i++;
03399         <span class="comment">/* A += 1 */</span>
03400         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_K);
03401         s[i]-&gt;s.k = 1;
03402         i++;
03403         <span class="comment">/* A *= 8 */</span>
03404         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_MUL|BPF_K);
03405         s[i]-&gt;s.k = 8;
03406         i++;
03407         <span class="comment">/* X = A; */</span>
03408         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TAX);
03409         i++;
03410         <span class="comment">/* A = MEM[reg2] */</span>
03411         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_MEM);
03412         s[i]-&gt;s.k = reg2;
03413         i++;
03414 
03415         <span class="comment">/* goto again; (must use BPF_JA for backward jump) */</span>
03416         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JA);
03417         s[i]-&gt;s.k = again - i - 1;
03418         s[i - 1]-&gt;s.jf = s[i];
03419         i++;
03420 
03421         <span class="comment">/* fixup */</span>
03422         <span class="keywordflow">for</span> (j = v6start; j &lt;= v6end; j++)
03423             s[j]-&gt;s.jt = s[v6advance];
03424     } <span class="keywordflow">else</span>
03425 <span class="preprocessor">#endif</span>
03426 <span class="preprocessor"></span>    {
03427         <span class="comment">/* nop */</span>
03428         s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_K);
03429         s[i]-&gt;s.k = 0;
03430         s[fix2]-&gt;s.jf = s[i];
03431         i++;
03432     }
03433 
03434     <span class="comment">/* ahcheck: */</span>
03435     ahcheck = i;
03436     <span class="comment">/* if (A == IPPROTO_AH) then fall through; else goto end; */</span>
03437     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JEQ|BPF_K);
03438     s[i]-&gt;s.jt = NULL;  <span class="comment">/*later*/</span>
03439     s[i]-&gt;s.jf = NULL;  <span class="comment">/*later*/</span>
03440     s[i]-&gt;s.k = IPPROTO_AH;
03441     <span class="keywordflow">if</span> (fix3)
03442         s[fix3]-&gt;s.jf = s[ahcheck];
03443     fix4 = i;
03444     i++;
03445 
03446     <span class="comment">/*</span>
03447 <span class="comment">     * in short,</span>
03448 <span class="comment">     * A = P[X];</span>
03449 <span class="comment">     * X = X + (P[X + 1] + 2) * 4;</span>
03450 <span class="comment">     */</span>
03451     <span class="comment">/* A = X */</span>
03452     s[i - 1]-&gt;s.jt = s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TXA);
03453     i++;
03454     <span class="comment">/* A = P[X + packet head]; */</span>
03455     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|BPF_B);
03456     s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
03457     i++;
03458     <span class="comment">/* MEM[reg2] = A */</span>
03459     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
03460     s[i]-&gt;s.k = reg2;
03461     i++;
03462     <span class="comment">/* A = X */</span>
03463     s[i - 1]-&gt;s.jt = s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TXA);
03464     i++;
03465     <span class="comment">/* A += 1 */</span>
03466     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_K);
03467     s[i]-&gt;s.k = 1;
03468     i++;
03469     <span class="comment">/* X = A */</span>
03470     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TAX);
03471     i++;
03472     <span class="comment">/* A = P[X + packet head] */</span>
03473     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|BPF_B);
03474     s[i]-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
03475     i++;
03476     <span class="comment">/* A += 2 */</span>
03477     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_K);
03478     s[i]-&gt;s.k = 2;
03479     i++;
03480     <span class="comment">/* A *= 4 */</span>
03481     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_MUL|BPF_K);
03482     s[i]-&gt;s.k = 4;
03483     i++;
03484     <span class="comment">/* X = A; */</span>
03485     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TAX);
03486     i++;
03487     <span class="comment">/* A = MEM[reg2] */</span>
03488     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_MEM);
03489     s[i]-&gt;s.k = reg2;
03490     i++;
03491 
03492     <span class="comment">/* goto again; (must use BPF_JA for backward jump) */</span>
03493     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_JMP|BPF_JA);
03494     s[i]-&gt;s.k = again - i - 1;
03495     i++;
03496 
03497     <span class="comment">/* end: nop */</span>
03498     end = i;
03499     s[i] = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_K);
03500     s[i]-&gt;s.k = 0;
03501     s[fix2]-&gt;s.jt = s[end];
03502     s[fix4]-&gt;s.jf = s[end];
03503     s[fix5]-&gt;s.jt = s[end];
03504     i++;
03505 
03506     <span class="comment">/*</span>
03507 <span class="comment">     * make slist chain</span>
03508 <span class="comment">     */</span>
03509     max = i;
03510     <span class="keywordflow">for</span> (i = 0; i &lt; max - 1; i++)
03511         s[i]-&gt;next = s[i + 1];
03512     s[max - 1]-&gt;next = NULL;
03513 
03514     <span class="comment">/*</span>
03515 <span class="comment">     * emit final check</span>
03516 <span class="comment">     */</span>
03517     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JEQ));
03518     b-&gt;stmts = s[1];    <span class="comment">/*remember, s[0] is dummy*/</span>
03519     b-&gt;s.k = <a class="code" href="gencode_8c.html#a28">v</a>;
03520 
03521     <a class="code" href="gencode_8c.html#a116">free_reg</a>(reg2);
03522 
03523     gen_and(b0, b);
03524     <span class="keywordflow">return</span> b;
03525 <span class="preprocessor">#endif</span>
03526 <span class="preprocessor"></span>}
03527 
03528 <span class="keyword">static</span> <span class="keyword">struct </span>block *
03529 <a class="code" href="gencode_8c.html#a104">gen_proto</a>(<a class="code" href="gencode_8c.html#a28">v</a>, <a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a45">dir</a>)
03530     int <a class="code" href="gencode_8c.html#a28">v</a>;
<a name="l03531"></a><a class="code" href="gencode_8c.html#a46">03531</a>     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a>;
03532     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
03533 {
03534     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
03535 
03536     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a45">dir</a> != Q_DEFAULT)
03537         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"direction applied to 'proto'"</span>);
03538 
03539     <span class="keywordflow">switch</span> (proto) {
03540     <span class="keywordflow">case</span> Q_DEFAULT:
03541 <span class="preprocessor">#ifdef INET6</span>
03542 <span class="preprocessor"></span>        b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(v, Q_IP, dir);
03543         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(v, Q_IPV6, dir);
03544         gen_or(b0, b1);
03545         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03546 <span class="preprocessor">#else</span>
03547 <span class="preprocessor"></span>        <span class="comment">/*FALLTHROUGH*/</span>
03548 <span class="preprocessor">#endif</span>
03549 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IP:
03550                 <span class="keywordflow">switch</span> (linktype) {
03551                 <span class="keywordflow">case</span> DLT_IEEE802_11:
03552                 <span class="keywordflow">case</span> DLT_PRISM_HEADER:
03553         <span class="keywordflow">case</span> DLT_IEEE802_11_RADIO:
03554                 <span class="keywordflow">case</span> DLT_FDDI:
03555                 <span class="keywordflow">case</span> DLT_IEEE802:
03556                 <span class="keywordflow">case</span> DLT_ATM_RFC1483:
03557                 <span class="keywordflow">case</span> DLT_ATM_CLIP:
03558             b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_IP);
03559                         <span class="keywordflow">break</span>;
03560                 <span class="keywordflow">default</span>:
03561                         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IP);
03562                         <span class="keywordflow">break</span>;
03563                 }
03564 <span class="preprocessor">#ifndef CHASE_CHAIN</span>
03565 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 9, BPF_B, (bpf_int32)v);
03566 <span class="preprocessor">#else</span>
03567 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a103">gen_protochain</a>(v, Q_IP);
03568 <span class="preprocessor">#endif</span>
03569 <span class="preprocessor"></span>        gen_and(b0, b1);
03570         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03571 
03572     <span class="keywordflow">case</span> Q_ISO:
03573         <span class="keywordflow">switch</span> (linktype) {
03574 
03575         <span class="keywordflow">case</span> DLT_FRELAY:
03576             <span class="comment">/*</span>
03577 <span class="comment">             * Frame Relay packets typically have an OSI</span>
03578 <span class="comment">             * NLPID at the beginning; "gen_linktype(LLCSAP_ISONS)"</span>
03579 <span class="comment">             * generates code to check for all the OSI</span>
03580 <span class="comment">             * NLPIDs, so calling it and then adding a check</span>
03581 <span class="comment">             * for the particular NLPID for which we're</span>
03582 <span class="comment">             * looking is bogus, as we can just check for</span>
03583 <span class="comment">             * the NLPID.</span>
03584 <span class="comment">             *</span>
03585 <span class="comment">             * What we check for is the NLPID and a frame</span>
03586 <span class="comment">             * control field value of UI, i.e. 0x03 followed</span>
03587 <span class="comment">             * by the NLPID.</span>
03588 <span class="comment">             *</span>
03589 <span class="comment">             * XXX - assumes a 2-byte Frame Relay header with</span>
03590 <span class="comment">             * DLCI and flags.  What if the address is longer?</span>
03591 <span class="comment">             *</span>
03592 <span class="comment">             * XXX - what about SNAP-encapsulated frames?</span>
03593 <span class="comment">             */</span>
03594             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(2, BPF_H, (0x03&lt;&lt;8) | v);
03595             <span class="keywordflow">break</span>;
03596 
03597                 <span class="keywordflow">case</span> DLT_C_HDLC:
03598                         <span class="comment">/* Cisco uses an Ethertype lookalike - for OSI its 0xfefe */</span>
03599                         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_ISONS&lt;&lt;8 | LLCSAP_ISONS);
03600                         <span class="comment">/* OSI in C-HDLC is stuffed with a fudge byte */</span>
03601             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl_nosnap+1, BPF_B, (<span class="keywordtype">long</span>)v);
03602             gen_and(b0, b1);
03603                         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03604         <span class="keywordflow">default</span>:
03605             b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(LLCSAP_ISONS);
03606             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl_nosnap, BPF_B, (<span class="keywordtype">long</span>)v);
03607             gen_and(b0, b1);
03608             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03609         }
03610 
03611         <span class="keywordflow">case</span> Q_ISIS:
03612             b0 = <a class="code" href="gencode_8c.html#a104">gen_proto</a>(ISO10589_ISIS, Q_ISO, Q_DEFAULT);
03613             <span class="comment">/* 4 is the offset of the PDU type relative to the IS-IS header */</span>
03614             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl_nosnap+4, BPF_B, (<span class="keywordtype">long</span>)v);
03615             gen_and(b0, b1);
03616             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03617 
03618     <span class="keywordflow">case</span> Q_ARP:
03619         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"arp does not encapsulate another protocol"</span>);
03620         <span class="comment">/* NOTREACHED */</span>
03621 
03622     <span class="keywordflow">case</span> Q_RARP:
03623         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"rarp does not encapsulate another protocol"</span>);
03624         <span class="comment">/* NOTREACHED */</span>
03625 
03626     <span class="keywordflow">case</span> Q_ATALK:
03627         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"atalk encapsulation is not specifiable"</span>);
03628         <span class="comment">/* NOTREACHED */</span>
03629 
03630     <span class="keywordflow">case</span> Q_DECNET:
03631         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"decnet encapsulation is not specifiable"</span>);
03632         <span class="comment">/* NOTREACHED */</span>
03633 
03634     <span class="keywordflow">case</span> Q_SCA:
03635         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"sca does not encapsulate another protocol"</span>);
03636         <span class="comment">/* NOTREACHED */</span>
03637 
03638     <span class="keywordflow">case</span> Q_LAT:
03639         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"lat does not encapsulate another protocol"</span>);
03640         <span class="comment">/* NOTREACHED */</span>
03641 
03642     <span class="keywordflow">case</span> Q_MOPRC:
03643         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"moprc does not encapsulate another protocol"</span>);
03644         <span class="comment">/* NOTREACHED */</span>
03645 
03646     <span class="keywordflow">case</span> Q_MOPDL:
03647         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"mopdl does not encapsulate another protocol"</span>);
03648         <span class="comment">/* NOTREACHED */</span>
03649 
03650     <span class="keywordflow">case</span> Q_LINK:
03651         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(v);
03652 
03653     <span class="keywordflow">case</span> Q_UDP:
03654         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'udp proto' is bogus"</span>);
03655         <span class="comment">/* NOTREACHED */</span>
03656 
03657     <span class="keywordflow">case</span> Q_TCP:
03658         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'tcp proto' is bogus"</span>);
03659         <span class="comment">/* NOTREACHED */</span>
03660 
03661     <span class="keywordflow">case</span> Q_SCTP:
03662         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'sctp proto' is bogus"</span>);
03663         <span class="comment">/* NOTREACHED */</span>
03664 
03665     <span class="keywordflow">case</span> Q_ICMP:
03666         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'icmp proto' is bogus"</span>);
03667         <span class="comment">/* NOTREACHED */</span>
03668 
03669     <span class="keywordflow">case</span> Q_IGMP:
03670         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'igmp proto' is bogus"</span>);
03671         <span class="comment">/* NOTREACHED */</span>
03672 
03673     <span class="keywordflow">case</span> Q_IGRP:
03674         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'igrp proto' is bogus"</span>);
03675         <span class="comment">/* NOTREACHED */</span>
03676 
03677     <span class="keywordflow">case</span> Q_PIM:
03678         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'pim proto' is bogus"</span>);
03679         <span class="comment">/* NOTREACHED */</span>
03680 
03681     <span class="keywordflow">case</span> Q_VRRP:
03682         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'vrrp proto' is bogus"</span>);
03683         <span class="comment">/* NOTREACHED */</span>
03684 
03685 <span class="preprocessor">#ifdef INET6</span>
03686 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IPV6:
03687         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IPV6);
03688 <span class="preprocessor">#ifndef CHASE_CHAIN</span>
03689 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 6, BPF_B, (bpf_int32)v);
03690 <span class="preprocessor">#else</span>
03691 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a103">gen_protochain</a>(v, Q_IPV6);
03692 <span class="preprocessor">#endif</span>
03693 <span class="preprocessor"></span>        gen_and(b0, b1);
03694         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
03695 
03696     <span class="keywordflow">case</span> Q_ICMPV6:
03697         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'icmp6 proto' is bogus"</span>);
03698 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
03699 
03700     <span class="keywordflow">case</span> Q_AH:
03701         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ah proto' is bogus"</span>);
03702 
03703     <span class="keywordflow">case</span> Q_ESP:
03704         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ah proto' is bogus"</span>);
03705 
03706     <span class="keywordflow">case</span> Q_STP:
03707         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'stp proto' is bogus"</span>);
03708 
03709     <span class="keywordflow">case</span> Q_IPX:
03710         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ipx proto' is bogus"</span>);
03711 
03712     <span class="keywordflow">case</span> Q_NETBEUI:
03713         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'netbeui proto' is bogus"</span>);
03714 
03715     <span class="keywordflow">default</span>:
03716         abort();
03717         <span class="comment">/* NOTREACHED */</span>
03718     }
03719     <span class="comment">/* NOTREACHED */</span>
03720 }
03721 
03722 <span class="keyword">struct </span>block *
03723 gen_scode(name, <a class="code" href="gencode_8c.html#a52">q</a>)
03724     register const char *name;
03725     <span class="keyword">struct </span>qual <a class="code" href="gencode_8c.html#a52">q</a>;
03726 {
03727     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a> = <a class="code" href="gencode_8c.html#a52">q</a>.proto;
03728     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a> = <a class="code" href="gencode_8c.html#a52">q</a>.dir;
03729     <span class="keywordtype">int</span> tproto;
03730     u_char *eaddr;
03731     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a29">mask</a>, addr;
03732 <span class="preprocessor">#ifndef INET6</span>
03733 <span class="preprocessor"></span>    <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> **<a class="code" href="gencode_8c.html#a50">alist</a>;
03734 <span class="preprocessor">#else</span>
03735 <span class="preprocessor"></span>    <span class="keywordtype">int</span> tproto6;
03736     <span class="keyword">struct </span>sockaddr_in *sin;
03737     <span class="keyword">struct </span>sockaddr_in6 *sin6;
03738     <span class="keyword">struct </span>addrinfo *res, *res0;
03739     <span class="keyword">struct </span>in6_addr mask128;
03740 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
03741     <span class="keyword">struct </span>block *b, *tmp;
03742     <span class="keywordtype">int</span> <a class="code" href="rpcapd_8c.html#a8">port</a>, real_proto;
03743 
03744     <span class="keywordflow">switch</span> (<a class="code" href="gencode_8c.html#a52">q</a>.addr) {
03745 
03746     <span class="keywordflow">case</span> Q_NET:
03747         addr = pcap_nametonetaddr(name);
03748         <span class="keywordflow">if</span> (addr == 0)
03749             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown network '%s'"</span>, name);
03750         <span class="comment">/* Left justify network addr and calculate its network mask */</span>
03751         <a class="code" href="gencode_8c.html#a29">mask</a> = 0xffffffff;
03752         <span class="keywordflow">while</span> (addr &amp;&amp; (addr &amp; 0xff000000) == 0) {
03753             addr &lt;&lt;= 8;
03754             <a class="code" href="gencode_8c.html#a29">mask</a> &lt;&lt;= 8;
03755         }
03756         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a96">gen_host</a>(addr, mask, proto, dir);
03757 
03758     <span class="keywordflow">case</span> Q_DEFAULT:
03759     <span class="keywordflow">case</span> Q_HOST:
03760         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_LINK) {
03761             <span class="keywordflow">switch</span> (linktype) {
03762 
03763             <span class="keywordflow">case</span> DLT_EN10MB:
03764                 eaddr = pcap_ether_hostton(name);
03765                 <span class="keywordflow">if</span> (eaddr == NULL)
03766                     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
03767                         <span class="stringliteral">"unknown ether host '%s'"</span>, name);
03768                 b = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, dir);
03769                 free(eaddr);
03770                 <span class="keywordflow">return</span> b;
03771 
03772             <span class="keywordflow">case</span> DLT_FDDI:
03773                 eaddr = pcap_ether_hostton(name);
03774                 <span class="keywordflow">if</span> (eaddr == NULL)
03775                     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
03776                         <span class="stringliteral">"unknown FDDI host '%s'"</span>, name);
03777                 b = <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, dir);
03778                 free(eaddr);
03779                 <span class="keywordflow">return</span> b;
03780 
03781             <span class="keywordflow">case</span> DLT_IEEE802:
03782                 eaddr = pcap_ether_hostton(name);
03783                 <span class="keywordflow">if</span> (eaddr == NULL)
03784                     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
03785                         <span class="stringliteral">"unknown token ring host '%s'"</span>, name);
03786                 b = <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, dir);
03787                 free(eaddr);
03788                 <span class="keywordflow">return</span> b;
03789 
03790             <span class="keywordflow">case</span> DLT_IEEE802_11:
03791                 eaddr = pcap_ether_hostton(name);
03792                 <span class="keywordflow">if</span> (eaddr == NULL)
03793                     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
03794                         <span class="stringliteral">"unknown 802.11 host '%s'"</span>, name);
03795                 b = <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, dir);
03796                 free(eaddr);
03797                 <span class="keywordflow">return</span> b;
03798 
03799             <span class="keywordflow">case</span> DLT_IP_OVER_FC:
03800                 eaddr = pcap_ether_hostton(name);
03801                 <span class="keywordflow">if</span> (eaddr == NULL)
03802                     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
03803                         <span class="stringliteral">"unknown Fibre Channel host '%s'"</span>, name);
03804                 b = <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, dir);
03805                 free(eaddr);
03806                 <span class="keywordflow">return</span> b;
03807 
03808             <span class="keywordflow">case</span> DLT_SUNATM:
03809                 <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a36">is_lane</a>)
03810                     <span class="keywordflow">break</span>;
03811 
03812                 <span class="comment">/*</span>
03813 <span class="comment">                 * Check that the packet doesn't begin</span>
03814 <span class="comment">                 * with an LE Control marker.  (We've</span>
03815 <span class="comment">                 * already generated a test for LANE.)</span>
03816 <span class="comment">                 */</span>
03817                 tmp = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(SUNATM_PKT_BEGIN_POS, BPF_H,
03818                     0xFF00);
03819                 gen_not(tmp);
03820 
03821                 eaddr = pcap_ether_hostton(name);
03822                 <span class="keywordflow">if</span> (eaddr == NULL)
03823                     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(
03824                         <span class="stringliteral">"unknown ether host '%s'"</span>, name);
03825                 b = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, dir);
03826                 gen_and(tmp, b);
03827                 free(eaddr);
03828                 <span class="keywordflow">return</span> b;
03829             }
03830 
03831             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"only ethernet/FDDI/token ring/802.11/ATM LANE/Fibre Channel supports link-level host name"</span>);
03832         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_DECNET) {
03833             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dn_addr = __pcap_nametodnaddr(name);
03834             <span class="comment">/*</span>
03835 <span class="comment">             * I don't think DECNET hosts can be multihomed, so</span>
03836 <span class="comment">             * there is no need to build up a list of addresses</span>
03837 <span class="comment">             */</span>
03838             <span class="keywordflow">return</span> (<a class="code" href="gencode_8c.html#a96">gen_host</a>(dn_addr, 0, proto, dir));
03839         } <span class="keywordflow">else</span> {
03840 <span class="preprocessor">#ifndef INET6</span>
03841 <span class="preprocessor"></span>            <a class="code" href="gencode_8c.html#a50">alist</a> = pcap_nametoaddr(name);
03842             <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a50">alist</a> == NULL || *<a class="code" href="gencode_8c.html#a50">alist</a> == NULL)
03843                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown host '%s'"</span>, name);
03844             tproto = <a class="code" href="gencode_8c.html#a46">proto</a>;
03845             <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a34">off_linktype</a> == -1 &amp;&amp; tproto == Q_DEFAULT)
03846                 tproto = Q_IP;
03847             b = <a class="code" href="gencode_8c.html#a96">gen_host</a>(**alist++, 0xffffffff, tproto, dir);
03848             <span class="keywordflow">while</span> (*alist) {
03849                 tmp = <a class="code" href="gencode_8c.html#a96">gen_host</a>(**alist++, 0xffffffff,
03850                            tproto, dir);
03851                 gen_or(b, tmp);
03852                 b = tmp;
03853             }
03854             <span class="keywordflow">return</span> b;
03855 <span class="preprocessor">#else</span>
03856 <span class="preprocessor"></span>            memset(&amp;mask128, 0xff, <span class="keyword">sizeof</span>(mask128));
03857             res0 = res = pcap_nametoaddrinfo(name);
03858             <span class="keywordflow">if</span> (res == NULL)
03859                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown host '%s'"</span>, name);
03860             b = tmp = NULL;
03861             tproto = tproto6 = <a class="code" href="gencode_8c.html#a46">proto</a>;
03862             <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a34">off_linktype</a> == -1 &amp;&amp; tproto == Q_DEFAULT) {
03863                 tproto = Q_IP;
03864                 tproto6 = Q_IPV6;
03865             }
03866             <span class="keywordflow">for</span> (res = res0; res; res = res-&gt;ai_next) {
03867                 <span class="keywordflow">switch</span> (res-&gt;ai_family) {
03868                 <span class="keywordflow">case</span> AF_INET:
03869                     <span class="keywordflow">if</span> (tproto == Q_IPV6)
03870                         <span class="keywordflow">continue</span>;
03871 
03872                     sin = (<span class="keyword">struct </span>sockaddr_in *)
03873                         res-&gt;ai_addr;
03874                     tmp = <a class="code" href="gencode_8c.html#a96">gen_host</a>(ntohl(sin-&gt;sin_addr.s_addr),
03875                         0xffffffff, tproto, dir);
03876                     <span class="keywordflow">break</span>;
03877                 <span class="keywordflow">case</span> AF_INET6:
03878                     <span class="keywordflow">if</span> (tproto6 == Q_IP)
03879                         <span class="keywordflow">continue</span>;
03880 
03881                     sin6 = (<span class="keyword">struct </span>sockaddr_in6 *)
03882                         res-&gt;ai_addr;
03883                     tmp = gen_host6(&amp;sin6-&gt;sin6_addr,
03884                         &amp;mask128, tproto6, dir);
03885                     <span class="keywordflow">break</span>;
03886                 <span class="keywordflow">default</span>:
03887                     <span class="keywordflow">continue</span>;
03888                 }
03889                 <span class="keywordflow">if</span> (b)
03890                     gen_or(b, tmp);
03891                 b = tmp;
03892             }
03893             freeaddrinfo(res0);
03894             <span class="keywordflow">if</span> (b == NULL) {
03895                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown host '%s'%s"</span>, name,
03896                     (proto == Q_DEFAULT)
03897                     ? <span class="stringliteral">""</span>
03898                     : <span class="stringliteral">" for specified address family"</span>);
03899             }
03900             <span class="keywordflow">return</span> b;
03901 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
03902         }
03903 
03904     <span class="keywordflow">case</span> Q_PORT:
03905         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> != Q_DEFAULT &amp;&amp;
03906             <a class="code" href="gencode_8c.html#a46">proto</a> != Q_UDP &amp;&amp; <a class="code" href="gencode_8c.html#a46">proto</a> != Q_TCP &amp;&amp; <a class="code" href="gencode_8c.html#a46">proto</a> != Q_SCTP)
03907             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"illegal qualifier of 'port'"</span>);
03908         <span class="keywordflow">if</span> (pcap_nametoport(name, &amp;port, &amp;real_proto) == 0)
03909             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown port '%s'"</span>, name);
03910         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_UDP) {
03911             <span class="keywordflow">if</span> (real_proto == IPPROTO_TCP)
03912                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"port '%s' is tcp"</span>, name);
03913             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (real_proto == <a class="code" href="gencode_8c.html#a1">IPPROTO_SCTP</a>)
03914                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"port '%s' is sctp"</span>, name);
03915             <span class="keywordflow">else</span>
03916                 <span class="comment">/* override PROTO_UNDEF */</span>
03917                 real_proto = IPPROTO_UDP;
03918         }
03919         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_TCP) {
03920             <span class="keywordflow">if</span> (real_proto == IPPROTO_UDP)
03921                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"port '%s' is udp"</span>, name);
03922 
03923             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (real_proto == <a class="code" href="gencode_8c.html#a1">IPPROTO_SCTP</a>)
03924                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"port '%s' is sctp"</span>, name);
03925             <span class="keywordflow">else</span>
03926                 <span class="comment">/* override PROTO_UNDEF */</span>
03927                 real_proto = IPPROTO_TCP;
03928         }
03929         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_SCTP) {
03930             <span class="keywordflow">if</span> (real_proto == IPPROTO_UDP)
03931                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"port '%s' is udp"</span>, name);
03932 
03933             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (real_proto == IPPROTO_TCP)
03934                 <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"port '%s' is tcp"</span>, name);
03935             <span class="keywordflow">else</span>
03936                 <span class="comment">/* override PROTO_UNDEF */</span>
03937                 real_proto = <a class="code" href="gencode_8c.html#a1">IPPROTO_SCTP</a>;
03938         }
03939 <span class="preprocessor">#ifndef INET6</span>
03940 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a101">gen_port</a>(port, real_proto, dir);
03941 <span class="preprocessor">#else</span>
03942 <span class="preprocessor"></span>        {
03943         <span class="keyword">struct </span>block *b;
03944         b = <a class="code" href="gencode_8c.html#a101">gen_port</a>(port, real_proto, dir);
03945         gen_or(gen_port6(port, real_proto, dir), b);
03946         <span class="keywordflow">return</span> b;
03947         }
03948 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
03949 
03950     <span class="keywordflow">case</span> Q_GATEWAY:
03951 <span class="preprocessor">#ifndef INET6</span>
03952 <span class="preprocessor"></span>        eaddr = pcap_ether_hostton(name);
03953         <span class="keywordflow">if</span> (eaddr == NULL)
03954             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown ether host: %s"</span>, name);
03955 
03956         <a class="code" href="gencode_8c.html#a50">alist</a> = pcap_nametoaddr(name);
03957         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a50">alist</a> == NULL || *<a class="code" href="gencode_8c.html#a50">alist</a> == NULL)
03958             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown host '%s'"</span>, name);
03959         b = <a class="code" href="gencode_8c.html#a97">gen_gateway</a>(eaddr, alist, proto, dir);
03960         free(eaddr);
03961         <span class="keywordflow">return</span> b;
03962 <span class="preprocessor">#else</span>
03963 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'gateway' not supported in this configuration"</span>);
03964 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
03965 
03966     <span class="keywordflow">case</span> Q_PROTO:
03967         real_proto = <a class="code" href="gencode_8c.html#a102">lookup_proto</a>(name, proto);
03968         <span class="keywordflow">if</span> (real_proto &gt;= 0)
03969             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a104">gen_proto</a>(real_proto, proto, dir);
03970         <span class="keywordflow">else</span>
03971             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown protocol: %s"</span>, name);
03972 
03973     <span class="keywordflow">case</span> Q_PROTOCHAIN:
03974         real_proto = <a class="code" href="gencode_8c.html#a102">lookup_proto</a>(name, proto);
03975         <span class="keywordflow">if</span> (real_proto &gt;= 0)
03976             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a103">gen_protochain</a>(real_proto, proto, dir);
03977         <span class="keywordflow">else</span>
03978             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unknown protocol: %s"</span>, name);
03979 
03980 
03981     <span class="keywordflow">case</span> Q_UNDEF:
03982         <a class="code" href="gencode_8c.html#a73">syntax</a>();
03983         <span class="comment">/* NOTREACHED */</span>
03984     }
03985     abort();
03986     <span class="comment">/* NOTREACHED */</span>
03987 }
03988 
03989 <span class="keyword">struct </span>block *
03990 gen_mcode(<a class="code" href="gencode_8c.html#a55">s1</a>, <a class="code" href="gencode_8c.html#a53">s2</a>, <a class="code" href="gencode_8c.html#a54">masklen</a>, <a class="code" href="gencode_8c.html#a52">q</a>)
<a name="l03991"></a><a class="code" href="gencode_8c.html#a53">03991</a>     register const char *<a class="code" href="gencode_8c.html#a55">s1</a>, *<a class="code" href="gencode_8c.html#a53">s2</a>;
<a name="l03992"></a><a class="code" href="gencode_8c.html#a54">03992</a>     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a54">masklen</a>;
03993     <span class="keyword">struct </span>qual <a class="code" href="gencode_8c.html#a52">q</a>;
03994 {
03995     <span class="keyword">register</span> <span class="keywordtype">int</span> nlen, mlen;
03996     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="bpf__image_8c.html#a1">n</a>, m;
03997 
03998     nlen = __pcap_atoin(s1, &amp;n);
03999     <span class="comment">/* Promote short ipaddr */</span>
04000     <a class="code" href="bpf__image_8c.html#a1">n</a> &lt;&lt;= 32 - nlen;
04001 
04002     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a53">s2</a> != NULL) {
04003         mlen = __pcap_atoin(s2, &amp;m);
04004         <span class="comment">/* Promote short ipaddr */</span>
04005         m &lt;&lt;= 32 - mlen;
04006         <span class="keywordflow">if</span> ((<a class="code" href="bpf__image_8c.html#a1">n</a> &amp; ~m) != 0)
04007             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"non-network bits set in \"%s mask %s\""</span>,
04008                 s1, s2);
04009     } <span class="keywordflow">else</span> {
04010         <span class="comment">/* Convert mask len to mask */</span>
04011         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a54">masklen</a> &gt; 32)
04012             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"mask length must be &lt;= 32"</span>);
04013         m = 0xffffffff &lt;&lt; (32 - <a class="code" href="gencode_8c.html#a54">masklen</a>);
04014         <span class="keywordflow">if</span> ((<a class="code" href="bpf__image_8c.html#a1">n</a> &amp; ~m) != 0)
04015             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"non-network bits set in \"%s/%d\""</span>,
04016                 s1, masklen);
04017     }
04018 
04019     <span class="keywordflow">switch</span> (<a class="code" href="gencode_8c.html#a52">q</a>.addr) {
04020 
04021     <span class="keywordflow">case</span> Q_NET:
04022         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a96">gen_host</a>(n, m, <a class="code" href="gencode_8c.html#a52">q</a>.proto, <a class="code" href="gencode_8c.html#a52">q</a>.dir);
04023 
04024     <span class="keywordflow">default</span>:
04025         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"Mask syntax for networks only"</span>);
04026         <span class="comment">/* NOTREACHED */</span>
04027     }
04028 }
04029 
04030 <span class="keyword">struct </span>block *
04031 gen_ncode(s, <a class="code" href="gencode_8c.html#a28">v</a>, <a class="code" href="gencode_8c.html#a52">q</a>)
04032     register const char *s;
<a name="l04033"></a><a class="code" href="gencode_8c.html#a28">04033</a>     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a28">v</a>;
04034     <span class="keyword">struct </span>qual <a class="code" href="gencode_8c.html#a52">q</a>;
04035 {
04036     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a29">mask</a>;
04037     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a46">proto</a> = <a class="code" href="gencode_8c.html#a52">q</a>.proto;
04038     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a> = <a class="code" href="gencode_8c.html#a52">q</a>.dir;
04039     <span class="keyword">register</span> <span class="keywordtype">int</span> vlen;
04040 
04041     <span class="keywordflow">if</span> (s == NULL)
04042         vlen = 32;
04043     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a52">q</a>.proto == Q_DECNET)
04044         vlen = __pcap_atodn(s, &amp;v);
04045     <span class="keywordflow">else</span>
04046         vlen = __pcap_atoin(s, &amp;v);
04047 
04048     <span class="keywordflow">switch</span> (<a class="code" href="gencode_8c.html#a52">q</a>.addr) {
04049 
04050     <span class="keywordflow">case</span> Q_DEFAULT:
04051     <span class="keywordflow">case</span> Q_HOST:
04052     <span class="keywordflow">case</span> Q_NET:
04053         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_DECNET)
04054             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a96">gen_host</a>(v, 0, proto, dir);
04055         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_LINK) {
04056             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"illegal link layer address"</span>);
04057         } <span class="keywordflow">else</span> {
04058             <a class="code" href="gencode_8c.html#a29">mask</a> = 0xffffffff;
04059             <span class="keywordflow">if</span> (s == NULL &amp;&amp; <a class="code" href="gencode_8c.html#a52">q</a>.addr == Q_NET) {
04060                 <span class="comment">/* Promote short net number */</span>
04061                 <span class="keywordflow">while</span> (<a class="code" href="gencode_8c.html#a28">v</a> &amp;&amp; (<a class="code" href="gencode_8c.html#a28">v</a> &amp; 0xff000000) == 0) {
04062                     <a class="code" href="gencode_8c.html#a28">v</a> &lt;&lt;= 8;
04063                     <a class="code" href="gencode_8c.html#a29">mask</a> &lt;&lt;= 8;
04064                 }
04065             } <span class="keywordflow">else</span> {
04066                 <span class="comment">/* Promote short ipaddr */</span>
04067                 <a class="code" href="gencode_8c.html#a28">v</a> &lt;&lt;= 32 - vlen;
04068                 <a class="code" href="gencode_8c.html#a29">mask</a> &lt;&lt;= 32 - vlen;
04069             }
04070             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a96">gen_host</a>(v, mask, proto, dir);
04071         }
04072 
04073     <span class="keywordflow">case</span> Q_PORT:
04074         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_UDP)
04075             <a class="code" href="gencode_8c.html#a46">proto</a> = IPPROTO_UDP;
04076         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_TCP)
04077             <a class="code" href="gencode_8c.html#a46">proto</a> = IPPROTO_TCP;
04078         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_SCTP)
04079             <a class="code" href="gencode_8c.html#a46">proto</a> = <a class="code" href="gencode_8c.html#a1">IPPROTO_SCTP</a>;
04080         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a46">proto</a> == Q_DEFAULT)
04081             <a class="code" href="gencode_8c.html#a46">proto</a> = PROTO_UNDEF;
04082         <span class="keywordflow">else</span>
04083             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"illegal qualifier of 'port'"</span>);
04084 
04085 <span class="preprocessor">#ifndef INET6</span>
04086 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a101">gen_port</a>((<span class="keywordtype">int</span>)v, proto, dir);
04087 <span class="preprocessor">#else</span>
04088 <span class="preprocessor"></span>        {
04089         <span class="keyword">struct </span>block *b;
04090         b = <a class="code" href="gencode_8c.html#a101">gen_port</a>((<span class="keywordtype">int</span>)v, proto, dir);
04091         gen_or(gen_port6((<span class="keywordtype">int</span>)v, proto, dir), b);
04092         <span class="keywordflow">return</span> b;
04093         }
04094 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
04095 
04096     <span class="keywordflow">case</span> Q_GATEWAY:
04097         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'gateway' requires a name"</span>);
04098         <span class="comment">/* NOTREACHED */</span>
04099 
04100     <span class="keywordflow">case</span> Q_PROTO:
04101         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a104">gen_proto</a>((<span class="keywordtype">int</span>)v, proto, dir);
04102 
04103     <span class="keywordflow">case</span> Q_PROTOCHAIN:
04104         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a103">gen_protochain</a>((<span class="keywordtype">int</span>)v, proto, dir);
04105 
04106     <span class="keywordflow">case</span> Q_UNDEF:
04107         <a class="code" href="gencode_8c.html#a73">syntax</a>();
04108         <span class="comment">/* NOTREACHED */</span>
04109 
04110     <span class="keywordflow">default</span>:
04111         abort();
04112         <span class="comment">/* NOTREACHED */</span>
04113     }
04114     <span class="comment">/* NOTREACHED */</span>
04115 }
04116 
04117 <span class="preprocessor">#ifdef INET6</span>
04118 <span class="preprocessor"></span><span class="keyword">struct </span>block *
04119 gen_mcode6(<a class="code" href="gencode_8c.html#a55">s1</a>, <a class="code" href="gencode_8c.html#a53">s2</a>, <a class="code" href="gencode_8c.html#a54">masklen</a>, <a class="code" href="gencode_8c.html#a52">q</a>)
04120     register const char *<a class="code" href="gencode_8c.html#a55">s1</a>, *<a class="code" href="gencode_8c.html#a53">s2</a>;
04121     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a54">masklen</a>;
04122     <span class="keyword">struct </span>qual <a class="code" href="gencode_8c.html#a52">q</a>;
04123 {
04124     <span class="keyword">struct </span>addrinfo *res;
04125     <span class="keyword">struct </span>in6_addr *addr;
04126     <span class="keyword">struct </span>in6_addr <a class="code" href="gencode_8c.html#a29">mask</a>;
04127     <span class="keyword">struct </span>block *b;
04128     u_int32_t *a, *m;
04129 
04130     <span class="keywordflow">if</span> (s2)
04131         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"no mask %s supported"</span>, s2);
04132 
04133     res = pcap_nametoaddrinfo(s1);
04134     <span class="keywordflow">if</span> (!res)
04135         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"invalid ip6 address %s"</span>, s1);
04136     <span class="keywordflow">if</span> (res-&gt;ai_next)
04137         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"%s resolved to multiple address"</span>, s1);
04138     addr = &amp;((<span class="keyword">struct </span>sockaddr_in6 *)res-&gt;ai_addr)-&gt;sin6_addr;
04139 
04140     <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(mask) * 8 &lt; <a class="code" href="gencode_8c.html#a54">masklen</a>)
04141         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"mask length must be &lt;= %u"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(<span class="keyword">sizeof</span>(mask) * 8));
04142     memset(&amp;mask, 0, <span class="keyword">sizeof</span>(mask));
04143     memset(&amp;mask, 0xff, masklen / 8);
04144     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a54">masklen</a> % 8) {
04145         <a class="code" href="gencode_8c.html#a29">mask</a>.s6_addr[<a class="code" href="gencode_8c.html#a54">masklen</a> / 8] =
04146             (0xff &lt;&lt; (8 - <a class="code" href="gencode_8c.html#a54">masklen</a> % 8)) &amp; 0xff;
04147     }
04148 
04149     a = (u_int32_t *)addr;
04150     m = (u_int32_t *)&amp;<a class="code" href="gencode_8c.html#a29">mask</a>;
04151     <span class="keywordflow">if</span> ((a[0] &amp; ~m[0]) || (a[1] &amp; ~m[1])
04152      || (a[2] &amp; ~m[2]) || (a[3] &amp; ~m[3])) {
04153         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"non-network bits set in \"%s/%d\""</span>, s1, masklen);
04154     }
04155 
04156     <span class="keywordflow">switch</span> (<a class="code" href="gencode_8c.html#a52">q</a>.addr) {
04157 
04158     <span class="keywordflow">case</span> Q_DEFAULT:
04159     <span class="keywordflow">case</span> Q_HOST:
04160         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a54">masklen</a> != 128)
04161             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"Mask syntax for networks only"</span>);
04162         <span class="comment">/* FALLTHROUGH */</span>
04163 
04164     <span class="keywordflow">case</span> Q_NET:
04165         b = gen_host6(addr, &amp;mask, <a class="code" href="gencode_8c.html#a52">q</a>.proto, <a class="code" href="gencode_8c.html#a52">q</a>.dir);
04166         freeaddrinfo(res);
04167         <span class="keywordflow">return</span> b;
04168 
04169     <span class="keywordflow">default</span>:
04170         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"invalid qualifier against IPv6 address"</span>);
04171         <span class="comment">/* NOTREACHED */</span>
04172     }
04173 }
04174 <span class="preprocessor">#endif </span><span class="comment">/*INET6*/</span>
04175 
04176 <span class="keyword">struct </span>block *
04177 gen_ecode(eaddr, <a class="code" href="gencode_8c.html#a52">q</a>)
04178     register const u_char *eaddr;
04179     <span class="keyword">struct </span>qual <a class="code" href="gencode_8c.html#a52">q</a>;
04180 {
04181     <span class="keyword">struct </span>block *b, *tmp;
04182 
04183     <span class="keywordflow">if</span> ((<a class="code" href="gencode_8c.html#a52">q</a>.addr == Q_HOST || <a class="code" href="gencode_8c.html#a52">q</a>.addr == Q_DEFAULT) &amp;&amp; <a class="code" href="gencode_8c.html#a52">q</a>.proto == Q_LINK) {
04184         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_EN10MB)
04185             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04186         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_FDDI)
04187             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04188         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802)
04189             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04190         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802_11)
04191             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04192         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_SUNATM &amp;&amp; <a class="code" href="gencode_8c.html#a36">is_lane</a>) {
04193             <span class="comment">/*</span>
04194 <span class="comment">             * Check that the packet doesn't begin with an</span>
04195 <span class="comment">             * LE Control marker.  (We've already generated</span>
04196 <span class="comment">             * a test for LANE.)</span>
04197 <span class="comment">             */</span>
04198             tmp = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(SUNATM_PKT_BEGIN_POS, BPF_H, 0xFF00);
04199             gen_not(tmp);
04200 
04201             <span class="comment">/*</span>
04202 <span class="comment">             * Now check the MAC address.</span>
04203 <span class="comment">             */</span>
04204             b = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04205             gen_and(tmp, b);
04206             <span class="keywordflow">return</span> b;
04207         }
04208         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IP_OVER_FC)
04209             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a94">gen_ipfchostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04210         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ethernet addresses supported only on ethernet/FDDI/token ring/802.11/ATM LANE/Fibre Channel"</span>);
04211     }
04212     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ethernet address used in non-ether expression"</span>);
04213     <span class="comment">/* NOTREACHED */</span>
04214 }
04215 
04216 <span class="keywordtype">void</span>
04217 sappend(s0, s1)
<a name="l04218"></a><a class="code" href="gencode_8c.html#a55">04218</a>     <span class="keyword">struct </span>slist *s0, *<a class="code" href="gencode_8c.html#a55">s1</a>;
04219 {
04220     <span class="comment">/*</span>
04221 <span class="comment">     * This is definitely not the best way to do this, but the</span>
04222 <span class="comment">     * lists will rarely get long.</span>
04223 <span class="comment">     */</span>
04224     <span class="keywordflow">while</span> (s0-&gt;next)
04225         s0 = s0-&gt;next;
04226     s0-&gt;next = <a class="code" href="gencode_8c.html#a55">s1</a>;
04227 }
04228 
04229 <span class="keyword">static</span> <span class="keyword">struct </span>slist *
04230 <a class="code" href="gencode_8c.html#a105">xfer_to_x</a>(a)
04231     struct arth *a;
04232 {
04233     <span class="keyword">struct </span>slist *s;
04234 
04235     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LDX|BPF_MEM);
04236     s-&gt;s.k = a-&gt;regno;
04237     <span class="keywordflow">return</span> s;
04238 }
04239 
04240 <span class="keyword">static</span> <span class="keyword">struct </span>slist *
04241 <a class="code" href="gencode_8c.html#a106">xfer_to_a</a>(a)
04242     struct arth *a;
04243 {
04244     <span class="keyword">struct </span>slist *s;
04245 
04246     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_MEM);
04247     s-&gt;s.k = a-&gt;regno;
04248     <span class="keywordflow">return</span> s;
04249 }
04250 
04251 <span class="keyword">struct </span>arth *
04252 gen_load(<a class="code" href="gencode_8c.html#a46">proto</a>, <a class="code" href="gencode_8c.html#a56">index</a>, <a class="code" href="gencode_8c.html#a27">size</a>)
04253     int <a class="code" href="gencode_8c.html#a46">proto</a>;
<a name="l04254"></a><a class="code" href="gencode_8c.html#a56">04254</a>     <span class="keyword">struct </span>arth *<a class="code" href="gencode_8c.html#a56">index</a>;
<a name="l04255"></a><a class="code" href="gencode_8c.html#a27">04255</a>     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a27">size</a>;
04256 {
04257     <span class="keyword">struct </span>slist *s, *tmp;
04258     <span class="keyword">struct </span>block *b;
04259     <span class="keywordtype">int</span> regno = <a class="code" href="gencode_8c.html#a66">alloc_reg</a>();
04260 
04261     <a class="code" href="gencode_8c.html#a116">free_reg</a>(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;regno);
04262     <span class="keywordflow">switch</span> (size) {
04263 
04264     <span class="keywordflow">default</span>:
04265         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"data size must be 1, 2, or 4"</span>);
04266 
04267     <span class="keywordflow">case</span> 1:
04268         <a class="code" href="gencode_8c.html#a27">size</a> = BPF_B;
04269         <span class="keywordflow">break</span>;
04270 
04271     <span class="keywordflow">case</span> 2:
04272         <a class="code" href="gencode_8c.html#a27">size</a> = BPF_H;
04273         <span class="keywordflow">break</span>;
04274 
04275     <span class="keywordflow">case</span> 4:
04276         <a class="code" href="gencode_8c.html#a27">size</a> = BPF_W;
04277         <span class="keywordflow">break</span>;
04278     }
04279     <span class="keywordflow">switch</span> (proto) {
04280     <span class="keywordflow">default</span>:
04281         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"unsupported index operation"</span>);
04282 
04283     <span class="keywordflow">case</span> Q_LINK:
04284         <span class="comment">/*</span>
04285 <span class="comment">         * XXX - what about ATM LANE?  Should the index be</span>
04286 <span class="comment">         * relative to the beginning of the AAL5 frame, so</span>
04287 <span class="comment">         * that 0 refers to the beginning of the LE Control</span>
04288 <span class="comment">         * field, or relative to the beginning of the LAN</span>
04289 <span class="comment">         * frame, so that 0 refers, for Ethernet LANE, to</span>
04290 <span class="comment">         * the beginning of the destination address?</span>
04291 <span class="comment">         */</span>
04292         s = <a class="code" href="gencode_8c.html#a105">xfer_to_x</a>(index);
04293         tmp = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|size);
04294         sappend(s, tmp);
04295         sappend(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;s, s);
04296         <span class="keywordflow">break</span>;
04297 
04298     <span class="keywordflow">case</span> Q_IP:
04299     <span class="keywordflow">case</span> Q_ARP:
04300     <span class="keywordflow">case</span> Q_RARP:
04301     <span class="keywordflow">case</span> Q_ATALK:
04302     <span class="keywordflow">case</span> Q_DECNET:
04303     <span class="keywordflow">case</span> Q_SCA:
04304     <span class="keywordflow">case</span> Q_LAT:
04305     <span class="keywordflow">case</span> Q_MOPRC:
04306     <span class="keywordflow">case</span> Q_MOPDL:
04307 <span class="preprocessor">#ifdef INET6</span>
04308 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IPV6:
04309 <span class="preprocessor">#endif</span>
04310 <span class="preprocessor"></span>        <span class="comment">/* XXX Note that we assume a fixed link header here. */</span>
04311         s = <a class="code" href="gencode_8c.html#a105">xfer_to_x</a>(index);
04312         tmp = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|size);
04313         tmp-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
04314         sappend(s, tmp);
04315         sappend(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;s, s);
04316 
04317         b = gen_proto_abbrev(proto);
04318         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a56">index</a>-&gt;b)
04319             gen_and(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;b, b);
04320         <a class="code" href="gencode_8c.html#a56">index</a>-&gt;b = b;
04321         <span class="keywordflow">break</span>;
04322 
04323     <span class="keywordflow">case</span> Q_SCTP:
04324     <span class="keywordflow">case</span> Q_TCP:
04325     <span class="keywordflow">case</span> Q_UDP:
04326     <span class="keywordflow">case</span> Q_ICMP:
04327     <span class="keywordflow">case</span> Q_IGMP:
04328     <span class="keywordflow">case</span> Q_IGRP:
04329     <span class="keywordflow">case</span> Q_PIM:
04330     <span class="keywordflow">case</span> Q_VRRP:
04331         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LDX|BPF_MSH|BPF_B);
04332         s-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
04333         sappend(s, <a class="code" href="gencode_8c.html#a106">xfer_to_a</a>(index));
04334         sappend(s, <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_ADD|BPF_X));
04335         sappend(s, <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_MISC|BPF_TAX));
04336         sappend(s, tmp = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IND|size));
04337         tmp-&gt;s.k = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
04338         sappend(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;s, s);
04339 
04340         gen_and(gen_proto_abbrev(proto), b = <a class="code" href="gencode_8c.html#a98">gen_ipfrag</a>());
04341         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a56">index</a>-&gt;b)
04342             gen_and(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;b, b);
04343 <span class="preprocessor">#ifdef INET6</span>
04344 <span class="preprocessor"></span>        gen_and(gen_proto_abbrev(Q_IP), b);
04345 <span class="preprocessor">#endif</span>
04346 <span class="preprocessor"></span>        <a class="code" href="gencode_8c.html#a56">index</a>-&gt;b = b;
04347         <span class="keywordflow">break</span>;
04348 <span class="preprocessor">#ifdef INET6</span>
04349 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_ICMPV6:
04350         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"IPv6 upper-layer protocol is not supported by proto[x]"</span>);
04351         <span class="comment">/*NOTREACHED*/</span>
04352 <span class="preprocessor">#endif</span>
04353 <span class="preprocessor"></span>    }
04354     <a class="code" href="gencode_8c.html#a56">index</a>-&gt;regno = regno;
04355     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
04356     s-&gt;s.k = regno;
04357     sappend(<a class="code" href="gencode_8c.html#a56">index</a>-&gt;s, s);
04358 
04359     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a56">index</a>;
04360 }
04361 
04362 <span class="keyword">struct </span>block *
04363 gen_relation(code, <a class="code" href="gencode_8c.html#a57">a0</a>, <a class="code" href="gencode_8c.html#a58">a1</a>, <a class="code" href="gencode_8c.html#a59">reversed</a>)
04364     int code;
04365     <span class="keyword">struct </span>arth *<a class="code" href="gencode_8c.html#a57">a0</a>, *<a class="code" href="gencode_8c.html#a58">a1</a>;
<a name="l04366"></a><a class="code" href="gencode_8c.html#a59">04366</a>     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a59">reversed</a>;
04367 {
04368     <span class="keyword">struct </span>slist *s0, *<a class="code" href="gencode_8c.html#a55">s1</a>, *<a class="code" href="gencode_8c.html#a53">s2</a>;
04369     <span class="keyword">struct </span>block *b, *tmp;
04370 
04371     s0 = <a class="code" href="gencode_8c.html#a105">xfer_to_x</a>(a1);
04372     <a class="code" href="gencode_8c.html#a55">s1</a> = <a class="code" href="gencode_8c.html#a106">xfer_to_a</a>(a0);
04373     <span class="keywordflow">if</span> (code == BPF_JEQ) {
04374         <a class="code" href="gencode_8c.html#a53">s2</a> = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_SUB|BPF_X);
04375         b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(code));
04376         sappend(s1, s2);
04377     }
04378     <span class="keywordflow">else</span>
04379         b = <a class="code" href="gencode_8c.html#a70">new_block</a>(BPF_JMP|code|BPF_X);
04380     <span class="keywordflow">if</span> (reversed)
04381         gen_not(b);
04382 
04383     sappend(s0, s1);
04384     sappend(<a class="code" href="gencode_8c.html#a58">a1</a>-&gt;s, s0);
04385     sappend(<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;s, <a class="code" href="gencode_8c.html#a58">a1</a>-&gt;s);
04386 
04387     b-&gt;stmts = <a class="code" href="gencode_8c.html#a57">a0</a>-&gt;s;
04388 
04389     <a class="code" href="gencode_8c.html#a116">free_reg</a>(<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;regno);
04390     <a class="code" href="gencode_8c.html#a116">free_reg</a>(<a class="code" href="gencode_8c.html#a58">a1</a>-&gt;regno);
04391 
04392     <span class="comment">/* 'and' together protocol checks */</span>
04393     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;b) {
04394         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a58">a1</a>-&gt;b) {
04395             gen_and(<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;b, tmp = <a class="code" href="gencode_8c.html#a58">a1</a>-&gt;b);
04396         }
04397         <span class="keywordflow">else</span>
04398             tmp = <a class="code" href="gencode_8c.html#a57">a0</a>-&gt;b;
04399     } <span class="keywordflow">else</span>
04400         tmp = <a class="code" href="gencode_8c.html#a58">a1</a>-&gt;b;
04401 
04402     <span class="keywordflow">if</span> (tmp)
04403         gen_and(tmp, b);
04404 
04405     <span class="keywordflow">return</span> b;
04406 }
04407 
04408 <span class="keyword">struct </span>arth *
04409 gen_loadlen()
04410 {
04411     <span class="keywordtype">int</span> regno = <a class="code" href="gencode_8c.html#a66">alloc_reg</a>();
04412     <span class="keyword">struct </span>arth *a = (<span class="keyword">struct </span>arth *)<a class="code" href="gencode_8c.html#a68">newchunk</a>(sizeof(*a));
04413     <span class="keyword">struct </span>slist *s;
04414 
04415     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_LEN);
04416     s-&gt;next = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
04417     s-&gt;next-&gt;s.k = regno;
04418     a-&gt;s = s;
04419     a-&gt;regno = regno;
04420 
04421     <span class="keywordflow">return</span> a;
04422 }
04423 
04424 <span class="keyword">struct </span>arth *
04425 gen_loadi(<a class="code" href="gencode_8c.html#a63">val</a>)
04426     int <a class="code" href="gencode_8c.html#a63">val</a>;
04427 {
04428     <span class="keyword">struct </span>arth *a;
04429     <span class="keyword">struct </span>slist *s;
04430     <span class="keywordtype">int</span> reg;
04431 
04432     a = (<span class="keyword">struct </span>arth *)<a class="code" href="gencode_8c.html#a68">newchunk</a>(sizeof(*a));
04433 
04434     reg = <a class="code" href="gencode_8c.html#a66">alloc_reg</a>();
04435 
04436     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_IMM);
04437     s-&gt;s.k = <a class="code" href="gencode_8c.html#a63">val</a>;
04438     s-&gt;next = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
04439     s-&gt;next-&gt;s.k = reg;
04440     a-&gt;s = s;
04441     a-&gt;regno = reg;
04442 
04443     <span class="keywordflow">return</span> a;
04444 }
04445 
04446 <span class="keyword">struct </span>arth *
04447 gen_neg(a)
04448     struct arth *a;
04449 {
04450     <span class="keyword">struct </span>slist *s;
04451 
04452     s = <a class="code" href="gencode_8c.html#a106">xfer_to_a</a>(a);
04453     sappend(a-&gt;s, s);
04454     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_NEG);
04455     s-&gt;s.k = 0;
04456     sappend(a-&gt;s, s);
04457     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
04458     s-&gt;s.k = a-&gt;regno;
04459     sappend(a-&gt;s, s);
04460 
04461     <span class="keywordflow">return</span> a;
04462 }
04463 
04464 <span class="keyword">struct </span>arth *
04465 gen_arth(code, <a class="code" href="gencode_8c.html#a57">a0</a>, <a class="code" href="gencode_8c.html#a58">a1</a>)
04466     int code;
<a name="l04467"></a><a class="code" href="gencode_8c.html#a58">04467</a>     <span class="keyword">struct </span>arth *<a class="code" href="gencode_8c.html#a57">a0</a>, *<a class="code" href="gencode_8c.html#a58">a1</a>;
04468 {
04469     <span class="keyword">struct </span>slist *s0, *<a class="code" href="gencode_8c.html#a55">s1</a>, *<a class="code" href="gencode_8c.html#a53">s2</a>;
04470 
04471     s0 = <a class="code" href="gencode_8c.html#a105">xfer_to_x</a>(a1);
04472     <a class="code" href="gencode_8c.html#a55">s1</a> = <a class="code" href="gencode_8c.html#a106">xfer_to_a</a>(a0);
04473     <a class="code" href="gencode_8c.html#a53">s2</a> = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_X|code);
04474 
04475     sappend(s1, s2);
04476     sappend(s0, s1);
04477     sappend(<a class="code" href="gencode_8c.html#a58">a1</a>-&gt;s, s0);
04478     sappend(<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;s, <a class="code" href="gencode_8c.html#a58">a1</a>-&gt;s);
04479 
04480     <a class="code" href="gencode_8c.html#a116">free_reg</a>(<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;regno);
04481     <a class="code" href="gencode_8c.html#a116">free_reg</a>(<a class="code" href="gencode_8c.html#a58">a1</a>-&gt;regno);
04482 
04483     s0 = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ST);
04484     <a class="code" href="gencode_8c.html#a57">a0</a>-&gt;regno = s0-&gt;s.k = <a class="code" href="gencode_8c.html#a66">alloc_reg</a>();
04485     sappend(<a class="code" href="gencode_8c.html#a57">a0</a>-&gt;s, s0);
04486 
04487     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a57">a0</a>;
04488 }
04489 
04490 <span class="comment">/*</span>
04491 <span class="comment"> * Here we handle simple allocation of the scratch registers.</span>
04492 <span class="comment"> * If too many registers are alloc'd, the allocator punts.</span>
04493 <span class="comment"> */</span>
04494 <span class="keyword">static</span> <span class="keywordtype">int</span> regused[BPF_MEMWORDS];
<a name="l04495"></a><a class="code" href="gencode_8c.html#a60">04495</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a60">curreg</a>;
04496 
04497 <span class="comment">/*</span>
04498 <span class="comment"> * Return the next free register.</span>
04499 <span class="comment"> */</span>
04500 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04501"></a><a class="code" href="gencode_8c.html#a66">04501</a> <a class="code" href="gencode_8c.html#a66">alloc_reg</a>()
04502 {
04503     <span class="keywordtype">int</span> <a class="code" href="bpf__image_8c.html#a1">n</a> = BPF_MEMWORDS;
04504 
04505     <span class="keywordflow">while</span> (--<a class="code" href="bpf__image_8c.html#a1">n</a> &gt;= 0) {
04506         <span class="keywordflow">if</span> (regused[<a class="code" href="gencode_8c.html#a60">curreg</a>])
04507             <a class="code" href="gencode_8c.html#a60">curreg</a> = (<a class="code" href="gencode_8c.html#a60">curreg</a> + 1) % BPF_MEMWORDS;
04508         <span class="keywordflow">else</span> {
04509             regused[<a class="code" href="gencode_8c.html#a60">curreg</a>] = 1;
04510             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a60">curreg</a>;
04511         }
04512     }
04513     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"too many registers needed to evaluate expression"</span>);
04514     <span class="comment">/* NOTREACHED */</span>
04515 }
04516 
04517 <span class="comment">/*</span>
04518 <span class="comment"> * Return a register to the table so it can</span>
04519 <span class="comment"> * be used later.</span>
04520 <span class="comment"> */</span>
04521 <span class="keyword">static</span> <span class="keywordtype">void</span>
04522 <a class="code" href="gencode_8c.html#a116">free_reg</a>(n)
04523     <span class="keywordtype">int</span> <a class="code" href="bpf__image_8c.html#a1">n</a>;
04524 {
04525     regused[<a class="code" href="bpf__image_8c.html#a1">n</a>] = 0;
04526 }
04527 
04528 <span class="keyword">static</span> <span class="keyword">struct </span>block *
04529 <a class="code" href="gencode_8c.html#a108">gen_len</a>(jmp, <a class="code" href="bpf__image_8c.html#a1">n</a>)
<a name="l04530"></a><a class="code" href="gencode_8c.html#a61">04530</a>     int jmp, <a class="code" href="bpf__image_8c.html#a1">n</a>;
04531 {
04532     <span class="keyword">struct </span>slist *s;
04533     <span class="keyword">struct </span>block *b;
04534 
04535     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_LEN);
04536     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(jmp));
04537     b-&gt;stmts = s;
04538     b-&gt;s.k = <a class="code" href="bpf__image_8c.html#a1">n</a>;
04539 
04540     <span class="keywordflow">return</span> b;
04541 }
04542 
04543 <span class="keyword">struct </span>block *
04544 gen_greater(<a class="code" href="bpf__image_8c.html#a1">n</a>)
04545     int <a class="code" href="bpf__image_8c.html#a1">n</a>;
04546 {
04547     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a108">gen_len</a>(BPF_JGE, n);
04548 }
04549 
04550 <span class="comment">/*</span>
04551 <span class="comment"> * Actually, this is less than or equal.</span>
04552 <span class="comment"> */</span>
04553 <span class="keyword">struct </span>block *
04554 gen_less(<a class="code" href="bpf__image_8c.html#a1">n</a>)
04555     int <a class="code" href="bpf__image_8c.html#a1">n</a>;
04556 {
04557     <span class="keyword">struct </span>block *b;
04558 
04559     b = <a class="code" href="gencode_8c.html#a108">gen_len</a>(BPF_JGT, n);
04560     gen_not(b);
04561 
04562     <span class="keywordflow">return</span> b;
04563 }
04564 
04565 <span class="keyword">struct </span>block *
04566 gen_byteop(op, <a class="code" href="gencode_8c.html#a62">idx</a>, <a class="code" href="gencode_8c.html#a63">val</a>)
<a name="l04567"></a><a class="code" href="gencode_8c.html#a63">04567</a>     int op, <a class="code" href="gencode_8c.html#a62">idx</a>, <a class="code" href="gencode_8c.html#a63">val</a>;
04568 {
04569     <span class="keyword">struct </span>block *b;
04570     <span class="keyword">struct </span>slist *s;
04571 
04572     <span class="keywordflow">switch</span> (op) {
04573     <span class="keywordflow">default</span>:
04574         abort();
04575 
04576     <span class="keywordflow">case</span> <span class="charliteral">'='</span>:
04577         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a76">gen_cmp</a>((u_int)idx, BPF_B, (bpf_int32)val);
04578 
04579     <span class="keywordflow">case</span> <span class="charliteral">'&lt;'</span>:
04580         b = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>((u_int)idx, BPF_B, (bpf_int32)val);
04581         b-&gt;s.code = <a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JGE);
04582         gen_not(b);
04583         <span class="keywordflow">return</span> b;
04584 
04585     <span class="keywordflow">case</span> <span class="charliteral">'&gt;'</span>:
04586         b = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>((u_int)idx, BPF_B, (bpf_int32)val);
04587         b-&gt;s.code = <a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JGT);
04588         <span class="keywordflow">return</span> b;
04589 
04590     <span class="keywordflow">case</span> <span class="charliteral">'|'</span>:
04591         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_OR|BPF_K);
04592         <span class="keywordflow">break</span>;
04593 
04594     <span class="keywordflow">case</span> <span class="charliteral">'&amp;'</span>:
04595         s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_ALU|BPF_AND|BPF_K);
04596         <span class="keywordflow">break</span>;
04597     }
04598     s-&gt;s.k = <a class="code" href="gencode_8c.html#a63">val</a>;
04599     b = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JEQ));
04600     b-&gt;stmts = s;
04601     gen_not(b);
04602 
04603     <span class="keywordflow">return</span> b;
04604 }
04605 
04606 <span class="keyword">static</span> u_char abroadcast[] = { 0x0 };
04607 
04608 <span class="keyword">struct </span>block *
04609 <a class="code" href="gencode_8c.html#a117">gen_broadcast</a>(<a class="code" href="gencode_8c.html#a46">proto</a>)
04610     int <a class="code" href="gencode_8c.html#a46">proto</a>;
04611 {
04612     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> hostmask;
04613     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *b2;
04614     <span class="keyword">static</span> u_char ebroadcast[] = { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };
04615 
04616     <span class="keywordflow">switch</span> (proto) {
04617 
04618     <span class="keywordflow">case</span> Q_DEFAULT:
04619     <span class="keywordflow">case</span> Q_LINK:
04620         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_ARCNET || <a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_ARCNET_LINUX)
04621             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(abroadcast, Q_DST);
04622         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_EN10MB)
04623             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(ebroadcast, Q_DST);
04624         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_FDDI)
04625             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a91">gen_fhostop</a>(ebroadcast, Q_DST);
04626         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802)
04627             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a92">gen_thostop</a>(ebroadcast, Q_DST);
04628         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802_11)
04629             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a93">gen_wlanhostop</a>(ebroadcast, Q_DST);
04630         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_SUNATM &amp;&amp; <a class="code" href="gencode_8c.html#a36">is_lane</a>) {
04631             <span class="comment">/*</span>
04632 <span class="comment">             * Check that the packet doesn't begin with an</span>
04633 <span class="comment">             * LE Control marker.  (We've already generated</span>
04634 <span class="comment">             * a test for LANE.)</span>
04635 <span class="comment">             */</span>
04636             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(SUNATM_PKT_BEGIN_POS, BPF_H, 0xFF00);
04637             gen_not(b1);
04638 
04639             <span class="comment">/*</span>
04640 <span class="comment">             * Now check the MAC address.</span>
04641 <span class="comment">             */</span>
04642             b0 = <a class="code" href="gencode_8c.html#a90">gen_ehostop</a>(ebroadcast, Q_DST);
04643             gen_and(b1, b0);
04644             <span class="keywordflow">return</span> b0;
04645         }
04646         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"not a broadcast link"</span>);
04647         <span class="keywordflow">break</span>;
04648 
04649     <span class="keywordflow">case</span> Q_IP:
04650         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IP);
04651         hostmask = ~netmask;
04652         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(off_nl + 16, BPF_W, (bpf_int32)0, hostmask);
04653         b2 = <a class="code" href="gencode_8c.html#a78">gen_mcmp</a>(off_nl + 16, BPF_W,
04654                   (bpf_int32)(~0 &amp; hostmask), hostmask);
04655         gen_or(b1, b2);
04656         gen_and(b0, b2);
04657         <span class="keywordflow">return</span> b2;
04658     }
04659     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"only ether/ip broadcast filters supported"</span>);
04660 }
04661 
04662 <span class="comment">/*</span>
04663 <span class="comment"> * Generate code to test the low-order bit of a MAC address (that's</span>
04664 <span class="comment"> * the bottom bit of the *first* byte).</span>
04665 <span class="comment"> */</span>
04666 <span class="keyword">static</span> <span class="keyword">struct </span>block *
04667 <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(<a class="code" href="gencode_8c.html#a30">offset</a>)
04668     int <a class="code" href="gencode_8c.html#a30">offset</a>;
04669 {
04670     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0;
04671     <span class="keyword">register</span> <span class="keyword">struct </span>slist *s;
04672 
04673     <span class="comment">/* link[offset] &amp; 1 != 0 */</span>
04674     s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
04675     s-&gt;s.k = <a class="code" href="gencode_8c.html#a30">offset</a>;
04676     b0 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
04677     b0-&gt;s.k = 1;
04678     b0-&gt;stmts = s;
04679     <span class="keywordflow">return</span> b0;
04680 }
04681 
04682 <span class="keyword">struct </span>block *
04683 gen_multicast(<a class="code" href="gencode_8c.html#a46">proto</a>)
04684     int <a class="code" href="gencode_8c.html#a46">proto</a>;
04685 {
04686     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>, *b2;
04687     <span class="keyword">register</span> <span class="keyword">struct </span>slist *s;
04688 
04689     <span class="keywordflow">switch</span> (proto) {
04690 
04691     <span class="keywordflow">case</span> Q_DEFAULT:
04692     <span class="keywordflow">case</span> Q_LINK:
04693         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_ARCNET || <a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_ARCNET_LINUX)
04694             <span class="comment">/* all ARCnet multicasts use the same address */</span>
04695             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(abroadcast, Q_DST);
04696 
04697         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_EN10MB) {
04698             <span class="comment">/* ether[0] &amp; 1 != 0 */</span>
04699             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(0);
04700         }
04701 
04702         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_FDDI) {
04703             <span class="comment">/*</span>
04704 <span class="comment">             * XXX TEST THIS: MIGHT NOT PORT PROPERLY XXX</span>
04705 <span class="comment">             *</span>
04706 <span class="comment">             * XXX - was that referring to bit-order issues?</span>
04707 <span class="comment">             */</span>
04708             <span class="comment">/* fddi[1] &amp; 1 != 0 */</span>
04709             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(1);
04710         }
04711 
04712         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802) {
04713             <span class="comment">/* tr[2] &amp; 1 != 0 */</span>
04714             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(2);
04715         }
04716 
04717         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_IEEE802_11) {
04718             <span class="comment">/*</span>
04719 <span class="comment">             * Oh, yuk.</span>
04720 <span class="comment">             *</span>
04721 <span class="comment">             *  For control frames, there is no DA.</span>
04722 <span class="comment">             *</span>
04723 <span class="comment">             *  For management frames, DA is at an</span>
04724 <span class="comment">             *  offset of 4 from the beginning of</span>
04725 <span class="comment">             *  the packet.</span>
04726 <span class="comment">             *</span>
04727 <span class="comment">             *  For data frames, DA is at an offset</span>
04728 <span class="comment">             *  of 4 from the beginning of the packet</span>
04729 <span class="comment">             *  if To DS is clear and at an offset of</span>
04730 <span class="comment">             *  16 from the beginning of the packet</span>
04731 <span class="comment">             *  if To DS is set.</span>
04732 <span class="comment">             */</span>
04733 
04734             <span class="comment">/*</span>
04735 <span class="comment">             * Generate the tests to be done for data frames.</span>
04736 <span class="comment">             *</span>
04737 <span class="comment">             * First, check for To DS set, i.e. "link[1] &amp; 0x01".</span>
04738 <span class="comment">             */</span>
04739             s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
04740             s-&gt;s.k = 1;
04741             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
04742             <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x01; <span class="comment">/* To DS */</span>
04743             <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
04744 
04745             <span class="comment">/*</span>
04746 <span class="comment">             * If To DS is set, the DA is at 16.</span>
04747 <span class="comment">             */</span>
04748             b0 = <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(16);
04749             gen_and(b1, b0);
04750 
04751             <span class="comment">/*</span>
04752 <span class="comment">             * Now, check for To DS not set, i.e. check</span>
04753 <span class="comment">             * "!(link[1] &amp; 0x01)".</span>
04754 <span class="comment">             */</span>
04755             s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
04756             s-&gt;s.k = 1;
04757             b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
04758             b2-&gt;s.k = 0x01; <span class="comment">/* To DS */</span>
04759             b2-&gt;stmts = s;
04760             gen_not(b2);
04761 
04762             <span class="comment">/*</span>
04763 <span class="comment">             * If To DS is not set, the DA is at 4.</span>
04764 <span class="comment">             */</span>
04765             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(4);
04766             gen_and(b2, b1);
04767 
04768             <span class="comment">/*</span>
04769 <span class="comment">             * Now OR together the last two checks.  That gives</span>
04770 <span class="comment">             * the complete set of checks for data frames.</span>
04771 <span class="comment">             */</span>
04772             gen_or(b1, b0);
04773 
04774             <span class="comment">/*</span>
04775 <span class="comment">             * Now check for a data frame.</span>
04776 <span class="comment">             * I.e, check "link[0] &amp; 0x08".</span>
04777 <span class="comment">             */</span>
04778             s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
04779             s-&gt;s.k = 0;
04780             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
04781             <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x08;
04782             <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
04783 
04784             <span class="comment">/*</span>
04785 <span class="comment">             * AND that with the checks done for data frames.</span>
04786 <span class="comment">             */</span>
04787             gen_and(b1, b0);
04788 
04789             <span class="comment">/*</span>
04790 <span class="comment">             * If the high-order bit of the type value is 0, this</span>
04791 <span class="comment">             * is a management frame.</span>
04792 <span class="comment">             * I.e, check "!(link[0] &amp; 0x08)".</span>
04793 <span class="comment">             */</span>
04794             s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
04795             s-&gt;s.k = 0;
04796             b2 = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
04797             b2-&gt;s.k = 0x08;
04798             b2-&gt;stmts = s;
04799             gen_not(b2);
04800 
04801             <span class="comment">/*</span>
04802 <span class="comment">             * For management frames, the DA is at 4.</span>
04803 <span class="comment">             */</span>
04804             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(4);
04805             gen_and(b2, b1);
04806 
04807             <span class="comment">/*</span>
04808 <span class="comment">             * OR that with the checks done for data frames.</span>
04809 <span class="comment">             * That gives the checks done for management and</span>
04810 <span class="comment">             * data frames.</span>
04811 <span class="comment">             */</span>
04812             gen_or(b1, b0);
04813 
04814             <span class="comment">/*</span>
04815 <span class="comment">             * If the low-order bit of the type value is 1,</span>
04816 <span class="comment">             * this is either a control frame or a frame</span>
04817 <span class="comment">             * with a reserved type, and thus not a</span>
04818 <span class="comment">             * frame with an SA.</span>
04819 <span class="comment">             *</span>
04820 <span class="comment">             * I.e., check "!(link[0] &amp; 0x04)".</span>
04821 <span class="comment">             */</span>
04822             s = <a class="code" href="gencode_8c.html#a71">new_stmt</a>(BPF_LD|BPF_B|BPF_ABS);
04823             s-&gt;s.k = 0;
04824             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a70">new_block</a>(<a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JSET));
04825             <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.k = 0x04;
04826             <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;stmts = s;
04827             gen_not(b1);
04828 
04829             <span class="comment">/*</span>
04830 <span class="comment">             * AND that with the checks for data and management</span>
04831 <span class="comment">             * frames.</span>
04832 <span class="comment">             */</span>
04833             gen_and(b1, b0);
04834             <span class="keywordflow">return</span> b0;
04835         }
04836 
04837         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_SUNATM &amp;&amp; <a class="code" href="gencode_8c.html#a36">is_lane</a>) {
04838             <span class="comment">/*</span>
04839 <span class="comment">             * Check that the packet doesn't begin with an</span>
04840 <span class="comment">             * LE Control marker.  (We've already generated</span>
04841 <span class="comment">             * a test for LANE.)</span>
04842 <span class="comment">             */</span>
04843             <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(SUNATM_PKT_BEGIN_POS, BPF_H, 0xFF00);
04844             gen_not(b1);
04845 
04846             <span class="comment">/* ether[off_mac] &amp; 1 != 0 */</span>
04847             b0 = <a class="code" href="gencode_8c.html#a107">gen_mac_multicast</a>(off_mac);
04848             gen_and(b1, b0);
04849             <span class="keywordflow">return</span> b0;
04850         }
04851 
04852         <span class="comment">/* Link not known to support multicasts */</span>
04853         <span class="keywordflow">break</span>;
04854 
04855     <span class="keywordflow">case</span> Q_IP:
04856         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IP);
04857         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 16, BPF_B, (bpf_int32)224);
04858         <a class="code" href="gencode_8c.html#a26">b1</a>-&gt;s.code = <a class="code" href="group__NPF__include.html#a105">JMP</a>(BPF_JGE);
04859         gen_and(b0, b1);
04860         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
04861 
04862 <span class="preprocessor">#ifdef INET6</span>
04863 <span class="preprocessor"></span>    <span class="keywordflow">case</span> Q_IPV6:
04864         b0 = <a class="code" href="gencode_8c.html#a85">gen_linktype</a>(ETHERTYPE_IPV6);
04865         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(off_nl + 24, BPF_B, (bpf_int32)255);
04866         gen_and(b0, b1);
04867         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
04868 <span class="preprocessor">#endif </span><span class="comment">/* INET6 */</span>
04869     }
04870     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"only IP multicast filters supported on ethernet/FDDI"</span>);
04871 }
04872 
04873 <span class="comment">/*</span>
04874 <span class="comment"> * generate command for inbound/outbound.  It's here so we can</span>
04875 <span class="comment"> * make it link-type specific.  'dir' = 0 implies "inbound",</span>
04876 <span class="comment"> * = 1 implies "outbound".</span>
04877 <span class="comment"> */</span>
04878 <span class="keyword">struct </span>block *
04879 gen_inbound(<a class="code" href="gencode_8c.html#a45">dir</a>)
04880     int <a class="code" href="gencode_8c.html#a45">dir</a>;
04881 {
04882     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0;
04883 
04884     <span class="comment">/*</span>
04885 <span class="comment">     * Only some data link types support inbound/outbound qualifiers.</span>
04886 <span class="comment">     */</span>
04887     <span class="keywordflow">switch</span> (linktype) {
04888     <span class="keywordflow">case</span> DLT_SLIP:
04889     <span class="keywordflow">case</span> DLT_PPP:
04890         b0 = gen_relation(BPF_JEQ,
04891               gen_load(Q_LINK, gen_loadi(0), 1),
04892               gen_loadi(0),
04893               dir);
04894         <span class="keywordflow">break</span>;
04895 
04896     <span class="keywordflow">case</span> DLT_LINUX_SLL:
04897         <span class="keywordflow">if</span> (dir) {
04898             <span class="comment">/*</span>
04899 <span class="comment">             * Match packets sent by this machine.</span>
04900 <span class="comment">             */</span>
04901             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(0, BPF_H, LINUX_SLL_OUTGOING);
04902         } <span class="keywordflow">else</span> {
04903             <span class="comment">/*</span>
04904 <span class="comment">             * Match packets sent to this machine.</span>
04905 <span class="comment">             * (No broadcast or multicast packets, or</span>
04906 <span class="comment">             * packets sent to some other machine and</span>
04907 <span class="comment">             * received promiscuously.)</span>
04908 <span class="comment">             *</span>
04909 <span class="comment">             * XXX - packets sent to other machines probably</span>
04910 <span class="comment">             * shouldn't be matched, but what about broadcast</span>
04911 <span class="comment">             * or multicast packets we received?</span>
04912 <span class="comment">             */</span>
04913             b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(0, BPF_H, LINUX_SLL_HOST);
04914         }
04915         <span class="keywordflow">break</span>;
04916 
04917     <span class="keywordflow">default</span>:
04918         <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"inbound/outbound not supported on linktype %d\n"</span>,
04919             linktype);
04920         b0 = NULL;
04921         <span class="comment">/* NOTREACHED */</span>
04922     }
04923     <span class="keywordflow">return</span> (b0);
04924 }
04925 
04926 <span class="keyword">struct </span>block *
04927 gen_acode(eaddr, <a class="code" href="gencode_8c.html#a52">q</a>)
04928     register const u_char *eaddr;
<a name="l04929"></a><a class="code" href="gencode_8c.html#a52">04929</a>     <span class="keyword">struct </span>qual <a class="code" href="gencode_8c.html#a52">q</a>;
04930 {
04931     <span class="keywordflow">if</span> ((<a class="code" href="gencode_8c.html#a52">q</a>.addr == Q_HOST || <a class="code" href="gencode_8c.html#a52">q</a>.addr == Q_DEFAULT) &amp;&amp; <a class="code" href="gencode_8c.html#a52">q</a>.proto == Q_LINK) {
04932         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_ARCNET || <a class="code" href="gencode_8c.html#a43">linktype</a> == DLT_ARCNET_LINUX)
04933             <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(eaddr, (<span class="keywordtype">int</span>)<a class="code" href="gencode_8c.html#a52">q</a>.dir);
04934     }
04935     <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"ARCnet address used in non-arc expression"</span>);
04936     <span class="comment">/* NOTREACHED */</span>
04937 }
04938 
04939 <span class="keyword">static</span> <span class="keyword">struct </span>block *
04940 <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(eaddr, <a class="code" href="gencode_8c.html#a45">dir</a>)
04941     register const u_char *eaddr;
<a name="l04942"></a><a class="code" href="gencode_8c.html#a45">04942</a>     <span class="keyword">register</span> <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a45">dir</a>;
04943 {
04944     <span class="keyword">register</span> <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
04945 
04946     <span class="keywordflow">switch</span> (dir) {
04947     <span class="comment">/* src comes first, different from Ethernet */</span>
04948     <span class="keywordflow">case</span> Q_SRC:
04949         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(0, 1, eaddr);
04950 
04951     <span class="keywordflow">case</span> Q_DST:
04952         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a79">gen_bcmp</a>(1, 1, eaddr);
04953 
04954     <span class="keywordflow">case</span> Q_AND:
04955         b0 = <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(eaddr, Q_SRC);
04956         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(eaddr, Q_DST);
04957         gen_and(b0, b1);
04958         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
04959 
04960     <span class="keywordflow">case</span> Q_DEFAULT:
04961     <span class="keywordflow">case</span> Q_OR:
04962         b0 = <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(eaddr, Q_SRC);
04963         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a89">gen_ahostop</a>(eaddr, Q_DST);
04964         gen_or(b0, b1);
04965         <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
04966     }
04967     abort();
04968     <span class="comment">/* NOTREACHED */</span>
04969 }
04970 
04971 <span class="comment">/*</span>
04972 <span class="comment"> * support IEEE 802.1Q VLAN trunk over ethernet</span>
04973 <span class="comment"> */</span>
04974 <span class="keyword">struct </span>block *
04975 gen_vlan(vlan_num)
04976     int vlan_num;
04977 {
04978     <span class="keyword">struct  </span>block   *b0;
04979 
04980     <span class="comment">/*</span>
04981 <span class="comment">     * Change the offsets to point to the type and data fields within</span>
04982 <span class="comment">     * the VLAN packet.  This is somewhat of a kludge.</span>
04983 <span class="comment">     */</span>
04984     <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a17">orig_nl</a> == (u_int)-1) {
04985         <a class="code" href="gencode_8c.html#a16">orig_linktype</a> = <a class="code" href="gencode_8c.html#a34">off_linktype</a>;   <span class="comment">/* save original values */</span>
04986         <a class="code" href="gencode_8c.html#a17">orig_nl</a> = <a class="code" href="gencode_8c.html#a41">off_nl</a>;
04987         <a class="code" href="gencode_8c.html#a18">orig_nl_nosnap</a> = <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a>;
04988 
04989         <span class="keywordflow">switch</span> (linktype) {
04990 
04991         <span class="keywordflow">case</span> DLT_EN10MB:
04992             <a class="code" href="gencode_8c.html#a34">off_linktype</a> = 16;
04993             <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = 18;
04994             <a class="code" href="gencode_8c.html#a41">off_nl</a> = 18;
04995             <span class="keywordflow">break</span>;
04996 
04997         <span class="keywordflow">default</span>:
04998             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"no VLAN support for data link type %d"</span>,
04999                   linktype);
05000             <span class="comment">/*NOTREACHED*/</span>
05001         }
05002     }
05003 
05004     <span class="comment">/* check for VLAN */</span>
05005     b0 = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(orig_linktype, BPF_H, (bpf_int32)ETHERTYPE_8021Q);
05006 
05007     <span class="comment">/* If a specific VLAN is requested, check VLAN id */</span>
05008     <span class="keywordflow">if</span> (vlan_num &gt;= 0) {
05009         <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a26">b1</a>;
05010 
05011         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a76">gen_cmp</a>(orig_nl, BPF_H, (bpf_int32)vlan_num);
05012         gen_and(b0, b1);
05013         b0 = <a class="code" href="gencode_8c.html#a26">b1</a>;
05014     }
05015 
05016     <span class="keywordflow">return</span> (b0);
05017 }
05018 
05019 <span class="keyword">struct </span>block *
05020 gen_atmfield_code(atmfield, <a class="code" href="gencode_8c.html#a32">jvalue</a>, <a class="code" href="gencode_8c.html#a31">jtype</a>, <a class="code" href="gencode_8c.html#a33">reverse</a>)
05021     int atmfield;
<a name="l05022"></a><a class="code" href="gencode_8c.html#a32">05022</a>     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a32">jvalue</a>;
<a name="l05023"></a><a class="code" href="gencode_8c.html#a31">05023</a>     <a class="code" href="group__wpcap__def.html#a1">bpf_u_int32</a> <a class="code" href="gencode_8c.html#a31">jtype</a>;
<a name="l05024"></a><a class="code" href="gencode_8c.html#a33">05024</a>     <span class="keywordtype">int</span> <a class="code" href="gencode_8c.html#a33">reverse</a>;
05025 {
05026     <span class="keyword">struct </span>block *b0;
05027 
05028     <span class="keywordflow">switch</span> (atmfield) {
05029 
05030     <span class="keywordflow">case</span> A_VPI:
05031         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05032             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'vpi' supported only on raw ATM"</span>);
05033         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a37">off_vpi</a> == -1)
05034             abort();
05035         b0 = <a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(BPF_B, off_vpi, 0xffffffff, (u_int)jtype,
05036             (u_int)jvalue, reverse);
05037         <span class="keywordflow">break</span>;
05038 
05039     <span class="keywordflow">case</span> A_VCI:
05040         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05041             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'vci' supported only on raw ATM"</span>);
05042         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a38">off_vci</a> == -1)
05043             abort();
05044         b0 = <a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(BPF_H, off_vci, 0xffffffff, (u_int)jtype,
05045             (u_int)jvalue, reverse);
05046         <span class="keywordflow">break</span>;
05047 
05048     <span class="keywordflow">case</span> A_PROTOTYPE:
05049         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a39">off_proto</a> == -1)
05050             abort();    <span class="comment">/* XXX - this isn't on FreeBSD */</span>
05051         b0 = <a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(BPF_B, off_proto, 0x0f, (u_int)jtype,
05052             (u_int)jvalue, reverse);
05053         <span class="keywordflow">break</span>;
05054 
05055     <span class="keywordflow">case</span> A_MSGTYPE:
05056         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a40">off_payload</a> == -1)
05057             abort();
05058         b0 = <a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(BPF_B, off_payload + MSG_TYPE_POS, 0xffffffff,
05059             (u_int)jtype, (u_int)jvalue, reverse);
05060         <span class="keywordflow">break</span>;
05061 
05062     <span class="keywordflow">case</span> A_CALLREFTYPE:
05063         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05064             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'callref' supported only on raw ATM"</span>);
05065         <span class="keywordflow">if</span> (<a class="code" href="gencode_8c.html#a39">off_proto</a> == -1)
05066             abort();
05067         b0 = <a class="code" href="gencode_8c.html#a80">gen_ncmp</a>(BPF_B, off_proto, 0xffffffff, (u_int)jtype,
05068             (u_int)jvalue, reverse);
05069         <span class="keywordflow">break</span>;
05070 
05071     <span class="keywordflow">default</span>:
05072         abort();
05073     }
05074     <span class="keywordflow">return</span> b0;
05075 }
05076 
05077 <span class="keyword">struct </span>block *
05078 gen_atmtype_abbrev(type)
05079     int type;
05080 {
05081     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
05082 
05083     <span class="keywordflow">switch</span> (type) {
05084 
05085     <span class="keywordflow">case</span> A_METAC:
05086         <span class="comment">/* Get all packets in Meta signalling Circuit */</span>
05087         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05088             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'metac' supported only on raw ATM"</span>);
05089         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05090         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 1, BPF_JEQ, 0);
05091         gen_and(b0, b1);
05092         <span class="keywordflow">break</span>;
05093 
05094     <span class="keywordflow">case</span> A_BCC:
05095         <span class="comment">/* Get all packets in Broadcast Circuit*/</span>
05096         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05097             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'bcc' supported only on raw ATM"</span>);
05098         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05099         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 2, BPF_JEQ, 0);
05100         gen_and(b0, b1);
05101         <span class="keywordflow">break</span>;
05102 
05103     <span class="keywordflow">case</span> A_OAMF4SC:
05104         <span class="comment">/* Get all cells in Segment OAM F4 circuit*/</span>
05105         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05106             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'oam4sc' supported only on raw ATM"</span>);
05107         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05108         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 3, BPF_JEQ, 0);
05109         gen_and(b0, b1);
05110         <span class="keywordflow">break</span>;
05111 
05112     <span class="keywordflow">case</span> A_OAMF4EC:
05113         <span class="comment">/* Get all cells in End-to-End OAM F4 Circuit*/</span>
05114         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05115             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'oam4ec' supported only on raw ATM"</span>);
05116         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05117         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 4, BPF_JEQ, 0);
05118         gen_and(b0, b1);
05119         <span class="keywordflow">break</span>;
05120 
05121     <span class="keywordflow">case</span> A_SC:
05122         <span class="comment">/*  Get all packets in connection Signalling Circuit */</span>
05123         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05124             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'sc' supported only on raw ATM"</span>);
05125         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05126         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 5, BPF_JEQ, 0);
05127         gen_and(b0, b1);
05128         <span class="keywordflow">break</span>;
05129 
05130     <span class="keywordflow">case</span> A_ILMIC:
05131         <span class="comment">/* Get all packets in ILMI Circuit */</span>
05132         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05133             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'ilmic' supported only on raw ATM"</span>);
05134         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05135         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 16, BPF_JEQ, 0);
05136         gen_and(b0, b1);
05137         <span class="keywordflow">break</span>;
05138 
05139     <span class="keywordflow">case</span> A_LANE:
05140         <span class="comment">/* Get all LANE packets */</span>
05141         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05142             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'lane' supported only on raw ATM"</span>);
05143         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_PROTOTYPE, PT_LANE, BPF_JEQ, 0);
05144 
05145         <span class="comment">/*</span>
05146 <span class="comment">         * Arrange that all subsequent tests assume LANE</span>
05147 <span class="comment">         * rather than LLC-encapsulated packets, and set</span>
05148 <span class="comment">         * the offsets appropriately for LANE-encapsulated</span>
05149 <span class="comment">         * Ethernet.</span>
05150 <span class="comment">         *</span>
05151 <span class="comment">         * "off_mac" is the offset of the Ethernet header,</span>
05152 <span class="comment">         * which is 2 bytes past the ATM pseudo-header</span>
05153 <span class="comment">         * (skipping the pseudo-header and 2-byte LE Client</span>
05154 <span class="comment">         * field).  The other offsets are Ethernet offsets</span>
05155 <span class="comment">         * relative to "off_mac".</span>
05156 <span class="comment">         */</span>
05157         <a class="code" href="gencode_8c.html#a36">is_lane</a> = 1;
05158         off_mac = <a class="code" href="gencode_8c.html#a40">off_payload</a> + 2;  <span class="comment">/* MAC header */</span>
05159         <a class="code" href="gencode_8c.html#a34">off_linktype</a> = off_mac + 12;
05160         <a class="code" href="gencode_8c.html#a41">off_nl</a> = off_mac + 14;      <span class="comment">/* Ethernet II */</span>
05161         <a class="code" href="gencode_8c.html#a42">off_nl_nosnap</a> = off_mac + 17;   <span class="comment">/* 802.3+802.2 */</span>
05162         <span class="keywordflow">break</span>;
05163 
05164     <span class="keywordflow">case</span> A_LLC:
05165         <span class="comment">/* Get all LLC-encapsulated packets */</span>
05166         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05167             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'llc' supported only on raw ATM"</span>);
05168         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_PROTOTYPE, PT_LLC, BPF_JEQ, 0);
05169         <a class="code" href="gencode_8c.html#a36">is_lane</a> = 0;
05170         <span class="keywordflow">break</span>;
05171 
05172     <span class="keywordflow">default</span>:
05173         abort();
05174     }
05175     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
05176 }
05177 
05178 
05179 <span class="keyword">static</span> <span class="keyword">struct </span>block *
05180 <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(type)
05181     int type;
05182 {
05183     <span class="keyword">struct </span>block *<a class="code" href="gencode_8c.html#a26">b1</a>;
05184 
05185     <span class="comment">/*</span>
05186 <span class="comment">     * Q.2931 signalling protocol messages for handling virtual circuits</span>
05187 <span class="comment">     * establishment and teardown</span>
05188 <span class="comment">     */</span>
05189     <span class="keywordflow">switch</span> (type) {
05190 
05191     <span class="keywordflow">case</span> A_SETUP:
05192         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_MSGTYPE, SETUP, BPF_JEQ, 0);
05193         <span class="keywordflow">break</span>;
05194 
05195     <span class="keywordflow">case</span> A_CALLPROCEED:
05196         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_MSGTYPE, CALL_PROCEED, BPF_JEQ, 0); 
05197         <span class="keywordflow">break</span>;
05198 
05199     <span class="keywordflow">case</span> A_CONNECT:
05200         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_MSGTYPE, CONNECT, BPF_JEQ, 0);
05201         <span class="keywordflow">break</span>;             
05202 
05203     <span class="keywordflow">case</span> A_CONNECTACK:
05204         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_MSGTYPE, CONNECT_ACK, BPF_JEQ, 0);  
05205         <span class="keywordflow">break</span>;
05206 
05207     <span class="keywordflow">case</span> A_RELEASE:
05208         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_MSGTYPE, RELEASE, BPF_JEQ, 0);
05209         <span class="keywordflow">break</span>;
05210 
05211     <span class="keywordflow">case</span> A_RELEASE_DONE:
05212         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_MSGTYPE, RELEASE_DONE, BPF_JEQ, 0);  
05213         <span class="keywordflow">break</span>;
05214 
05215     <span class="keywordflow">default</span>:
05216         abort();
05217     }
05218     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
05219 }
05220 
05221 <span class="keyword">struct </span>block *
05222 gen_atmmulti_abbrev(type)
05223     int type;
05224 {
05225     <span class="keyword">struct </span>block *b0, *<a class="code" href="gencode_8c.html#a26">b1</a>;
05226 
05227     <span class="keywordflow">switch</span> (type) {
05228 
05229     <span class="keywordflow">case</span> A_OAM:
05230         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05231             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'oam' supported only on raw ATM"</span>);
05232         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmmulti_abbrev(A_OAMF4);
05233         <span class="keywordflow">break</span>;
05234 
05235     <span class="keywordflow">case</span> A_OAMF4:
05236         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05237             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'oamf4' supported only on raw ATM"</span>);
05238         <span class="comment">/* OAM F4 type */</span>
05239         b0 = gen_atmfield_code(A_VCI, 3, BPF_JEQ, 0); 
05240         <a class="code" href="gencode_8c.html#a26">b1</a> = gen_atmfield_code(A_VCI, 4, BPF_JEQ, 0);
05241         gen_or(b0, b1); 
05242         b0 = gen_atmfield_code(A_VPI, 0, BPF_JEQ, 0);
05243         gen_and(b0, b1);
05244         <span class="keywordflow">break</span>;
05245 
05246     <span class="keywordflow">case</span> A_CONNECTMSG:
05247         <span class="comment">/*</span>
05248 <span class="comment">         * Get Q.2931 signalling messages for switched</span>
05249 <span class="comment">         * virtual connection</span>
05250 <span class="comment">         */</span>
05251         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05252             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'connectmsg' supported only on raw ATM"</span>);
05253         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_SETUP);
05254         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_CALLPROCEED);
05255         gen_or(b0, b1);
05256         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_CONNECT);
05257         gen_or(b0, b1);
05258         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_CONNECTACK);
05259         gen_or(b0, b1);
05260         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_RELEASE);
05261         gen_or(b0, b1);
05262         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_RELEASE_DONE);
05263         gen_or(b0, b1);
05264         b0 = gen_atmtype_abbrev(A_SC);
05265         gen_and(b0, b1);
05266         <span class="keywordflow">break</span>;
05267 
05268     <span class="keywordflow">case</span> A_METACONNECT:
05269         <span class="keywordflow">if</span> (!<a class="code" href="gencode_8c.html#a35">is_atm</a>)
05270             <a class="code" href="gencode_8c.html#a64">bpf_error</a>(<span class="stringliteral">"'metaconnect' supported only on raw ATM"</span>);
05271         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_SETUP);
05272         <a class="code" href="gencode_8c.html#a26">b1</a> = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_CALLPROCEED);
05273         gen_or(b0, b1);
05274         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_CONNECT);
05275         gen_or(b0, b1);
05276         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_RELEASE);
05277         gen_or(b0, b1);
05278         b0 = <a class="code" href="gencode_8c.html#a109">gen_msg_abbrev</a>(A_RELEASE_DONE);
05279         gen_or(b0, b1);
05280         b0 = gen_atmtype_abbrev(A_METAC);
05281         gen_and(b0, b1);
05282         <span class="keywordflow">break</span>;
05283 
05284     <span class="keywordflow">default</span>:
05285         abort();
05286     }
05287     <span class="keywordflow">return</span> <a class="code" href="gencode_8c.html#a26">b1</a>;
05288 }
</pre></div>
<hr>
<p align="right"><img border="0" src="winpcap_small.gif" align="absbottom" width="91" height="27">
documentation. Copyright (c) 2002-2003 Politecnico di Torino. All rights reserved.</p>
