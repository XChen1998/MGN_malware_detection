#include "fltdrvKernel.h"
#include "process.h"

VOID ComputeOSID(char * object);

VOID PrintFileName(PFLT_FILE_NAME_INFORMATION name)
{
	NTSTATUS status;
	PEPROCESS pep;
	UNICODE_STRING fName;
	ANSI_STRING temp_ansi, temp_ansi_1, temp_ansi_2;
	char buffer[3000];
	char buffer_write[3000];
	
	if(name == NULL) return;
	
	FltParseFileNameInformation(name);
	RtlUnicodeStringToAnsiString(&temp_ansi,  &name->Name, TRUE);
	
	RtlZeroMemory(&buffer, sizeof(buffer));
	RtlZeroMemory(&buffer_write, sizeof(buffer_write));
	
	sprintf_s(buffer, sizeof(buffer), "%s", temp_ansi.Buffer);
	RtlFreeAnsiString(&temp_ansi);
	if(&name->FinalComponent != NULL)
	{
		if(strlen(buffer) > 3000) 
		{
			DbgPrint("Buffer Overflow %i %wZ \n", name->Name);
			return ;		
		}
		PsLookupProcessByProcessId(PsGetCurrentProcessId(),&pep);
		sprintf_s(buffer_write,sizeof(buffer_write), "pid : %s %i \n",PsGetProcessImageFileName(pep), (int)PsGetCurrentProcessId());
		AddInQueue(buffer_write);
		RtlZeroMemory(&buffer_write, sizeof(buffer_write));
		sprintf_s(buffer_write,sizeof(buffer_write), "Object Name : %s \n", buffer);
		AddInQueue(buffer_write);
	}
	else
		DbgPrint("BUFFFER %s \n", buffer);
	
}

VOID ComputeOSID(char * object)
{
	int i=0, j=0;
	char * ssid_return = NULL;
	char buffer_ansi[1024];
	int taille =strlen("\\Device\\HarddiskVolume2");
	
	// if(strlen(object) ==  taille+1)
	// {
		// DbgPrint("Object Name : \\ \n");
		// DbgPrint("Object security context : system_t \n");	
		// return;
	// }
	
	RtlZeroMemory(&buffer_ansi,sizeof(buffer_ansi));
	
	ssid_return =  ExAllocatePool(PagedPool, sizeof(char)*2048);
	if(ssid_return == NULL)
	{
		DbgPrint("Echec ExallocatePool for sid compute \n");
		return;
	}
	
	sprintf_s(buffer_ansi,sizeof(buffer_ansi),"%s\0", &object[taille]);
	
	while(buffer_ansi[i] != '\0' || (i == sizeof(ssid_return)))
	{
		if( (i==0) && (buffer_ansi[i]!='\\'))
			return;
		if( (i==0) && (buffer_ansi[i] =='\\'))
		{
			i++;
			continue;
		}
		if(buffer_ansi[i] == '\\')
		{
			ssid_return[j] = '_';
		}
		else
		{
			if(buffer_ansi[i] ==  ' ')
			{
				i++;
				continue;
			}
			else
			{
				if(buffer_ansi[i] <= 'Z' && buffer_ansi[i] >= 'A')
					ssid_return[j]= (buffer_ansi[i] -'A') + 'a';
				else
					ssid_return[j] = buffer_ansi[i];
			}
		}
		i++;
		j++;
	}
	ssid_return[j]='\0';
	
	DbgPrint("Object Name : %s \n", object);
	DbgPrint("Object security context : %s \n", ssid_return);
}