#ifndef __PROCESS__
#define __PROCESS__

#include <fltKernel.h>
#include <ntddk.h>
#include <ntifs.h>

#include <stdio.h>

#include "fltdrvKernel.h"
int trace;
int GetParentId(int pid);
int GetSessionId(int pid);
VOID GetUnicodeName(int pid);
INT GetUnicodeName_only(int pid);

char * ComputeSSID(PUNICODE_STRING fullname);

HANDLE handle;

VOID WriteInLog(char * buffer);

PFAST_MUTEX FastMutex;


UCHAR *PsGetProcessImageFileName(IN PEPROCESS pep);

NTSYSAPI
NTSTATUS
NTAPI ZwQueryInformationProcess(
  __in       HANDLE ProcessHandle,
  __in       PROCESSINFOCLASS ProcessInformationClass,
  __out      PVOID ProcessInformation,
  __in       ULONG ProcessInformationLength,
  __out_opt  PULONG ReturnLength
);

//PPEB NTAPI PsGetProcessPeb 	( 	PEPROCESS  	Process	) ;

/**
 * Stucture contenant les informations pour les processus
 * processname : le path complet (moins le point de montage)
 * hash_process : le hash du ssid.
**/
typedef struct _process_struct {
	
	struct _process_struct *Next;
	UNICODE_STRING processname;
	int pid;
	int ppid;
	char ssid[2048];
	unsigned long hash_process;
} Process_Struct;


int DetectPid();

typedef struct _callgraph_struct {
	struct _callgraph_struct *Suivant;
	// struct _callgraph_struct *Precedent;
	int pid;
	int ppid;
	UNICODE_STRING full;
} Callgraph;

Callgraph * call;// =NULL;
Callgraph * list_head;// = NULL;

Callgraph * AddProcGraph(int pid, int ppid, Callgraph *list);
VOID InitGraphCall();
VOID DestroyGraph();
VOID RemProcGraph(int pid, int ppid, Callgraph *list);
VOID PrintList(Callgraph *list);
VOID PrintFather(int pid, Callgraph *list);
int CallGraph(int pid, int ppid, int create);

#endif