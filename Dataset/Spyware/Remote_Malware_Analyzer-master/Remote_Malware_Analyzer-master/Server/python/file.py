from  mysql import *
import sys

if __name__ == "__main__":
   if len(sys.argv) < 2:
      print("donnez un fichier en entree")
      sys.exit(1)

   fichier = sys.argv[1]
   try:
      op = open(fichier, "r")
   except:
      print "ta mere"
      sys.exit(1)

   dbconfig = dbconfig()
   db2 = dbinterface(dbconfig)
   run = db2.newIdSession("AZERT1222")
   corps = op.readlines()
   process = 0
   action = 0
   creation = 0
   buf=""
   for f in corps:
       traitement =  f.replace('\n', '')
       if traitement == "------- End loading" and action==1:
          db2.addAction(buf, run)
          action=0
          buf=""
          continue
       if traitement == "------- Loading":
          action =1
          continue
       if traitement == "------ Create process":
          creation =1
          continue
       if traitement == "------- Enter in IRP":
          action=1
          buf=""
          continue
       if traitement == "-------- Exit IRP" and action==1:
          db2.addAction(buf, run)
          action=0
          buf=""
          continue
       if traitement == "---- Begin":
          continue
       if traitement == "---- END" and creation==1:
          db2.addCreateProcess(buf,run)
          buf=""
          creation=0
          continue
       if traitement == "---- END":
          continue
       if traitement == "------- Fin du detect PID":
          process=0
          continue
       if traitement == "First one":
          process=1
          continue
       if process == 1:
          if "Parent" in traitement:
             continue
          db2.addProcess(traitement, run) 
       if action == 1:
          buf = buf + traitement + "\n"
          continue
       if creation == 1:
          buf = buf + traitement + "\n" 
          continue
   op.close()
   print "toto"
