#include <stdio.h>
#include <Windows.h>

int IsInsideVMWare()
{
  bool rc = true;
  char vm[] = "VMXh";
  char port[] = "VX";

  __try
  {
    __asm{
      push edx
      push ecx
      push ecx
      push ebx
      push ebx

      mov eax, 'VMXh'
      mov ebx, 0  //any value but not the MAGIC VALUE
      mov ecx, 10 // get VMWare versiond
      mov edx, 'VX'

      in eax, dx  //read port

      cmp ebx, 'VMXh' // is it a replay from VMWare
      setz rc
      pop ebx
      pop ecx
      pop edx
    }
  }
  __except(EXCEPTION_EXECUTE_HANDLER)
  {
    rc = false;
  }

  return rc;
}

int main() {
    if(IsInsideVMWare()){
      printf("vm");
    }else{
      printf("no vm");
    }
    return 0 ;
}
