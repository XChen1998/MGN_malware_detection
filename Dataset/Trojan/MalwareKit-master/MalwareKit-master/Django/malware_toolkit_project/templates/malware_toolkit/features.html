{% extends 'codeUI.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js_2 %}
<script>

function setHeader(index){
  var funcList = document.getElementById("function-selector").children;
  document.getElementById('header-text').value = funcList[index].getAttribute('header');
}

function functionSelectorChanged(){
  var elem = document.getElementById('function-selector');
  var selectedFunc = elem.value;
  var options = elem.children;
  for(i = 0; i < options.length; i++){
    if(options[i].value == selectedFunc){
      if(options[i].getAttribute('state') == 'unused'){
        options[i].innerHTML = "&#9745" + options[i].text.substr(1, options[i].text.length);
        options[i].setAttribute('state', 'used');
      }else if(options[i].getAttribute('state') == 'used'){
        options[i].innerHTML = "&#9744" + options[i].text.substr(1, options[i].text.length);
        options[i].setAttribute('state', 'unused');
      }
      setHeader(i);
    }
  }
}

function uncheckAllFunctions(){
  var options = document.getElementById('function-selector').children;
  for (i = 0; i < options.length; i++){
    options[i].innerHTML = "&#9744" + options[i].text.substr(1, options[i].text.length);
    options[i].setAttribute('state', 'unused');
  }
}

function checkUsedFunctions(used_functions){
  uncheckAllFunctions();
  var options = document.getElementById('function-selector').children;
  for(i = 0; i < used_functions.length; i++){
    for (j = 0; j < options.length; j++){
      if(used_functions[i] == options[j].value){
        options[j].innerHTML = "&#9745" + options[j].text.substr(1, options[j].text.length);
        options[j].setAttribute('state', 'used');
      }
    }
  }
}

function getAllUsedFunctions(){
  var sel = document.getElementById('function-selector');
  var options = sel.children;
  var usedFuncs = [];
  for(i = 0; i < options.length; i++){
    if(options[i].getAttribute('state') == 'used'){
      usedFuncs.push(options[i].value);
    }
  }
  return usedFuncs;
}

function setTypeSelection(type_str){
  document.getElementById('type-name').value = type_str;
}

function getFeature(){
  var feature_name = $("#feature-name").val();
  if(feature_name != ""){
        var feat = {
          "name": feature_name,
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"GET",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/api/feature",
          data: feat,
          success: function(msg) {
            if(msg != 400){
              var feat = JSON.parse(msg)
              var priority = feat.priority
              var type = feat.type
              var body = feat.body
              var functions = feat.functions
              checkUsedFunctions(functions);
              setElementText("#globals-text", feat.globals);
              setElementText("#imports-text", feat.imports);
              setElementText("#priority-text", priority.toString());
              setElementText("#body-text", body);
              document.getElementById("prompt-text").value = feat.prompt;
              setElementText("#options-text", feat.options);
              setTypeSelection(type);
            }
          }
        });
  }
}

function deleteFeature(){
  var del = confirm("Are you sure you want to permanently delete this feature?");
  if(del){
    var feature_name = $("#feature-name").val();
    var feat = {
      "name": feature_name,
    };

    var csrftoken = getCookie('csrftoken');
    $.ajax({
      type:"DELETE",
      beforeSend: function (request)
      {
        request.setRequestHeader("X-CSRFToken", csrftoken);
      },
      url: "/malware_toolkit/api/feature",
      data: JSON.stringify(feat),
      success: function(res) {
        if(res == 200){
          fadeMsg("Feature " + feat['name'] + " has been deleted");
          $("#feature-name").val("");
          $("#body-text").val("");
          $("#priority-text").val("1");
          $("#type-text").val("");

          removeFromListByName("feature_list", feat['name']);
        }else{
          fadeMsg("Error deleting Feature");
        }
      }
    });
  }
}

function addUpdateFeature(){
  var feature_name = $("#feature-name").val();
  var body = $("#body-text").val();
  var global_vars = $("#globals-text").val();
  var imports = $("#imports-text").val();
  var priority = $("#priority-text").val();
  var type = $("#type-name").val();
  var prompt = $("#prompt-text").val();
  var options = $('#options-text').val();

  if(feature_name != "" && priority != ""){
        globals = makeArray(replaceBadChars(global_vars));
        imports = makeArray(replaceBadChars(imports));
        body = makeArray(body);
        options = makeArray(options);

        console.log(globals);

        var feat = {
          "name": feature_name,
          "body": body,
          "global": globals,
          "import": imports,
          "priority": priority,
          "type": type,
          "functions": getAllUsedFunctions(),
          "prompt": prompt,
          "options": options
        };

        var csrftoken = getCookie('csrftoken');
        $.ajax({
          type:"POST",
          beforeSend: function (request)
          {
            request.setRequestHeader("X-CSRFToken", csrftoken);
          },
          url: "/malware_toolkit/add_feature/",
          data: JSON.stringify(feat),
          processData: false,
          success: function(res) {
            if(res == '200' || res == 200){
              fadeMsg("Database Updated");
            }else{
              fadeMsg("Error");
            }
          }
        });
  }
}

$(document).ready(function(){
  document.getElementById('submit-btn').addEventListener('click', addUpdateFeature);
  document.getElementById('feature-delete-btn').addEventListener('click', deleteFeature);
  document.getElementById('feature-name').addEventListener('input', getFeature);
});

</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper">

    <a href="/malware_toolkit/functions">Functions</a>
    </br>
    <a href="/malware_toolkit/toolkit">Toolkit</a>

    <div style="clear: both"></div>

    <div class="col-md-8">
      <div id="row-1" class="row form-group">
        <label>Feature:</label></br>
      </div>
      <div id="row-1-c1" class="row" style="float: left;">
        <input list="feature_list" id="feature-name" class="form-control">
          <datalist id="feature_list">
            {% for f in features %}
              <option value="{{ f }}"></option>
            {% endfor %}
          </datalist>
        </option>
      </div>
      <!-- </br> -->
      <div id="row-1-c2" style="float: left; padding-left:25px">
        <button id="feature-delete-btn" class="btn btn-default">Delete</button>
      </div>
      <div style="clear: both"></div>
      <!-- close row-1 -->

      <div id="row-2" class="row form-group">
        <div id="row-3-c1" style="float: left">
          <label>Function Header:</label></br>
          <input list="header-list" id="header-text"
            style="background: lightgray; width: 350px"  class="form-control">
            <datalist id="header-list">
              {% for i, v in headers.items %}
                <option id="{{ i }}" value="{{ v }}"></option>
              {% endfor %}
            </datalist>
          </input>
        </div>
      </div>
      <div style="clear: both"></div>
      <!-- close row-2 -->

      <div id="row-4"  class="row form-group">
        <div id="row-4-c1" style="float: left">
          <label>Code in Body:</label></br>
          <textarea id="body-text" class="form-control"
            rows="15" cols="50"></textarea>
        </div>
        <div id="row-4-c2" style="float: left; padding-left: 15px">
          <label>Functions Used:</label></br>
          <select multiple id="function-selector" class="form-control"
            onchange="functionSelectorChanged()"
            style="width:250px; height:314px">
            {% for func in functions %}
              <option value="{{ func.name }}" header="{{ func.header }}" state="unused">&#9744 {{ func.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div style="clear: both"></div>
      <!-- close row-3 -->

      <div id="row-4" class="row form-group">
        <label>Global Variables:</label></br>
        <textarea id="globals-text" rows="3" class="form-control" style="max-width:450px"></textarea>
      </div>
      <!-- close row-4 -->

      <div id="row-5" class="row form-group">
        <label>Imports:</label></br>
        <textarea id="imports-text" rows="3" class="form-control" style="max-width:450px"></textarea>
      </div>
      <!-- close row-5 -->

      <div id="row-6"  class="row form-group">
        <label>Priority:</label></br>
        <input id="priority-text" class="form-control" style="max-width:350px" value="1"></input>
      </div>
      <!-- close row-6 -->

      <div id="row-7"  class="row form-group">
        <label>Feature type:</label></br>
        <input list="type_list" id="type-name" class="form-control"  style="max-width:350px">
        <datalist id="type_list">
          {% for t in feature_types %}
            <option id={{ t }} value="{{ t }}"></option>
          {% endfor %}
        </datalist>
        </div>
      <!-- close row-7 -->

      <div id="row-8" class="row form-group">
        <label>Toolkit Prompt:</label></br>
        <textarea id="prompt-text" class="form-control" style="max-width:350px"></textarea>
      </div>
      <!-- close row-8 -->

      <div id="row-9" class="row form-group">
        <label>Toolkit Options:</label></br>
        <textarea id="options-text" class="form-control" style="max-width:350px"rows="5"></textarea>
      </div>
      <!-- close row-9 -->

      <div id="row-10" class="row form-group">
        <button id="submit-btn" class="btn btn-primary">Submit</button>
      </div>
      <!-- close row-10 -->
    </div>
    <!-- close column -->

  </div>
  <!-- close top-wrapper -->
{% endblock %}
