{% extends 'base.html' %}

{% load staticfiles %}

{% block title %}{{ title }}{% endblock %}

{% block js_1 %}

<script>

function getRadioValueByName(name){
  var ret;
  var radios = document.getElementsByName(name);
  for(i in radios){
    if(radios[i].checked){
      ret = radios[i].value;
      break;
    }
  }
  return ret;
}

function getSelectedTimes(){
  var timeSelect = document.getElementById('trigger-times');
  if(timeSelect.hasAttribute('disabled')){
    // if its disabled return nothing
    return "";
  }

  var options = document.getElementById('trigger-times').options;
  var times = [];
  for(i = 0; i < options.length; i++){
    if(options[i].selected == true)
      times.push(options[i].value);
  }
  return times;
}

function getActionLimit(){
  var countBox = document.getElementById('action-limit-text');
  if(countBox.hasAttribute('disabled')){
    // if its disabled return nothing
    return "";
  }

  var limit = document.getElementById('action-limit-text').value;
  return limit;
}

function getActionFrequency(){
  var freqInput = document.getElementById('action-frequency-text');
  if(freqInput.hasAttribute('disabled')){
    // if its disabled return nothing
    return "";
  }

  var freq = document.getElementById('action-frequency-text').value;
  return freq;
}

function getMaxActionLimit(){
  var countBox = document.getElementById('max-action-limit-text');
  if(countBox.hasAttribute('disabled')){
    // if its disabled return nothing
    return "";
  }

  return countBox.value;
}

function getBotmasterIP(){
  return document.getElementById('botmaster-ip-text').value;
}

function getBotmasterPort(){
  return document.getElementById('botmaster-port-text').value;
}

function timeClicked(){
  var box = document.getElementById('time-checkbox');
  if(box.checked){
    var timeSelect = document.getElementById('trigger-times');
    var countBox = document.getElementById('action-limit-text');
    timeSelect.removeAttribute('disabled');
    countBox.removeAttribute('disabled');
  }else{
    var timeSelect = document.getElementById('trigger-times');
    var countBox = document.getElementById('action-limit-text');
    timeSelect.setAttribute('disabled', "");
    countBox.setAttribute('disabled', "");
  }
}

function frequencyClicked(){
  var box = document.getElementById('frequency-checkbox');
  if(box.checked){
    var freqInput = document.getElementById('action-frequency-text');
    freqInput.removeAttribute('disabled');
  }else{
    var freqInput = document.getElementById('action-frequency-text');
    freqInput.setAttribute('disabled', "");
  }
}

function maxLimitClicked(){
  var box = document.getElementById('max-action-limit-checkbox');
  var limitInput = document.getElementById('max-action-limit-text');
  if(box.checked){
    limitInput.removeAttribute('disabled');
  }else{
    limitInput.setAttribute('disabled', "");
  }
}

function sendBuildRequest(){
  setDownloadBtnEnabled(false);
  var csrftoken = getCookie('csrftoken');
  var data = getUsersFeatureSelections();
  var times = getSelectedTimes();
  var limit = getActionLimit();
  var totalLimit = getMaxActionLimit();
  var frequency = getActionFrequency();
  var ip = getBotmasterIP();
  var port = getBotmasterPort();

  if(times.length > 0){
    data['Pull Times'] = times;
  }
  if(limit != ""){
    data['Action Limit'] = limit;
  }
  if(totalLimit != ""){
    data['Maximum Action Limit'] = totalLimit;
  }
  if(frequency != ""){
    data['Action Frequency'] = frequency;
  }
  if(ip != ""){
    data['Botmaster IP'] = ip;
  }
  if(port != ""){
    data['Botmaster Port'] = port;
  }

  $.ajax({
    type:"POST",
    beforeSend: function (request)
    {
      request.setRequestHeader("X-CSRFToken", csrftoken);
    },
    url: "/malware_toolkit/api/build/",
    data: JSON.stringify(data),
    success: function(msg) {
      if(msg.startsWith('200')){
        // drop the response code and space and set the download button link
        setDownloadBtnLink(msg.substring(3));
        setDownloadBtnEnabled(true);
        fadeMsg("Build Successful");
      }else{
        setDownloadBtnEnabled(false);
        fadeMsg("Build Failed");
      }
    }
  });
}

function getUsersFeatureSelections(){
  var feature_selections = {};
  var groups = document.getElementsByClassName("toolkit-group");
  var group_name;
  var feature_name;
  // iterate over each group
  for(i = 0; i < groups.length; i++){
    group_name = groups[i].getAttribute("name");
    feature_selections[group_name] = {};
    var forms = groups[i].getElementsByTagName("form");

    // iterate over each form (feature) in this group
    for(j = 0; j < forms.length; j++){
      // each feature could have multiple checkboxes
      // use an array to store the values of the checkboxes that are selected
      feature = [];
      var options = forms[j].getElementsByTagName("input");

      // iterate over each radio button in this form looking for checked ones
      for(k = 0; k < options.length; k++){
        // if one of this featues checkboxes are selected, append its value to the array
        if(options[k].checked){
          feature.push(options[k].value)
        }
      }
      // if any check boxes were selected, add the features to the list
      if(feature.length > 0){
        feature_selections[group_name][forms[j].id] = feature;
      }
    }
  }
  return feature_selections;
}

function setDownloadBtnLink(link){
  // triggers the browser to download the file
  var newval = 'window.location="' + link + '"'
  document.getElementById('download-btn').setAttribute('onclick', newval);
}

function setDownloadBtnEnabled(enabled){
  $('#download-btn').prop('disabled', !enabled);
}

$(document).ready(function(){
  // document.getElementById('function-name').addEventListener('input', setHeader);
  document.getElementById('build-btn').addEventListener('click', sendBuildRequest);
});

</script>
{% endblock %}

{% block banner %}{{ title }}{% endblock %}

{% block body_block %}
  <div id="top-wrapper">

    <li><a href="{% url 'features' %}">Features</a>
    <li><a href="{% url 'functions' %}">Functions</a>

    <div style="clear: both"></div>

    <div id="row-1" class="row">
      <!-- begin column 1 -->
      <div id="row-1-c1" class="col-md-3" style="float: left">
        <h4>{{ type_1 }}</h4>
        <div class="toolkit-group" name="{{ type_1 }}">
          {% for f in features_1 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              &nbsp&nbsp<input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
        <div><br></div>
        <div><br></div>
        <div><br></div>
        <div><br></div>
        <div id="row-2">
          <div id="row-2-c1" style="float: left" class="btn-group">
            <button id="clear-btn" class="btn btn-primary">Clear</button>
            <button id="build-btn" class="btn btn-primary">Build</button>
            <button id="download-btn" class="btn btn-primary" disabled>Download</button>
          </div>
        </div>
      </div>
      <!-- end column 1 -->

      <!-- begin column 2 -->
      <div id="row-1-c2" class="col-md-3" style="float: left">
        <h4>{{ type_5 }}</h4>
        <div class="toolkit-group" name="{{ type_5 }}">
          {% for f in features_5 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              &nbsp&nbsp<input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
        <h4>{{ type_2 }}</h4>
        <div class="toolkit-group" name="{{ type_2 }}">
          {% for f in features_2 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              &nbsp&nbsp<input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
        <!-- <div><br></div> -->
        <div id="botmaster-options-block">
          <div>
            <h4>Botmaster Options:</h4>
            Botmaster IP:<input id="botmaster-ip-text" class="form-control" value="127.0.0.1"></input>
            Botmaster Port:<input id="botmaster-port-text" class="form-control" value="50000"></input>
          </div>
        </div>
      </div>
      <!-- end column 2 -->

      <!-- begin column 3 -->
      <div id="row-1-c3" class="col-md-3" style="float: left">
        <h4>{{ type_3 }}</h4>
        <div class="toolkit-group" name="{{ type_3 }}">
          {% for f in features_3 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              &nbsp&nbsp<input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div>
        <!-- <div id="time-block">
          <div>
            <h4>Only Request Actions at Time:</h4>
            <input type="checkbox" id="time-checkbox" onclick="timeClicked()">Yes</input></br>
            <select multiple size="12" id="trigger-times" disabled>
              <option value="0">12am</option>
              <option value="1">1am</option>
              <option value="2">2am</option>
              <option value="3">3am</option>
              <option value="4">4am</option>
              <option value="5">5am</option>
              <option value="6">6am</option>
              <option value="7">7am</option>
              <option value="8">8am</option>
              <option value="9">9am</option>
              <option value="10">10am</option>
              <option value="11">11am</option>
              <option value="12">12pm</option>
              <option value="13">1pm</option>
              <option value="14">2pm</option>
              <option value="15">3pm</option>
              <option value="16">4pm</option>
              <option value="17">5pm</option>
              <option value="18">6pm</option>
              <option value="19">7pm</option>
              <option value="20">8pm</option>
              <option value="21">9pm</option>
              <option value="22">10pm</option>
              <option value="23">11pm</option>
            </select>
          </div>
          <div>
            <h4>Action Limit per Interval:</h4>
            <input id="action-limit-text" class="form-control" value="3"  disabled></input>
          </div>
        </div> -->
        <!-- close time block -->

        <!-- <div id="frequency-block">
          <div>
            <h4>Action Pull Frequency:</h4>
            <input type="checkbox" id="frequency-checkbox" onclick="frequencyClicked()">Yes</input></br>
            <input id="action-frequency-text" class="form-control" value="1" disabled></input>
          </div>
        </div> -->
        <!-- close frequency block -->
      </div>
      <!-- end column 3 -->

      <!-- begin column 4 -->
      <div id="row-1-c4" class="col-md-3" style="float: left">
        <!-- <h4>{{ type_4 }}</h4> -->
        <!-- <div class="toolkit-group" name="{{ type_4 }}">
          {% for f in features_4 %}
            {{ f.toolkit_prompt }}:</br>
            <form action="" id="{{ f }}">
              {% for o in f.options %}
              &nbsp&nbsp<input type="checkbox" name="{{ f }}" value="{{ o }}">{{ o }}</input><br>
              {% endfor %}
            </form>
          {% endfor %}
        </div> -->
        <div id="time-block">
          <div>
            <h4>Only Request Actions at Time:</h4>
            <input type="checkbox" id="time-checkbox" onclick="timeClicked()">Yes</input></br>
            <select multiple size="9" id="trigger-times" disabled>
              <option value="0">12am</option>
              <option value="1">1am</option>
              <option value="2">2am</option>
              <option value="3">3am</option>
              <option value="4">4am</option>
              <option value="5">5am</option>
              <option value="6">6am</option>
              <option value="7">7am</option>
              <option value="8">8am</option>
              <option value="9">9am</option>
              <option value="10">10am</option>
              <option value="11">11am</option>
              <option value="12">12pm</option>
              <option value="13">1pm</option>
              <option value="14">2pm</option>
              <option value="15">3pm</option>
              <option value="16">4pm</option>
              <option value="17">5pm</option>
              <option value="18">6pm</option>
              <option value="19">7pm</option>
              <option value="20">8pm</option>
              <option value="21">9pm</option>
              <option value="22">10pm</option>
              <option value="23">11pm</option>
            </select>
          </div>
          <div>
            <h4>Action Limit per Interval:</h4>
            <input id="action-limit-text" class="form-control" value="3"  disabled></input>
          </div>
        </div>
        <!-- close time block -->

        <div id="frequency-block">
          <div>
            <h4 style="margin-bottom: 0px; margin-top: 30px">Minutes Between Action Pulls:</h4>
            <input type="checkbox" id="frequency-checkbox" onclick="frequencyClicked()">Yes</input></br>
            <input id="action-frequency-text" class="form-control" value="1" disabled></input>
          </div>
        </div>
        <!-- close frequency block -->

        <div id="max-action-limit-block">
          <div>
            <h4 style="margin-bottom: 0px">Maximum Action Limit:</h4>
            <input type="checkbox" id="max-action-limit-checkbox" onclick="maxLimitClicked()">Yes</input></br>
            <input id="max-action-limit-text" class="form-control" value="10" disabled></input>
          </div>
        </div>
        <!-- close maximum action limit block -->
      </div>
      <!-- end column 4 -->
    </div>
    <div style="clear: both"></div>
    <!-- close row-1 -->

    <!-- <div id="row-2">
      <div id="row-2-c1" style="float: left" class="btn-group">
        <button id="clear-btn" class="btn btn-primary">Clear</button>
        <button id="build-btn" class="btn btn-primary">Build</button>
        <button id="download-btn" class="btn btn-primary" disabled>Download</button>
      </div>
    </div> -->
    <div style="clear: both"></div>
    <!-- close row-2 -->

  </div>
  <!-- close top-wrapper -->
{% endblock %}
